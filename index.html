<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LIFT">
<meta name="theme-color" content="#090909">
<title>LIFT \u2014 Athlete OS</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  var t=localStorage.getItem('lift_theme')||'dark';
  var themes={
    dark:{
      '--bg':'#090909',
      '--bg2':'#0f0f0f',
      '--surface':'rgba(255,255,255,0.04)',
      '--surface2':'rgba(255,255,255,0.07)',
      '--card':'rgba(255,255,255,0.06)',
      '--card2':'rgba(255,255,255,0.09)',
      '--glass':'rgba(15,15,15,0.72)',
      '--glass-border':'rgba(255,255,255,0.10)',
      '--border':'rgba(255,255,255,0.09)',
      '--border2':'rgba(255,255,255,0.16)',
      '--text':'#f2f2f2',
      '--text2':'#c8c8c8',
      '--muted':'rgba(255,255,255,0.35)',
      '--muted2':'rgba(255,255,255,0.55)',
      '--input-bg':'rgba(255,255,255,0.05)',
      '--accent':'#c8ff00',
      '--accent-dim':'rgba(200,255,0,0.12)',
      '--accent-glow':'rgba(200,255,0,0.25)',
      '--accent2':'#ff6b35',
      '--push':'#4f8cff',
      '--pull':'#22d88f',
      '--full':'#ffbe00',
      '--diet':'#bf7fff',
      '--weight':'#ff6b8a',
      '--exlog':'#3de8a0',
      '--blue':'#5ab4ff',
      '--danger':'#ff4d4d',
      '--tab-bg':'rgba(12,12,12,0.88)'
    },
    light:{
      '--bg':'#f5f5f7',
      '--bg2':'#ebebed',
      '--surface':'rgba(255,255,255,0.70)',
      '--surface2':'rgba(255,255,255,0.88)',
      '--card':'rgba(255,255,255,0.80)',
      '--card2':'rgba(255,255,255,0.95)',
      '--glass':'rgba(245,245,247,0.80)',
      '--glass-border':'rgba(0,0,0,0.08)',
      '--border':'rgba(0,0,0,0.08)',
      '--border2':'rgba(0,0,0,0.15)',
      '--text':'#0d0d0d',
      '--text2':'#2a2a2a',
      '--muted':'rgba(0,0,0,0.38)',
      '--muted2':'rgba(0,0,0,0.58)',
      '--input-bg':'rgba(0,0,0,0.04)',
      '--accent':'#6ab000',
      '--accent-dim':'rgba(106,176,0,0.10)',
      '--accent-glow':'rgba(106,176,0,0.20)',
      '--accent2':'#e0501a',
      '--push':'#2563eb',
      '--pull':'#059669',
      '--full':'#d97706',
      '--diet':'#9333ea',
      '--weight':'#e11d48',
      '--exlog':'#059669',
      '--blue':'#2563eb',
      '--danger':'#dc2626',
      '--tab-bg':'rgba(245,245,247,0.90)'
    }
  };
  var resolved = t;
  if(t === 'auto') resolved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  var vars=themes[resolved]||themes.dark;
  var root=document.documentElement;
  Object.keys(vars).forEach(function(k){root.style.setProperty(k,vars[k]);});
  root.style.backgroundColor=vars['--bg'];
})();
</script>
<style>
:root{
  --accent:#c8ff00;--accent-dim:rgba(200,255,0,.12);--accent-glow:rgba(200,255,0,.25);
  --accent2:#ff6b35;--push:#4f8cff;--pull:#22d88f;--full:#ffbe00;
  --diet:#bf7fff;--weight:#ff6b8a;--exlog:#3de8a0;--blue:#5ab4ff;--danger:#ff4d4d;
  /* Dark defaults — JS overrides on load */
  --bg:#090909;--bg2:#0f0f0f;
  --surface:rgba(255,255,255,.04);--surface2:rgba(255,255,255,.07);
  --card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.09);
  --glass:rgba(15,15,15,.72);--glass-border:rgba(255,255,255,.10);
  --border:rgba(255,255,255,.09);--border2:rgba(255,255,255,.16);
  --text:#f2f2f2;--text2:#c8c8c8;
  --muted:rgba(255,255,255,.35);--muted2:rgba(255,255,255,.55);
  --input-bg:rgba(255,255,255,.05);
  --tab-bg:rgba(12,12,12,.88);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --safe-top:env(safe-area-inset-top,0px);
  --tab-h:64px;
  --radius:16px;--radius-sm:12px;--radius-xs:9px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
/* ══════════════════════════════════════════
   LIFT v3.2  ·  iOS Glass Design System
   Mobile-first · Dark + Light mode
══════════════════════════════════════════ */

/* ── BASE ── */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}

body{
  background:var(--bg);
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  min-height:100vh;
  overflow-x:hidden;
  padding-bottom:calc(var(--tab-h) + var(--safe-bottom) + 8px);
  /* Subtle mesh gradient background */
  background-image:
    radial-gradient(ellipse 80% 50% at 20% -10%,rgba(200,255,0,.06) 0%,transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%,rgba(79,140,255,.05) 0%,transparent 60%);
  background-attachment:fixed;
}

/* Light mode bg override */
html[style*="--bg:#f5f5f7"] body,
body.theme-light{
  background-image:
    radial-gradient(ellipse 80% 50% at 20% -10%,rgba(106,176,0,.06) 0%,transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%,rgba(37,99,235,.04) 0%,transparent 60%);
}

main{padding:12px 14px 0;}

/* ── GLASS MIXIN UTILITY ── */
.glass{
  background:var(--card);
  backdrop-filter:blur(20px) saturate(1.5);
  -webkit-backdrop-filter:blur(20px) saturate(1.5);
  border:1px solid var(--glass-border);
}

/* ── BOTTOM TAB BAR ── */
.nav{
  position:fixed;bottom:0;left:0;right:0;
  height:calc(var(--tab-h) + var(--safe-bottom));
  padding-bottom:var(--safe-bottom);
  background:var(--tab-bg);
  backdrop-filter:blur(40px) saturate(1.8);
  -webkit-backdrop-filter:blur(40px) saturate(1.8);
  border-top:0.5px solid var(--glass-border);
  display:flex;align-items:flex-start;justify-content:space-around;
  padding-top:8px;z-index:500;
  /* subtle top glow line */
  box-shadow:0 -1px 0 var(--glass-border), inset 0 1px 0 rgba(255,255,255,.04);
}

.nb{
  flex:1;
  display:flex;flex-direction:column;align-items:center;gap:2px;
  background:none;border:none;
  font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;
  color:var(--muted);cursor:pointer;padding:0 2px;
  transition:color .2s cubic-bezier(.4,0,.2,1);
  letter-spacing:.2px;max-width:72px;
  position:relative;
}
.nb .tab-icon{
  font-size:22px;line-height:1;display:block;margin-bottom:2px;
  transition:transform .25s cubic-bezier(.34,1.56,.64,1);
}
.nb.active{color:var(--accent);}
.nb.active .tab-icon{transform:scale(1.12) translateY(-1px);}
/* Active indicator dot */
.nb.active::after{
  content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 6px var(--accent-glow);
}

/* Desktop sidebar */
.nav-logo{display:none;}

/* ── HEADER ── */
header{
  padding:calc(var(--safe-top) + 14px) 16px 12px;
  display:flex;justify-content:space-between;align-items:center;
  background:var(--glass);
  backdrop-filter:blur(40px) saturate(1.8);
  -webkit-backdrop-filter:blur(40px) saturate(1.8);
  position:sticky;top:0;z-index:400;
  border-bottom:0.5px solid var(--glass-border);
}

.logo{
  font-family:'Bebas Neue',sans-serif;
  font-size:28px;line-height:1;letter-spacing:4px;
  color:var(--accent);
  /* Lime glow */
  text-shadow:0 0 20px var(--accent-glow);
  position:relative;
}
.logo::after{
  content:'LIFT';position:absolute;top:0;left:0;
  filter:blur(8px);opacity:.3;color:var(--accent);
  z-index:-1;
}
.logo span{display:none;}

.header-right{display:flex;align-items:center;gap:8px;}
.week-badge{
  background:var(--surface2);
  border:0.5px solid var(--glass-border);
  border-radius:10px;padding:4px 10px;text-align:right;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
}
.week-badge .wn{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--text);line-height:1;}
.week-badge .wl{font-size:8.5px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;}
.user-avatar{
  width:34px;height:34px;border-radius:50%;
  background:var(--accent-dim);
  border:1.5px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;
  font-family:'Bebas Neue',sans-serif;
  box-shadow:0 0 12px var(--accent-glow);
  transition:box-shadow .2s;
}
.user-avatar:hover{box-shadow:0 0 20px var(--accent-glow);}

/* ── CARDS — Glass morphism ── */
.card{
  background:var(--card);
  backdrop-filter:blur(20px) saturate(1.4);
  -webkit-backdrop-filter:blur(20px) saturate(1.4);
  border:0.5px solid var(--glass-border);
  border-radius:var(--radius);
  padding:16px;margin-bottom:10px;
  transition:border-color .2s,transform .15s;
  position:relative;overflow:hidden;
}
/* Card inner shimmer */
.card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);
  pointer-events:none;
}

/* ── SECTION LABELS ── */
.section-label{
  font-size:9px;letter-spacing:3.5px;text-transform:uppercase;
  color:var(--muted);margin:20px 0 8px;padding-left:2px;
  font-weight:600;
}

/* ── INSIGHT CARD — glass with colour tint ── */
.insight-card{
  border-radius:var(--radius);padding:16px;margin-bottom:0;
  position:relative;overflow:hidden;
  backdrop-filter:blur(20px) saturate(1.5);
  -webkit-backdrop-filter:blur(20px) saturate(1.5);
  border:0.5px solid transparent;
  transition:all .3s ease;
}
.insight-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2.5px;border-radius:var(--radius) var(--radius) 0 0;}
.insight-card::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);}
.insight-fresh{
  background:linear-gradient(135deg,rgba(34,216,143,.10) 0%,rgba(200,255,0,.06) 100%);
  border-color:rgba(34,216,143,.25);
}
.insight-fresh::before{background:linear-gradient(90deg,#22d88f,#c8ff00);}
.insight-neutral{
  background:linear-gradient(135deg,rgba(255,190,0,.10) 0%,rgba(255,107,53,.06) 100%);
  border-color:rgba(255,190,0,.25);
}
.insight-neutral::before{background:linear-gradient(90deg,#ffbe00,#ff6b35);}
.insight-fatigued{
  background:linear-gradient(135deg,rgba(255,77,77,.12) 0%,rgba(255,107,53,.06) 100%);
  border-color:rgba(255,77,77,.25);
}
.insight-fatigued::before{background:linear-gradient(90deg,#ff4d4d,#ff6b35);}
.insight-nodata{background:var(--card);border-color:var(--glass-border);}
.insight-nodata::before{background:var(--border2);}
.insight-fresh .ic-status{color:#22d88f;}
.insight-neutral .ic-status{color:#ffbe00;}
.insight-fatigued .ic-status{color:#ff4d4d;}
.insight-nodata .ic-status{color:var(--muted);}
.ic-row{display:flex;align-items:flex-start;gap:12px;}
.ic-emoji{font-size:30px;flex-shrink:0;line-height:1;margin-top:2px;}
.ic-body{flex:1;}
.ic-status{font-size:9px;letter-spacing:3px;text-transform:uppercase;font-weight:700;margin-bottom:4px;}
.ic-headline{font-family:'Bebas Neue',sans-serif;font-size:21px;letter-spacing:.8px;line-height:1.1;margin-bottom:5px;color:var(--text);}
.ic-detail{font-size:11.5px;color:var(--muted2);line-height:1.55;}
.ic-metrics{display:flex;gap:0;margin-top:12px;padding-top:10px;border-top:0.5px solid var(--glass-border);}
.ic-metric{flex:1;text-align:center;padding:0 4px;}
.ic-metric+.ic-metric{border-left:0.5px solid var(--glass-border);}
.ic-metric-val{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;}
.ic-metric-lbl{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.ic-rec{
  margin-top:10px;padding:11px 13px;
  background:rgba(255,255,255,.04);
  border-radius:var(--radius-sm);
  border:0.5px solid var(--glass-border);
}
.ic-rec-label{font-size:8.5px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;font-weight:600;}
.ic-rec-text{font-size:12px;color:var(--text2);line-height:1.45;}
.trend-pill{
  display:inline-flex;align-items:center;gap:3px;
  background:rgba(255,255,255,.06);border-radius:100px;
  padding:3px 8px;font-size:9px;font-weight:600;letter-spacing:.5px;margin-top:5px;
  border:0.5px solid var(--glass-border);
}

/* ── TODAY CARD ── */
.dash-today-inner{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.dash-sport-big{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:1px;color:var(--accent);line-height:1;}
.dash-date-label{font-size:8.5px;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.dash-net-big{font-family:'Bebas Neue',sans-serif;font-size:30px;line-height:1;}
.dash-quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.dash-quick-stat{
  background:var(--surface);
  border:0.5px solid var(--glass-border);
  border-radius:var(--radius-sm);
  padding:9px 5px;text-align:center;cursor:pointer;
  transition:all .2s;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
}
.dash-quick-stat:hover{background:var(--surface2);transform:translateY(-1px);}
.dqs-val{font-family:'Bebas Neue',sans-serif;font-size:20px;line-height:1;}
.dqs-lbl{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:2px;}

/* ── STAT BOXES ── */
.stat-box{
  background:var(--card);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:0.5px solid var(--glass-border);
  border-radius:var(--radius-sm);padding:13px;cursor:pointer;transition:all .2s;
}
.stat-box:hover{border-color:var(--border2);transform:translateY(-1px);}
.stat-box .stl{font-size:8.5px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;font-weight:600;}
.stat-box .stv{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1;}
.stat-box .sts{font-size:10px;color:var(--muted);margin-top:3px;}
.stat-box.diet-stat .stv{color:var(--diet);}
.stat-box.weight-stat .stv{color:var(--weight);}
.stat-box.ex-stat .stv{color:var(--exlog);}

/* ── WATER CARD ── */
.water-card{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:0.5px solid var(--glass-border);border-radius:var(--radius);padding:14px;margin-bottom:10px;}
.water-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.water-title{font-size:13px;font-weight:500;}
.water-count{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--blue);}
.water-glasses{display:flex;gap:5px;flex-wrap:wrap;}
.glass-btn{
  width:34px;height:34px;border-radius:9px;
  border:0.5px solid var(--glass-border);background:var(--surface);
  cursor:pointer;font-size:17px;transition:all .2s;
  display:flex;align-items:center;justify-content:center;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
}
.glass-btn.filled{background:rgba(90,180,255,.15);border-color:var(--blue);box-shadow:0 0 8px rgba(90,180,255,.2);}

/* ── BUTTONS ── */
.btn{
  background:var(--surface);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border:0.5px solid var(--glass-border);
  border-radius:var(--radius-xs);padding:10px 16px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;
  color:var(--text);cursor:pointer;transition:all .2s;
}
.btn:hover{background:var(--surface2);border-color:var(--border2);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn:active{transform:scale(.98);}
.btn-primary{
  background:var(--accent);border-color:var(--accent);color:#0d0d0d;
  box-shadow:0 4px 16px var(--accent-glow);font-weight:600;
}
.btn-primary:hover{box-shadow:0 6px 24px var(--accent-glow);transform:translateY(-1px);}
.btn-diet{background:var(--diet);border-color:var(--diet);color:white;box-shadow:0 4px 14px rgba(191,127,255,.25);}
.btn-weight{background:var(--weight);border-color:var(--weight);color:white;}
.btn-ex{background:var(--exlog);border-color:var(--exlog);color:#0d0d0d;}
.btn-block{display:block;width:100%;text-align:center;}

/* ── MEAL LOG ── */
.meal-log-item{
  background:var(--surface);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);
  padding:11px 13px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px;
}
.mli-left{flex:1;}.mli-name{font-size:13px;font-weight:500;margin-bottom:2px;line-height:1.3;}.mli-meta{font-size:10px;color:var(--muted);}
.mli-right{text-align:right;flex-shrink:0;}.mli-cals{font-family:'Bebas Neue',sans-serif;font-size:21px;color:var(--diet);line-height:1;}.mli-unit{font-size:9px;color:var(--muted);}

/* ── FOOD INPUT ── */
.food-input-card{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:0.5px solid var(--glass-border);border-radius:var(--radius);padding:16px;margin-bottom:10px;}
.fi-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--diet);margin-bottom:2px;}
.fi-sub{font-size:11px;color:var(--muted);margin-bottom:12px;font-style:italic;}

/* ── SETTINGS ── */
.settings-section{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:0.5px solid var(--glass-border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-top:0.5px solid var(--glass-border);gap:12px;}
.settings-row:first-of-type{border-top:none;}
.sr-label{font-size:14px;font-weight:500;margin-bottom:2px;}
.sr-sub{font-size:11px;color:var(--muted);}

/* ── DATE NAV ── */
.date-nav{
  display:flex;align-items:center;gap:5px;margin-bottom:12px;
  background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);padding:7px 9px;
}
.dn-arrow{
  background:var(--surface);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  border:0.5px solid var(--glass-border);border-radius:8px;
  padding:5px 11px;font-size:15px;color:var(--muted);cursor:pointer;transition:all .15s;flex-shrink:0;
}
.dn-arrow:hover{border-color:var(--border2);color:var(--text);}
.dn-arrow:disabled{opacity:.3;cursor:default;}
.dn-label{flex:1;text-align:center;font-size:12px;font-weight:500;color:var(--text);}
.dn-windows{display:flex;gap:3px;flex-shrink:0;}
.dnw-btn{
  background:var(--surface);border:0.5px solid var(--glass-border);
  border-radius:7px;padding:4px 8px;font-size:9.5px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;
}
.dnw-btn.active{background:var(--accent);border-color:var(--accent);color:#0d0d0d;font-weight:600;}

/* ── SPORT/DIET TABS ── */
.sport-tabs,.tabs{display:flex;gap:5px;margin-bottom:12px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.sport-tabs::-webkit-scrollbar,.tabs::-webkit-scrollbar{display:none;}
.sport-tab{
  flex-shrink:0;
  background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:0.5px solid var(--glass-border);border-radius:100px;
  padding:7px 15px;font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s;
}
.sport-tab.active{background:var(--accent);border-color:var(--accent);color:#0d0d0d;font-weight:600;}
.tabs{background:var(--surface);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);padding:4px;}
.tab{flex:1;background:none;border:none;border-radius:9px;padding:7px 4px;font-size:10px;font-weight:500;color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;}
.tab.active{background:var(--card);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.12);}

/* ── CALORIE GOAL BAR ── */
.calorie-goal-bar{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:0.5px solid var(--glass-border);border-radius:var(--radius);padding:14px;margin-bottom:10px;}
.cg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.cg-title{font-size:12px;font-weight:500;}
.cg-input{background:var(--input-bg);border:0.5px solid var(--glass-border);border-radius:7px;padding:3px 8px;font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--diet);width:68px;text-align:center;}
.goalbar{height:5px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;}
.goalbar-fill{height:100%;background:var(--diet);border-radius:4px;transition:width .4s ease;max-width:100%;box-shadow:0 0 8px rgba(191,127,255,.3);}
.goalbar-fill.over{background:var(--accent2);}
.goalbar-labels{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--muted);}

/* ── EXERCISE CARDS ── */
.ex-card{
  background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);
  padding:12px;margin-bottom:7px;transition:all .2s;position:relative;overflow:hidden;
}
.ex-card.done{opacity:.3;border-color:transparent;}
.ex-card:hover:not(.done){border-color:var(--border2);transform:translateY(-1px);}
.ex-card-top{display:flex;align-items:center;gap:10px;cursor:pointer;}
.ex-chk{width:24px;height:24px;border-radius:50%;border:1.5px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:11px;}
.ex-card.done .ex-chk{background:var(--accent);border-color:var(--accent);color:#0d0d0d;box-shadow:0 0 8px var(--accent-glow);}
.ex-info{flex:1;}.ex-name{font-size:13px;font-weight:500;margin-bottom:2px;}.ex-detail{font-size:11px;color:var(--muted);}.ex-rest{font-size:10px;color:var(--muted);text-align:right;flex-shrink:0;}
.ex-log-list-item,.activity-item{background:var(--surface);border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}

/* ── STREAKS ── */
.streaks-row{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:12px;}
.streak-box{
  background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);
  padding:12px;text-align:center;transition:all .2s;
}
.streak-box.active{border-color:var(--accent);background:var(--accent-dim);box-shadow:0 0 16px var(--accent-glow);}
.streak-icon{font-size:20px;margin-bottom:4px;}
.streak-val{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;color:var(--accent);}
.streak-val.zero{color:var(--muted);}
.streak-lbl{font-size:8.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.vol-box{background:var(--card);border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 7px;text-align:center;cursor:pointer;transition:all .2s;}
.vol-box:hover{border-color:var(--border2);transform:translateY(-1px);}
.vol-box .vb-icon{font-size:19px;margin-bottom:3px;}
.vol-box .vb-val{font-family:'Bebas Neue',sans-serif;font-size:20px;line-height:1;}
.vol-box .vb-lbl{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.achievement-card{background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:0.5px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 14px;display:flex;align-items:center;gap:12px;transition:all .2s;margin-bottom:7px;}
.achievement-card.earned{border-color:var(--accent);background:var(--accent-dim);box-shadow:0 0 12px var(--accent-glow);}
.achievement-card.locked{opacity:.4;}
.chart-card{background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:0.5px solid var(--glass-border);border-radius:var(--radius);padding:16px;margin-bottom:10px;}

/* ── FAV CHIPS ── */
.fav-section{margin-bottom:12px;}
.fav-grid{display:flex;gap:6px;flex-wrap:wrap;}
.fav-chip{
  display:flex;align-items:center;gap:6px;
  background:var(--surface);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border:0.5px solid var(--glass-border);border-radius:100px;
  padding:6px 12px 6px 10px;cursor:pointer;transition:all .2s;font-size:12px;
}
.fav-chip:hover{border-color:var(--diet);box-shadow:0 0 10px rgba(191,127,255,.2);transform:translateY(-1px);}
.fc-cals{font-size:10px;color:var(--diet);font-weight:600;}
.fc-del{font-size:12px;color:var(--muted);margin-left:2px;}
.fav-btn{
  background:rgba(191,127,255,.1);border:0.5px solid rgba(191,127,255,.3);
  color:var(--diet);border-radius:8px;padding:8px 14px;
  font-size:12px;font-weight:500;cursor:pointer;transition:all .2s;
}
.fav-btn:hover{background:rgba(191,127,255,.2);box-shadow:0 0 12px rgba(191,127,255,.2);}

/* ── INPUTS ── */
input,select,textarea{
  background:var(--input-bg);
  border:0.5px solid var(--glass-border);
  border-radius:var(--radius-xs);
  padding:10px 12px;color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:13px;
  transition:border-color .2s,box-shadow .2s;
  outline:none;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-dim);
}

/* ── TOASTS ── */
.water-toast,.achievement-toast{
  backdrop-filter:blur(20px) saturate(1.5);
  -webkit-backdrop-filter:blur(20px) saturate(1.5);
  border:0.5px solid var(--glass-border);
}

/* ── SCROLLBAR ── */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ══════════════════════════════
   DESKTOP — Sidebar layout
══════════════════════════════ */
@media(min-width:768px){
  body{padding-bottom:0;padding-left:220px;}
  .nav{
    position:fixed;top:0;left:0;bottom:0;
    width:220px;height:100vh;
    flex-direction:column;align-items:flex-start;justify-content:flex-start;
    padding:0 10px 20px;
    border-top:none;border-right:0.5px solid var(--glass-border);border-bottom:none;
    gap:2px;overflow-y:auto;
    /* Remove bottom tab styles */
    box-shadow:none;
  }
  .nav::before{display:none;}
  .nb{
    flex:none;flex-direction:row;width:100%;max-width:100%;
    padding:10px 12px;border-radius:var(--radius-sm);
    justify-content:flex-start;font-size:13px;gap:10px;
  }
  .nb .tab-icon{font-size:18px;margin-bottom:0;}
  .nb.active{background:var(--accent-dim);}
  .nb.active::after{display:none;}
  .nb:hover:not(.active){background:var(--surface);}
  .nav-logo{
    display:block !important;
    font-family:'Bebas Neue',sans-serif;font-size:30px;
    color:var(--accent);letter-spacing:4px;
    padding:20px 12px 16px;width:100%;
    text-shadow:0 0 20px var(--accent-glow);
  }
  header{padding:12px 22px;left:220px;}
  main{padding:14px 22px;}
}

/* AUTH */
#authScreen{
  position:fixed;inset:0;
  background:var(--bg);
  z-index:1000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 24px;overflow-y:auto;
  transition:background .3s;
  /* Mesh gradient backdrop */
  background-image:
    radial-gradient(ellipse 70% 50% at 30% 0%,rgba(200,255,0,.08) 0%,transparent 60%),
    radial-gradient(ellipse 50% 40% at 70% 100%,rgba(79,140,255,.06) 0%,transparent 60%);
}
header,nav,.sync-bar,main{visibility:hidden;}
body.authed header,body.authed nav,body.authed .sync-bar,body.authed main{visibility:visible;}
#authScreen.hidden{display:none;}

.auth-logo{
  font-family:'Bebas Neue',sans-serif;font-size:80px;
  color:var(--accent);letter-spacing:5px;line-height:1;margin-bottom:6px;
  text-shadow:0 0 30px var(--accent-glow);
}
.auth-sub{font-size:10px;letter-spacing:5px;color:var(--muted);text-transform:uppercase;margin-bottom:44px;font-weight:500;}

/* Auth card — solid glass, clearly readable */
.auth-card{
  /* Solid enough backgrounds that work with glass vars */
  background:var(--auth-card-bg, rgba(28,28,30,0.95));
  border:0.5px solid var(--glass-border);
  border-radius:22px;
  padding:28px 24px;
  width:100%;max-width:380px;
  backdrop-filter:blur(40px) saturate(1.5);
  -webkit-backdrop-filter:blur(40px) saturate(1.5);
  box-shadow:0 24px 64px rgba(0,0,0,.5), 0 0 0 0.5px var(--glass-border);
}

.auth-title{
  font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1.5px;
  margin-bottom:22px;color:var(--accent);
}
.auth-field{margin-bottom:14px;}
.auth-field label{
  font-size:10px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--muted2);display:block;margin-bottom:6px;font-weight:600;
}

/* Auth inputs — explicit solid bg, no glass tricks */
.auth-field input{
  width:100%;
  background:rgba(255,255,255,0.07) !important;
  border:0.5px solid rgba(255,255,255,0.14) !important;
  border-radius:12px !important;
  padding:14px 15px !important;
  font-family:'DM Sans',sans-serif !important;
  font-size:15px !important;
  color:var(--text) !important;
  outline:none !important;
  transition:border-color .2s,box-shadow .2s !important;
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
  -webkit-appearance:none;
  box-sizing:border-box;
}
.auth-field input:focus{
  border-color:var(--accent) !important;
  box-shadow:0 0 0 3px var(--accent-dim) !important;
  background:rgba(255,255,255,0.10) !important;
}
.auth-field input::placeholder{color:rgba(255,255,255,0.28) !important;}

.auth-btn{
  width:100%;background:var(--accent);border:none;border-radius:12px;
  padding:15px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;
  color:#0d0d0d;cursor:pointer;margin-top:6px;
  transition:all .2s;
  box-shadow:0 4px 20px var(--accent-glow);
}
.auth-btn:hover{transform:translateY(-1px);box-shadow:0 6px 28px var(--accent-glow);}
.auth-btn:active{transform:scale(.98);}
.auth-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none;}

.auth-switch{text-align:center;margin-top:18px;font-size:12px;color:var(--muted);}
.auth-switch span{color:var(--accent);cursor:pointer;font-weight:600;}

/* Auth error — use semantic colors, not hardcoded dark values */
.auth-error{
  background:rgba(239,68,68,0.12);
  border:0.5px solid rgba(239,68,68,0.35);
  border-radius:10px;padding:11px 13px;
  font-size:12px;color:#ff6b6b;
  margin-bottom:14px;display:none;
  line-height:1.5;
}
.auth-error.show{display:block;}

/* Light mode auth card */
@media (prefers-color-scheme: light) {
  .auth-card{background:rgba(255,255,255,0.92) !important;box-shadow:0 20px 60px rgba(0,0,0,.15);}
  .auth-field input{background:rgba(0,0,0,0.04) !important;border-color:rgba(0,0,0,0.12) !important;color:#0d0d0d !important;}
  .auth-field input::placeholder{color:rgba(0,0,0,0.3) !important;}
}
/* JS-set light theme auth card override */
html[style*="--bg:#f5f5f7"] .auth-card,
html[style*="--bg: #f5f5f7"] .auth-card{
  background:rgba(255,255,255,0.92) !important;
  box-shadow:0 20px 60px rgba(0,0,0,.12);
}
html[style*="--bg:#f5f5f7"] .auth-field input,
html[style*="--bg: #f5f5f7"] .auth-field input{
  background:rgba(0,0,0,0.05) !important;
  border-color:rgba(0,0,0,0.12) !important;
  color:#0d0d0d !important;
}
.auth-spinner{display:none;align-items:center;justify-content:center;gap:8px;padding:10px;font-size:12px;color:var(--muted2);}
.auth-spinner.show{display:flex;}

/* INSTALL BANNER */
#installBanner{background:linear-gradient(135deg,#1a2a0a,#0e1a08);border-bottom:1px solid #2d5a1b;padding:10px 16px;display:none;align-items:center;gap:10px;position:sticky;top:0;z-index:100;}
#installBanner.show{display:flex;}
.ib-text{flex:1;font-size:11px;color:#8bc34a;line-height:1.3;}
.ib-text strong{display:block;font-size:12px;color:#aee571;}
.ib-btn{background:var(--accent);border:none;border-radius:6px;padding:7px 14px;font-size:11px;font-weight:500;color:#0e0e0e;cursor:pointer;flex-shrink:0;}
.ib-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;flex-shrink:0;}

/* HEADER */
header{padding:22px 18px 0;display:flex;justify-content:space-between;align-items:flex-start;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:40px;line-height:.9;letter-spacing:2px;color:var(--accent);}
.logo span{display:block;font-size:10px;font-family:'DM Sans',sans-serif;font-weight:300;letter-spacing:4px;color:var(--muted2);text-transform:uppercase;margin-top:2px;}
.header-right{display:flex;align-items:center;gap:8px;}
.week-badge{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:6px 12px;text-align:right;}
.week-badge .wn{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent);line-height:1;}
.week-badge .wl{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;}
.user-menu{position:relative;}
.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:500;color:var(--accent);cursor:pointer;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;}
.user-dropdown{position:absolute;right:0;top:44px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:180px;z-index:200;display:none;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.user-dropdown.show{display:block;}
.ud-email{font-size:10px;color:var(--muted2);padding:6px 10px;border-bottom:1px solid var(--border);margin-bottom:4px;word-break:break-all;}
.ud-item{padding:9px 10px;font-size:12px;cursor:pointer;border-radius:8px;transition:background .15s;display:flex;align-items:center;gap:8px;}
.ud-item:hover{background:var(--surface);}.ud-item.danger{color:var(--danger);}

/* NAV */
.nav{display:flex;gap:5px;padding:16px 18px 0;overflow-x:auto;scrollbar-width:none;}
.nav::-webkit-scrollbar{display:none;}
.nb{flex-shrink:0;background:var(--card);border:1px solid var(--border);border-radius:100px;padding:6px 14px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s;letter-spacing:.5px;}
.nb.active{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
.nb:hover:not(.active){border-color:var(--border2);color:var(--text);}

/* SYNC */
.sync-bar{display:flex;align-items:center;gap:6px;padding:8px 18px;font-size:10px;color:var(--muted);}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--pull);flex-shrink:0;}
.sync-dot.syncing{background:var(--full);animation:pulse 1s infinite;}
.sync-dot.error{background:var(--danger);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

main{padding:16px 18px;}
.view{display:none;}.view.active{display:block;}

/* SHARED */
.section-label{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px;padding-left:2px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:10px;}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:1px;margin-bottom:10px;}
.btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 18px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:var(--text);cursor:pointer;transition:all .15s;}
.btn:hover{border-color:var(--border2);}.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}.btn-primary:hover{opacity:.85;}
.btn-diet{background:var(--diet);border-color:var(--diet);color:white;}
.btn-weight{background:var(--weight);border-color:var(--weight);color:white;}
.btn-ex{background:var(--exlog);border-color:var(--exlog);color:#0e0e0e;}
.btn-block{display:block;width:100%;text-align:center;}
input,select,textarea{background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .15s,background .2s;width:100%;}
input:focus,textarea:focus{border-color:var(--accent);}
textarea{resize:none;}
.pill{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:3px 10px;font-size:9px;letter-spacing:1px;color:var(--muted);text-transform:uppercase;display:inline-block;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.del-btn{background:none;border:none;color:var(--border2);cursor:pointer;font-size:15px;padding:2px 6px;transition:color .15s;line-height:1;flex-shrink:0;}
.del-btn:hover{color:#888;}
.spinner{width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--diet);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
.spinner-ex{border-top-color:var(--exlog);}.spinner-auth{border-top-color:var(--accent);width:16px;height:16px;}
@keyframes spin{to{transform:rotate(360deg);}}
.thinking{display:none;align-items:center;gap:8px;padding:8px 0;font-size:12px;color:var(--muted);font-style:italic;}
.thinking.show{display:flex;}
.progress-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* OVERVIEW */
.rotation-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.rc{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.rc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.rc.push::before{background:var(--push);}.rc.pull::before{background:var(--pull);}.rc.full::before{background:var(--full);}
.rc:hover{border-color:var(--border2);transform:translateY(-2px);}
.rc .sl{font-family:'Bebas Neue',sans-serif;font-size:30px;line-height:1;margin-bottom:2px;}
.rc.push .sl{color:var(--push);}.rc.pull .sl{color:var(--pull);}.rc.full .sl{color:var(--full);}
.rc .sn{font-size:9px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.rc .sf{font-size:10px;color:var(--muted2);font-style:italic;}
.week-sched{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:16px;}
.sd{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;}
.sd .dn{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:4px;}
.sd .ds{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;}
.sd.push .ds{color:var(--push);}.sd.pull .ds{color:var(--pull);}.sd.full .ds{color:var(--full);}
.ov-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px;cursor:pointer;transition:border-color .15s;}
.stat-box:hover{border-color:var(--border2);}
.stat-box .stl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.stat-box .stv{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1;}
.stat-box .sts{font-size:10px;color:var(--muted);margin-top:2px;}
.stat-box.diet-stat .stv{color:var(--diet);}.stat-box.weight-stat .stv{color:var(--weight);}.stat-box.ex-stat .stv{color:var(--exlog);}
.health-banner{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #2a2a5e;border-radius:12px;padding:13px;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.health-icon{font-size:22px;flex-shrink:0;}
.health-text .ht-title{font-size:12px;font-weight:500;color:#818cf8;margin-bottom:2px;}
.health-text .ht-sub{font-size:11px;color:var(--muted);line-height:1.4;}

/* SESSIONS */
.sesh-header{margin-bottom:13px;padding:15px;background:var(--card);border:1px solid var(--border);border-radius:16px;position:relative;overflow:hidden;}
.sesh-header::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.push-view .sesh-header::before{background:var(--push);}.pull-view .sesh-header::before{background:var(--pull);}.full-view .sesh-header::before{background:var(--full);}
.sesh-title{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:.9;letter-spacing:2px;}
.push-view .sesh-title{color:var(--push);}.pull-view .sesh-title{color:var(--pull);}.full-view .sesh-title{color:var(--full);}
.sesh-sub{font-size:11px;color:var(--muted2);margin-top:3px;font-weight:300;margin-bottom:8px;}
.sesh-meta{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.timer-section{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:15px;margin-bottom:12px;text-align:center;}
.timer-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.timer-display{font-family:'Bebas Neue',sans-serif;font-size:54px;letter-spacing:4px;color:var(--accent);line-height:1;margin-bottom:8px;}
.timer-controls{display:flex;gap:7px;justify-content:center;}
.phase-label{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin:14px 0 6px;padding-left:2px;}
.ex-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s;}
.ex-card.done{opacity:.35;border-color:transparent;}.ex-card:hover:not(.done){border-color:var(--border2);}
.ex-chk{width:23px;height:23px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:11px;}
.ex-card.done .ex-chk{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
.ex-info{flex:1;}.ex-name{font-size:13px;font-weight:500;margin-bottom:2px;}.ex-detail{font-size:11px;color:var(--muted);font-weight:300;}
.ex-rest{font-size:10px;color:var(--muted);text-align:right;flex-shrink:0;}
.stretch-section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:6px;}
.stretch-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--accent2);margin-bottom:8px;}
.stretch-item{display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.stretch-item:last-child{border-bottom:none;}
.str-chk{width:16px;height:16px;border-radius:50%;border:1.5px solid var(--border);flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .15s;}
.stretch-item.done .str-chk{background:var(--accent2);border-color:var(--accent2);color:white;}
.stretch-item.done .str-name{text-decoration:line-through;color:var(--muted);}
.str-name{font-size:12px;font-weight:500;margin-bottom:1px;}.str-desc{font-size:10px;color:var(--muted);}
.complete-banner{display:none;background:linear-gradient(135deg,#1a2a0a,#0e1f0e);border:1px solid #2d5a1b;border-radius:12px;padding:15px;text-align:center;margin-top:12px;}
.complete-banner.show{display:block;animation:fadeIn .5s ease;}
.cb-emoji{font-size:26px;margin-bottom:4px;}.cb-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--accent);margin-bottom:2px;}.cb-text{font-size:11px;color:#6b9b4e;}
.reset-btn{display:block;width:100%;margin-top:8px;background:transparent;border:1px solid var(--border);border-radius:8px;padding:9px;font-family:'DM Sans',sans-serif;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all .15s;}
.reset-btn:hover{border-color:var(--border2);color:var(--text);}

/* DIET */
.ds-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;margin-bottom:10px;}
.ds-box .dsv{font-family:'Bebas Neue',sans-serif;font-size:25px;line-height:1;}
.cal-box .dsv{color:var(--diet);}.pro-box .dsv{color:var(--full);}.wat-box .dsv{color:var(--blue);}
.ds-box .dsl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.calorie-goal-bar{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px;margin-bottom:10px;}
.cg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.cg-title{font-size:11px;font-weight:500;}
.cg-edit{display:flex;align-items:center;gap:5px;}
.cg-input{background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--diet);width:68px;text-align:center;}
.cg-label{font-size:10px;color:var(--muted);}
.goalbar{height:6px;background:var(--border);border-radius:4px;overflow:hidden;}
.goalbar-fill{height:100%;background:var(--diet);border-radius:4px;transition:width .4s ease;max-width:100%;}
.goalbar-fill.over{background:var(--accent2);}
.goalbar-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--muted);}
.water-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px;margin-bottom:10px;}
.water-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:9px;}
.water-title{font-size:12px;font-weight:500;}.water-count{font-family:'Bebas Neue',sans-serif;font-size:21px;color:var(--blue);}
.water-glasses{display:flex;gap:5px;flex-wrap:wrap;}
.glass-btn{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface);cursor:pointer;font-size:16px;transition:all .15s;display:flex;align-items:center;justify-content:center;}
.glass-btn.filled{background:rgba(96,165,250,.2);border-color:var(--blue);}
.tabs{display:flex;gap:5px;margin-bottom:12px;}
.tab{flex:1;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:7px 4px;font-size:10px;font-weight:500;color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;}
.tab.active{background:var(--surface);border-color:var(--border2);color:var(--text);}
.tab-panel{display:none;}.tab-panel.active{display:block;}
.food-input-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:10px;}
.fi-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--diet);margin-bottom:2px;}
.fi-sub{font-size:10px;color:var(--muted);margin-bottom:11px;font-style:italic;}
.meal-type-row{margin-bottom:8px;}
.barcode-area{text-align:center;padding:22px;border:2px dashed var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:border-color .2s;}
.barcode-area:hover{border-color:var(--border2);}
.ba-icon{font-size:30px;margin-bottom:6px;}.ba-text{font-size:12px;color:var(--muted);}.ba-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.barcode-result{display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px;margin-bottom:8px;}
.br-name{font-size:13px;font-weight:500;margin-bottom:4px;}
.br-macros{display:flex;gap:10px;flex-wrap:wrap;}
.br-macro{font-size:10px;color:var(--muted);}
.br-macro span{color:var(--text);font-weight:500;}
.br-serving{display:flex;align-items:center;gap:8px;margin-top:8px;}
.br-serving label{font-size:11px;color:var(--muted);flex-shrink:0;}
.ingredient-list{margin-bottom:8px;}
.ingredient-item{display:flex;gap:5px;margin-bottom:5px;align-items:center;}
.ingredient-item input.ingr-name{flex:1;}
.ingredient-item input.ingr-qty{width:55px;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:17px;}
.ingredient-item .ingr-unit{width:50px;font-size:11px;padding:10px 5px;}
.add-ingredient-btn{background:none;border:1px dashed var(--border);border-radius:8px;padding:7px;font-size:11px;color:var(--muted);cursor:pointer;width:100%;transition:all .15s;margin-bottom:8px;}
.add-ingredient-btn:hover{border-color:var(--border2);color:var(--text);}
.servings-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:11px;color:var(--muted);}
.servings-row input{width:52px;font-family:'Bebas Neue',sans-serif;font-size:19px;text-align:center;}
.meal-log-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.mli-left{flex:1;}.mli-name{font-size:12px;font-weight:500;margin-bottom:2px;line-height:1.3;}.mli-meta{font-size:10px;color:var(--muted);}
.mli-right{text-align:right;flex-shrink:0;}.mli-cals{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--diet);line-height:1;}.mli-unit{font-size:9px;color:var(--muted);}

/* EXERCISE */
.ex-log-input{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:10px;}
.eli-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--exlog);margin-bottom:2px;}
.eli-sub{font-size:10px;color:var(--muted);margin-bottom:11px;font-style:italic;}
.ex-type-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:10px;}
.ex-type-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 3px;font-size:10px;color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;}
.ex-type-btn.active{border-color:var(--exlog);color:var(--exlog);background:rgba(52,211,153,.08);}
.ex-fields{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:8px;}
.ex-field label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px;}
.effort-row{display:flex;gap:5px;margin-bottom:8px;}
.effort-btn{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px;font-size:10px;color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;}
.effort-btn.active{border-color:var(--exlog);color:var(--exlog);}
.ex-log-list-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.elli-left{flex:1;}.elli-type{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--exlog);margin-bottom:2px;}
.elli-name{font-size:12px;font-weight:500;margin-bottom:2px;}.elli-meta{font-size:10px;color:var(--muted);}
.elli-right{text-align:right;flex-shrink:0;}.elli-cals{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--exlog);line-height:1;}.elli-unit{font-size:9px;color:var(--muted);}

/* WEIGHT */
.wt-targets{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:10px;}
.wt-field label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px;}
.wt-big-input{background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--weight);width:100%;outline:none;transition:border-color .15s;}
.wt-big-input:focus{border-color:var(--weight);}.wt-big-input::placeholder{color:var(--border2);}
.wt-unit{font-size:10px;color:var(--muted);margin-top:3px;}
.to-go{margin-top:11px;padding-top:11px;border-top:1px solid var(--border);text-align:center;}
.tg-num{font-family:'Bebas Neue',sans-serif;font-size:21px;color:var(--accent);}.tg-label{font-size:10px;color:var(--muted);}
.log-weight-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:10px;}
.lw-row{display:flex;gap:7px;align-items:flex-end;}
.lw-field{flex:1;}.lw-field label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:3px;}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:10px;}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:11px;}
.chart-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;color:var(--weight);}
svg.wt-chart{width:100%;height:155px;overflow:visible;}
.chart-empty{text-align:center;padding:26px;color:var(--muted);font-size:12px;font-style:italic;}
.wl-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.wl-item:last-child{border-bottom:none;}
.wl-date{font-size:11px;color:var(--muted);}.wl-val{font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--weight);}
.wl-delta{font-size:10px;padding:2px 7px;border-radius:100px;}
.wl-delta.up{background:rgba(239,68,68,.15);color:#ff6b6b;}.wl-delta.down{background:rgba(34,216,143,.12);color:#22d88f;}
.apple-health-banner{background:linear-gradient(135deg,#1a0a1a,#1a0a10);border:1px solid #4a1a4a;border-radius:12px;padding:13px;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.ah-icon{font-size:20px;flex-shrink:0;}
.ah-text .ht{font-size:11px;font-weight:500;color:#e879f9;margin-bottom:2px;}
.ah-text .hs{font-size:10px;color:var(--muted);line-height:1.4;}

/* STREAKS & ACHIEVEMENTS */
.streaks-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;}
.streak-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:11px;text-align:center;transition:border-color .2s;}
.streak-box.active{border-color:var(--accent);background:rgba(232,255,71,.04);}
.streak-icon{font-size:20px;margin-bottom:3px;}
.streak-val{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;color:var(--accent);}
.streak-val.zero{color:var(--muted);}
.streak-lbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:1px;}
.streak-sub{font-size:9px;color:var(--muted);margin-top:2px;font-style:italic;}
.achievements-grid{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
.achievement-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;transition:all .2s;}
.achievement-card.earned{border-color:var(--accent);background:rgba(232,255,71,.04);}
.achievement-card.locked{opacity:.45;}
.ach-icon{font-size:22px;flex-shrink:0;}
.ach-body{flex:1;}
.ach-name{font-size:12px;font-weight:500;margin-bottom:2px;}
.ach-desc{font-size:10px;color:var(--muted);line-height:1.3;}
.ach-badge{flex-shrink:0;text-align:right;}
.ach-status{font-size:10px;color:var(--accent);font-weight:500;}
.ach-status.locked{color:var(--muted);}
.ach-progress-bar{height:3px;background:var(--border);border-radius:2px;margin-top:4px;overflow:hidden;}
.ach-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s;}
.goal-projection{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;}
.gp-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:1px;margin-bottom:10px;}
.gp-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.gp-row:last-child{border-bottom:none;}
.gp-icon{font-size:18px;flex-shrink:0;}
.gp-label{font-size:11px;color:var(--muted);margin-bottom:1px;}
.gp-val{font-size:13px;font-weight:500;}
.gp-val.good{color:var(--pull);}.gp-val.warn{color:var(--full);}.gp-val.bad{color:var(--danger);}
.new-achievement-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--accent);color:#0e0e0e;border-radius:100px;padding:10px 20px;font-size:13px;font-weight:500;z-index:9999;display:none;white-space:nowrap;box-shadow:0 4px 20px rgba(232,255,71,.4);}
.new-achievement-toast.show{display:block;animation:toastIn .4s ease,toastOut .4s ease 2.6s forwards;}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
@keyframes toastOut{from{opacity:1;}to{opacity:0;}}

/* ONBOARDING */
#onboardScreen{position:fixed;inset:0;background:var(--bg);z-index:1100;display:none;flex-direction:column;overflow-y:auto;transition:background .3s;}
#onboardScreen.show{display:flex;}
.ob-header{padding:32px 24px 0;flex-shrink:0;}
.ob-logo{font-family:'Bebas Neue',sans-serif;font-size:36px;color:var(--accent);letter-spacing:3px;}
.ob-step-indicator{display:flex;gap:5px;margin-top:14px;margin-bottom:4px;}
.ob-step-dot{height:3px;border-radius:2px;background:var(--border);flex:1;transition:background .3s;}
.ob-step-dot.done{background:var(--accent);}
.ob-step-dot.active{background:var(--accent);opacity:.5;}
.ob-step-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:24px;}
.ob-body{padding:0 24px 32px;flex:1;}
.ob-question{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:1px;line-height:1.05;color:var(--text);margin-bottom:6px;}
.ob-sub{font-size:12px;color:var(--muted);margin-bottom:22px;line-height:1.5;}
.ob-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px;}
.ob-chip{background:var(--card);border:1.5px solid var(--border);border-radius:100px;padding:9px 16px;font-size:12px;font-weight:500;color:var(--muted2);cursor:pointer;transition:all .15s;user-select:none;}
.ob-chip.selected{background:rgba(232,255,71,.1);border-color:var(--accent);color:var(--accent);}
.ob-chip:hover:not(.selected){border-color:var(--border2);color:var(--text);}
.ob-options{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
.ob-option{background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:12px;}
.ob-option.selected{border-color:var(--accent);background:rgba(232,255,71,.06);}
.ob-option:hover:not(.selected){border-color:var(--border2);}
.ob-option .ob-opt-icon{font-size:22px;flex-shrink:0;}
.ob-option .ob-opt-label{font-size:13px;font-weight:500;}
.ob-option .ob-opt-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.ob-option .ob-opt-check{margin-left:auto;width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .15s;}
.ob-option.selected .ob-opt-check{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
.ob-fields{display:flex;flex-direction:column;gap:10px;margin-bottom:24px;}
.ob-field label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted2);display:block;margin-bottom:5px;}
.ob-field input,.ob-field select{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none;width:100%;transition:border-color .15s;}
.ob-field input:focus,.ob-field select:focus{border-color:var(--accent);}
.ob-field select option{background:var(--card);}
.ob-two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ob-nav{display:flex;gap:10px;margin-top:8px;}
.ob-back{flex:0 0 auto;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;}
.ob-back:hover{border-color:var(--border2);color:var(--text);}
.ob-next{flex:1;background:var(--accent);border:none;border-radius:12px;padding:14px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:#0e0e0e;cursor:pointer;transition:opacity .15s;}
.ob-next:hover{opacity:.85;}.ob-next:disabled{opacity:.4;cursor:not-allowed;}
.ob-generating{text-align:center;padding:40px 24px;}
.ob-gen-icon{font-size:48px;margin-bottom:16px;animation:float 2s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.ob-gen-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--accent);margin-bottom:8px;}
.ob-gen-sub{font-size:12px;color:var(--muted);line-height:1.6;}
.ob-gen-steps{margin-top:20px;text-align:left;}
.ob-gen-step{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:12px;color:var(--muted);border-bottom:1px solid var(--border);}
.ob-gen-step:last-child{border-bottom:none;}
.ob-gen-step.done{color:var(--pull);}
.ob-gen-step.active{color:var(--text);}
.ob-gen-step .gs-icon{font-size:14px;width:20px;text-align:center;flex-shrink:0;}
.ob-plan-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;}
.ob-plan-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:var(--accent);margin-bottom:12px;}
.ob-plan-text{font-size:13px;color:var(--muted2);line-height:1.7;}
.ob-plan-stat{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.ob-plan-stat:last-child{border-bottom:none;}
.ob-plan-stat-icon{font-size:18px;flex-shrink:0;}
.ob-plan-stat-label{font-size:11px;color:var(--muted);margin-bottom:1px;}
.ob-plan-stat-val{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);line-height:1;}


/* DATE NAVIGATION */
.date-nav{display:flex;align-items:center;gap:6px;margin-bottom:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px 10px;}
.dn-arrow{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:14px;color:var(--muted);cursor:pointer;transition:all .15s;flex-shrink:0;}
.dn-arrow:hover{border-color:var(--border2);color:var(--text);}
.dn-arrow:disabled{opacity:.3;cursor:default;}
.dn-label{flex:1;text-align:center;font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.dn-windows{display:flex;gap:4px;flex-shrink:0;}
.dnw-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:10px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;}
.dnw-btn.active{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
/* WATER TOAST */
.water-toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--blue);color:#fff;border-radius:100px;padding:9px 20px;font-size:13px;font-weight:500;z-index:9999;pointer-events:none;display:none;white-space:nowrap;box-shadow:0 4px 20px rgba(96,165,250,.4);}
.water-toast.show{display:block;animation:wtIn .3s ease,wtOut .3s ease 1.7s forwards;}
@keyframes wtIn{from{opacity:0;transform:translateX(-50%) translateY(10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
@keyframes wtOut{from{opacity:1;}to{opacity:0;}}
/* FAVOURITES */
.fav-section{margin-bottom:10px;}
.fav-section-title{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;padding-left:2px;}
.fav-grid{display:flex;flex-wrap:wrap;gap:6px;}
.fav-chip{background:var(--card);border:1px solid var(--border);border-radius:100px;padding:6px 10px 6px 12px;font-size:11px;font-weight:500;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s;}
.fav-chip:hover{border-color:var(--accent);color:var(--accent);}
.fc-cals{color:var(--diet);font-family:'Bebas Neue',sans-serif;font-size:14px;}
.fc-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;line-height:1;padding:0;margin-left:2px;transition:color .15s;}
.fc-del:hover{color:var(--danger);}
.fav-empty{font-size:11px;color:var(--muted);font-style:italic;}
.fav-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:11px;color:var(--muted);cursor:pointer;transition:all .15s;flex-shrink:0;}
.fav-btn:hover{border-color:var(--accent);color:var(--accent);}
.fav-btn.saved{color:var(--accent);border-color:var(--accent);}

/* THEME - variables injected directly to :root via JS in setTheme() */
body{transition:background .3s,color .3s;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:var(--card);border-radius:20px 20px 0 0;padding:24px 20px 44px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;display:block;}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px;}

/* EXERCISE EXPAND */
.ex-card{position:relative;}
.ex-card-top{display:flex;align-items:center;gap:10px;cursor:pointer;}
.ex-actions{margin-left:auto;display:flex;gap:5px;flex-shrink:0;}
.ex-action-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:10px;color:var(--muted);cursor:pointer;transition:all .15s;}
.ex-action-btn.log-btn{border-color:var(--accent);color:var(--accent);}
.ex-expand{display:none;padding-top:10px;border-top:1px solid var(--border);margin-top:8px;}
.ex-expand.open{display:block;}
.ex-diagram{background:var(--surface);border-radius:10px;padding:8px;margin-bottom:8px;text-align:center;}
.ex-diagram svg{width:100%;max-width:260px;height:auto;}
.ex-yt-link{display:flex;align-items:center;gap:7px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:9px 12px;text-decoration:none;color:var(--danger);font-size:12px;margin-bottom:10px;transition:all .15s;}
.ex-yt-link:hover{border-color:var(--danger);}
.ex-yt-icon{font-size:16px;flex-shrink:0;}

/* SETS LOGGER */
.sets-logger{background:var(--surface);border-radius:10px;padding:10px;margin-top:4px;}
.sets-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.sets-title{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.sets-history-btn{font-size:11px;color:var(--accent);background:none;border:none;cursor:pointer;}
.set-col-labels{display:grid;grid-template-columns:26px 1fr 1fr 28px;gap:5px;margin-bottom:3px;}
.set-col-label{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);text-align:center;}
.set-row{display:grid;grid-template-columns:26px 1fr 1fr 28px;gap:5px;align-items:center;margin-bottom:5px;}
.set-num{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--muted);text-align:center;line-height:1;}
.set-input{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:8px 4px;font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--text);text-align:center;width:100%;outline:none;transition:border-color .15s;}
.set-input:focus{border-color:var(--accent);}
.set-done-btn{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border);background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;flex-shrink:0;}
.set-done-btn.completed{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
.add-set-btn{background:none;border:1px dashed var(--border);border-radius:7px;padding:6px;font-size:10px;color:var(--muted);cursor:pointer;width:100%;margin-top:4px;transition:all .15s;}
.add-set-btn:hover{border-color:var(--border2);color:var(--text);}
.save-sets-btn{background:var(--accent);border:none;border-radius:8px;padding:8px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:#0e0e0e;cursor:pointer;width:100%;margin-top:6px;}

/* STRENGTH HISTORY */
.history-entry{background:var(--surface);border-radius:10px;padding:10px 12px;margin-bottom:6px;}
.he-date{font-size:10px;color:var(--muted);margin-bottom:5px;}
.he-sets{display:flex;flex-wrap:wrap;gap:5px;}
.he-set{background:var(--card);border:1px solid var(--border);border-radius:5px;padding:3px 8px;font-size:11px;}
.he-set span{color:var(--accent);font-weight:500;}

/* CAMERA */
.camera-mode-tabs{display:flex;gap:5px;margin-bottom:10px;}
.cam-tab{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 4px;font-size:10px;font-weight:500;color:var(--muted);cursor:pointer;text-align:center;transition:all .15s;}
.cam-tab.active{border-color:var(--diet);color:var(--diet);background:rgba(192,132,252,.08);}
.cam-panel{display:none;}.cam-panel.active{display:block;}
.camera-area{text-align:center;padding:22px 16px;border:2px dashed var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:border-color .2s;}
.camera-area:hover{border-color:var(--border2);}
.ca-icon{font-size:30px;margin-bottom:6px;}
.ca-text{font-size:12px;color:var(--muted2);font-weight:500;}
.ca-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.cam-controls{display:flex;gap:7px;margin-bottom:8px;}
.barcode-result{display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;}
.br-name{font-size:13px;font-weight:500;margin-bottom:5px;}
.br-macros{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px;}
.br-macro{font-size:10px;color:var(--muted);}
.br-macro span{color:var(--text);font-weight:500;}
.photo-result{display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;}
.photo-result-name{font-size:13px;font-weight:500;margin-bottom:3px;}
.photo-result-macros{font-size:11px;color:var(--muted);margin-bottom:8px;}

/* SETTINGS */
.settings-section{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:12px;overflow:hidden;}
.settings-section-title{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);padding:12px 16px 6px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--border);gap:12px;}
.settings-row:first-of-type{border-top:none;}
.sr-label{font-size:13px;font-weight:500;margin-bottom:2px;}
.sr-sub{font-size:11px;color:var(--muted);}
.theme-btns{display:flex;gap:5px;flex-shrink:0;}
.theme-btn{background:var(--surface);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:0.5px solid var(--glass-border);border-radius:8px;padding:6px 14px;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;}
.theme-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(232,255,71,.08);}
.settings-num{width:85px;font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent);background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:5px 10px;text-align:center;flex-shrink:0;}

/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
   ATHLETE OS \u2014 NEW COMPONENTS
\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */

/* TRAIN \u2014 sport tabs */
.sport-tabs{display:flex;gap:5px;margin-bottom:12px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.sport-tabs::-webkit-scrollbar{display:none;}
.sport-tab{flex-shrink:0;background:var(--card);border:1px solid var(--border);border-radius:100px;padding:7px 16px;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s;letter-spacing:.3px;}
.sport-tab.active{background:var(--accent);border-color:var(--accent);color:#0e0e0e;}
.sport-panel{display:none;}
.sport-panel.active{display:block;}

/* Gym session sub-nav */
.sesh-nav{display:flex;gap:6px;margin-bottom:12px;}
.sesh-nav-btn{flex:1;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 6px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;text-align:center;}
.sesh-nav-btn.active{background:var(--surface);border-color:var(--border2);color:var(--text);}

/* Endurance panel */
.endurance-panel{}
.ep-header{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;border-top:4px solid var(--exlog);}
.ep-sport{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;margin-bottom:10px;}
.ep-zones{display:flex;flex-direction:column;gap:5px;}
.zone-row{display:flex;align-items:center;gap:8px;}
.zone-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.zone-name{font-size:11px;font-weight:500;flex:1;}
.zone-val{font-size:10px;color:var(--muted);}
.ep-workout-suggestions{margin-bottom:10px;}
.ep-workout{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:6px;}
.ep-workout-type{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.ep-workout-name{font-size:13px;font-weight:500;margin-bottom:3px;}
.ep-workout-desc{font-size:11px;color:var(--muted2);line-height:1.4;}

/* DASHBOARD */
.dash-today{margin-bottom:4px;}
.dash-quick-stat{background:var(--surface);border-radius:10px;padding:9px 6px;text-align:center;}
.dqs-val{font-family:'Bebas Neue',sans-serif;font-size:20px;line-height:1;}
.dqs-lbl{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:1px;}

/* Week volume boxes */
.vol-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:all .15s;}
.vol-box:hover{border-color:var(--border2);}
.vol-box .vb-icon{font-size:18px;margin-bottom:3px;}
.vol-box .vb-val{font-family:'Bebas Neue',sans-serif;font-size:20px;line-height:1;}
.vol-box .vb-lbl{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:1px;}

/* FUEL */
.fuel-day-banner{background:linear-gradient(135deg,var(--card),var(--surface));border:1px solid var(--border);border-radius:14px;padding:14px 15px;margin-bottom:10px;border-left:4px solid var(--diet);}

/* PB grid */
.pb-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:11px;}
.pb-sport{font-size:16px;margin-bottom:2px;}
.pb-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:2px;}
.pb-val{font-family:'Bebas Neue',sans-serif;font-size:22px;line-height:1;color:var(--accent);}
.pb-date{font-size:9px;color:var(--muted);margin-top:2px;}

/* Activity log items */
.activity-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:6px;display:flex;align-items:center;gap:10px;}
.ai-sport{font-size:20px;flex-shrink:0;}
.ai-body{flex:1;min-width:0;}
.ai-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ai-meta{font-size:10px;color:var(--muted);margin-top:2px;}
.ai-right{text-align:right;flex-shrink:0;}
.ai-cals{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--exlog);line-height:1;}
.ai-kcal{font-size:9px;color:var(--muted);}

/* Log filter */
#logFilterBtns .btn.active{background:var(--exlog);border-color:var(--exlog);color:#0e0e0e;}
</style>
</head>
<body>
<!-- Splash cover shown until auth resolves -->
<div id="splashCover" style="position:fixed;inset:0;background:var(--bg,#090909);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;transition:background .3s;background-image:radial-gradient(ellipse 70% 50% at 30% 0%,rgba(200,255,0,.06) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 70% 100%,rgba(79,140,255,.05) 0%,transparent 60%);"><div style="font-family:'Bebas Neue',sans-serif;font-size:72px;color:#c8ff00;letter-spacing:5px;line-height:1;text-shadow:0 0 40px rgba(200,255,0,0.3);">LIFT</div><div id="splashStatus" style="font-size:9px;letter-spacing:5px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-top:4px;">Loading...</div><div id="splashDebug" style="display:none;"></div><button onclick="document.getElementById('splashCover').style.display='none';document.getElementById('authScreen').classList.remove('hidden');" style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:none;border:none;padding:12px 24px;color:rgba(255,255,255,.15);font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif;">Having trouble? Tap here</button></div>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-logo">LIFT</div>
  <div class="auth-sub">Athlete OS</div>
  <div class="auth-card" id="loginCard">
    <div class="auth-title">Sign In</div>
    <div class="auth-error" id="loginError"></div>
    <div class="auth-field"><label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="email"></div>
    <div class="auth-field"><label>Password</label><div style="position:relative;"><input type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password" style="padding-right:44px;"><button type="button" onclick="togglePw('loginPassword',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted2);line-height:1;padding:0;">👁</button></div></div>
    <button class="auth-btn" id="loginBtn" onclick="doLogin()">Sign In</button>
    <div class="auth-spinner" id="loginSpinner"><div class="spinner spinner-auth"></div>Signing in...</div>
    <div class="auth-switch">No account? <span onclick="showRegister()">Create one</span></div>
  </div>
  <div class="auth-card" id="registerCard" style="display:none;">
    <div class="auth-title">Create Account</div>
    <div class="auth-error" id="registerError"></div>
    <div class="auth-field"><label>Email</label><input type="email" id="regEmail" placeholder="you@example.com" autocomplete="email"></div>
    <div class="auth-field"><label>Password</label><div style="position:relative;"><input type="password" id="regPassword" placeholder="Min. 6 characters" autocomplete="new-password" style="padding-right:44px;"><button type="button" onclick="togglePw('regPassword',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted2);line-height:1;padding:0;">👁</button></div></div>
    <div class="auth-field"><label>Confirm Password</label><div style="position:relative;"><input type="password" id="regPassword2" placeholder="Repeat password" autocomplete="new-password" style="padding-right:44px;"><button type="button" onclick="togglePw('regPassword2',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--muted2);line-height:1;padding:0;">👁</button></div></div>
    <button class="auth-btn" id="registerBtn" onclick="doRegister()">Create Account</button>
    <div class="auth-spinner" id="registerSpinner"><div class="spinner spinner-auth"></div>Creating account...</div>
    <div class="auth-switch">Have an account? <span onclick="showLogin()">Sign in</span></div>
  </div>
</div>

<!-- ONBOARDING SCREEN -->
<div id="onboardScreen">
  <div class="ob-header">
    <div class="ob-logo">LIFT</div>
    <div class="ob-step-indicator" id="obStepDots"></div>
    <div class="ob-step-label" id="obStepLabel">Step 1 of 6</div>
  </div>
  <div class="ob-body" id="obBody"></div>
</div>

<!-- STRENGTH HISTORY MODAL -->
<div class="modal-overlay" id="strengthModal" onclick="if(event.target===this)closeStrengthModal()">
  <div class="modal-sheet">
    <span class="modal-handle"></span>
    <div class="modal-title" id="strengthModalTitle">History</div>
    <div id="strengthModalBody"></div>
  </div>
</div>

<!-- INSTALL BANNER -->
<div id="installBanner">
  <div class="ib-text"><strong>Add LIFT to Home Screen</strong>Tap Share \u2192 "Add to Home Screen" in Safari</div>
  <button class="ib-btn" id="installBtn">Install</button>
  <button class="ib-close" onclick="dismissInstall()">\u00d7</button>
</div>

<!-- HEADER -->
<header>
  <div class="logo">LIFT</div>
  <div class="header-right">
    <div class="week-badge"><div class="wn" id="todayDate"></div><div class="wl" id="todayDay"></div></div>
    <div class="user-menu">
      <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">?</div>
      <div class="user-dropdown" id="userDropdown">
        <div class="ud-email" id="udEmail">\u2014</div>
        <div class="ud-item" onclick="exportData()">📥 Export Data</div>
        <div class="ud-item danger" onclick="doSignOut()">🚪 Sign Out</div>
      </div>
    </div>
  </div>
</header>

<div class="sync-bar"><div class="sync-dot" id="syncDot"></div><span id="syncStatus">Connecting...</span></div>

<nav class="nav">
  <div class="nav-logo">LIFT</div>
  <button class="nb active" onclick="showView('dashboard')"><span class="tab-icon">&#127968;</span>Home</button>
  <button class="nb" onclick="showView('train')"><span class="tab-icon">&#9889;</span>Train</button>
  <button class="nb" onclick="showView('fuel')"><span class="tab-icon">&#127859;</span>Fuel</button>
  <button class="nb" onclick="showView('body')"><span class="tab-icon">&#9878;&#65039;</span>Body</button>
  <button class="nb" onclick="showView('progress')"><span class="tab-icon">&#128200;</span>Progress</button>
  <button class="nb" onclick="showView('settings')"><span class="tab-icon">&#9881;&#65039;</span>Settings</button>
</nav>

<main>

<!-- DASHBOARD -->
<div class="view active" id="view-dashboard">

  <!-- Today's brief -->
  <div class="card">
    <div class="dash-today-inner">
      <div>
        <div style="font-size:8.5px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Today</div>
        <div id="dashSportTag" class="dash-sport-big">Rest Day</div>
        <div id="dashReadiness" style="font-size:11px;color:var(--muted2);margin-top:3px;line-height:1.4;">Recovery &amp; fuelling day</div>
      </div>
      <div style="text-align:right;">
        <div class="dash-date-label">Net Cals</div>
        <div id="dashNetCals" class="dash-net-big" style="color:var(--text);">\u2014</div>
        <div style="font-size:9px;color:var(--muted);">eaten \u2212 burned</div>
      </div>
    </div>
    <div class="dash-quick-grid" id="dashQuickStats"></div>
  </div>

  <!-- Training Insights -->
  <div class="section-label">Training Status</div>
  <div id="trainingInsightCard" class="insight-card insight-nodata">
    <div class="ic-row">
      <div class="ic-emoji" id="insightEmoji">📊</div>
      <div class="ic-body">
        <div class="ic-status" id="insightStatus">NO DATA YET</div>
        <div class="ic-headline" id="insightHeadline">Start logging sessions</div>
        <div class="ic-detail" id="insightDetail">Log your first training session to see personalised load guidance here.</div>
        <div id="insightTrend" style="display:none;" class="trend-pill"></div>
      </div>
    </div>
    <div class="ic-metrics">
      <div class="ic-metric"><div class="ic-metric-val" id="dashCTL" style="color:var(--pull);">\u2014</div><div class="ic-metric-lbl">Fitness CTL</div></div>
      <div class="ic-metric"><div class="ic-metric-val" id="dashATL" style="color:var(--danger);">\u2014</div><div class="ic-metric-lbl">Fatigue ATL</div></div>
      <div class="ic-metric"><div class="ic-metric-val" id="dashTSB" style="color:var(--accent);">\u2014</div><div class="ic-metric-lbl">Form TSB</div></div>
    </div>
    <div class="ic-rec" id="insightRec" style="display:none;">
      <div class="ic-rec-label">\u26a1 Recommended next session</div>
      <div class="ic-rec-text" id="insightRecText">\u2014</div>
    </div>
    <span id="dashFormLabel" style="display:none;"></span>
  </div>
  <svg id="loadChart" style="width:100%;height:60px;display:block;margin:6px 0 14px;opacity:.7;"></svg>

  <!-- Weekly volume by sport -->
  <div class="section-label">This Week</div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:10px;" id="weekVolume"></div>

  <!-- Race / Event countdown -->
  <div id="raceCountdownSection" style="display:none;">
    <div class="section-label">Next Event</div>
    <div class="card" id="raceCountdownCard" style="background:linear-gradient(135deg,var(--card),var(--surface));border-color:var(--accent);">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="font-size:32px;" id="raceIcon">🏁</div>
        <div style="flex:1;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;color:var(--accent);" id="raceName">Event</div>
          <div style="font-size:11px;color:var(--muted2);" id="raceDate">\u2014</div>
        </div>
        <div style="text-align:center;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:40px;line-height:1;color:var(--accent);" id="raceDays">\u2014</div>
          <div style="font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;">days</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add event -->
  <div id="addEventSection">
    <div class="section-label">Upcoming Event</div>
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <input type="text" id="eventName" placeholder="Race or event name" style="flex:2;min-width:120px;">
        <input type="date" id="eventDate" style="flex:1;min-width:110px;">
        <select id="eventType" style="flex:1;min-width:90px;">
          <option value="🚴">🚴 Ride</option>
          <option value="🏃">🏃 Run</option>
          <option value="🏊">🏊 Triathlon</option>
          <option value="🏋\ufe0f">🏋\ufe0f Competition</option>
          <option value="🏁">🏁 Other</option>
        </select>
        <button class="btn btn-primary" onclick="saveEvent()" style="flex-shrink:0;">Add</button>
      </div>
    </div>
  </div>

  <!-- Sport streaks -->
  <div class="section-label">Streaks</div>
  <div class="streaks-row" id="streaksRow">
    <div class="streak-box" id="streakLogging"><div class="streak-icon">🍽\ufe0f</div><div class="streak-val zero" id="streakLoggingVal">0</div><div class="streak-lbl">Nutrition</div></div>
    <div class="streak-box" id="streakExercise"><div class="streak-icon">\u26a1</div><div class="streak-val zero" id="streakExerciseVal">0</div><div class="streak-lbl">Training</div></div>
    <div class="streak-box" id="streakWeigh"><div class="streak-icon">\u2696\ufe0f</div><div class="streak-val zero" id="streakWeighVal">0</div><div class="streak-lbl">Check-in</div></div>
  </div>
  <div class="health-banner"><div class="health-icon">🍎</div><div class="health-text"><div class="ht-title">Apple Health \u2014 iOS App Coming</div><div class="ht-sub">HRV, sleep, and resting HR will feed into your readiness score when we launch the native app.</div></div></div>
</div>

<!-- ACHIEVEMENT TOAST -->
<div class="new-achievement-toast" id="achievementToast"></div>
<div class="water-toast" id="waterToast"></div>

<!-- TRAIN -->
<div class="view" id="view-train">
  <!-- Sport selector tabs -->
  <div class="sport-tabs">
    <div class="sport-tab active" onclick="switchSport('gym',this)">🏋\ufe0f Gym</div>
    <div class="sport-tab" onclick="switchSport('ride',this)">🚴 Ride</div>
    <div class="sport-tab" onclick="switchSport('run',this)">🏃 Run</div>
    <div class="sport-tab" onclick="switchSport('swim',this)">🏊 Swim</div>
    <div class="sport-tab" onclick="switchSport('log',this)">\u2795 Log</div>
  </div>

  <!-- GYM PANEL -->
  <div class="sport-panel active" id="panel-gym">
    <div class="sesh-nav">
      <button class="sesh-nav-btn active" onclick="showGymSesh('A',this)">Push</button>
      <button class="sesh-nav-btn" onclick="showGymSesh('B',this)">Pull</button>
      <button class="sesh-nav-btn" onclick="showGymSesh('C',this)">Full Body</button>
    </div>
    <!-- Session A -->
    <div id="gymSesh-A">
      <div class="sesh-header push-view"><div class="sesh-title">PUSH + CORE</div><div class="sesh-sub">Chest \u00b7 Shoulders \u00b7 Triceps</div><div class="sesh-meta"><span class="pill">45 min</span><span class="pill">Upper</span><span class="pill">Core</span></div><div class="progress-bar"><div class="progress-fill" id="progA" style="width:0%"></div></div></div>
      <div class="timer-section"><div class="timer-label">Session Timer</div><div class="timer-display" id="timerA">45:00</div><div class="timer-controls"><button class="btn btn-primary" onclick="startTimer('A')">Start</button><button class="btn" onclick="pauseTimer('A')">Pause</button><button class="btn" onclick="resetTimer('A')">Reset</button></div></div>
      <div class="phase-label">Warm-Up \u2014 5 min</div>
      <div class="ex-card" onclick="toggleEx(this,'A')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Arm Circles + Band Pull-Aparts</div><div class="ex-detail">Shoulder rotations \u00b7 Bodyweight squats \u00b7 5 min</div></div></div>
      <div class="phase-label">Main Work \u2014 35 min</div>
      <div class="ex-card" id="exA-1" data-name="Bench Press" data-session="A"><div class="ex-card-top" onclick="toggleExExpand('exA-1')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Bench Press</div><div class="ex-detail">Barbell or Dumbbell \u00b7 4\u00d78\u201310</div></div><div class="ex-rest">60s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exA-1')">Log Sets</button></div></div><div class="ex-expand" id="expand-exA-1"></div></div>
      <div class="ex-card" id="exA-2" data-name="Overhead Press" data-session="A"><div class="ex-card-top" onclick="toggleExExpand('exA-2')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Overhead Press</div><div class="ex-detail">Barbell or Dumbbell \u00b7 3\u00d710</div></div><div class="ex-rest">60s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exA-2')">Log Sets</button></div></div><div class="ex-expand" id="expand-exA-2"></div></div>
      <div class="ex-card" id="exA-3" data-name="Incline Dumbbell Press" data-session="A"><div class="ex-card-top" onclick="toggleExExpand('exA-3')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Incline Dumbbell Press</div><div class="ex-detail">3\u00d710</div></div><div class="ex-rest">45s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exA-3')">Log Sets</button></div></div><div class="ex-expand" id="expand-exA-3"></div></div>
      <div class="ex-card" id="exA-4" data-name="Lateral Raises" data-session="A"><div class="ex-card-top" onclick="toggleExExpand('exA-4')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Lateral Raises</div><div class="ex-detail">Dumbbell \u00b7 3\u00d712</div></div><div class="ex-rest">30s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exA-4')">Log Sets</button></div></div><div class="ex-expand" id="expand-exA-4"></div></div>
      <div class="ex-card" id="exA-5" data-name="Plank Hold" data-session="A"><div class="ex-card-top" onclick="toggleExExpand('exA-5')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Plank Hold</div><div class="ex-detail">3\u00d745\u201360s</div></div><div class="ex-rest">30s</div></div><div class="ex-expand" id="expand-exA-5"></div></div>
      <div class="phase-label">Cool-Down</div>
      <div class="stretch-section"><div class="stretch-title">Stretch Down</div>
        <div class="stretch-item" onclick="toggleStr(this,'A')"><div class="str-chk">\u2713</div><div><div class="str-name">Chest & Shoulders</div><div class="str-desc">Doorframe or cross-body \u00b7 30s each</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'A')"><div class="str-chk">\u2713</div><div><div class="str-name">Hip Flexors \u2014 tight from cycling</div><div class="str-desc">Kneeling stretch \u00b7 45\u201360s each side</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'A')"><div class="str-chk">\u2713</div><div><div class="str-name">Hamstrings</div><div class="str-desc">Seated or standing \u00b7 30s</div></div></div>
      </div>
      <div class="complete-banner" id="completeA"><div class="cb-emoji">💪</div><div class="cb-title">Push Session Done</div><div class="cb-text">Strong work. Fuel up and recover.</div></div>
      <button class="reset-btn" onclick="resetSesh('A')">Reset Session</button>
    </div>
    <!-- Session B -->
    <div id="gymSesh-B" style="display:none;">
      <div class="sesh-header pull-view"><div class="sesh-title">PULL + CORE</div><div class="sesh-sub">Back \u00b7 Biceps \u00b7 Rear Delts</div><div class="sesh-meta"><span class="pill">45 min</span><span class="pill">Upper</span><span class="pill">Core</span></div><div class="progress-bar"><div class="progress-fill" id="progB" style="width:0%"></div></div></div>
      <div class="timer-section"><div class="timer-label">Session Timer</div><div class="timer-display" id="timerB">45:00</div><div class="timer-controls"><button class="btn btn-primary" onclick="startTimer('B')">Start</button><button class="btn" onclick="pauseTimer('B')">Pause</button><button class="btn" onclick="resetTimer('B')">Reset</button></div></div>
      <div class="phase-label">Warm-Up</div>
      <div class="ex-card" onclick="toggleEx(this,'B')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Cat-Cow + Scapular Pull-Ups</div><div class="ex-detail">Light band or cable row \u00b7 5 min</div></div></div>
      <div class="phase-label">Main Work</div>
      <div class="ex-card" id="exB-1" data-name="Pull-Ups / Lat Pulldown" data-session="B"><div class="ex-card-top" onclick="toggleExExpand('exB-1')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Pull-Ups / Lat Pulldown</div><div class="ex-detail">4\u00d78</div></div><div class="ex-rest">60s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exB-1')">Log Sets</button></div></div><div class="ex-expand" id="expand-exB-1"></div></div>
      <div class="ex-card" id="exB-2" data-name="Barbell Row" data-session="B"><div class="ex-card-top" onclick="toggleExExpand('exB-2')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Barbell or Dumbbell Row</div><div class="ex-detail">4\u00d710</div></div><div class="ex-rest">60s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exB-2')">Log Sets</button></div></div><div class="ex-expand" id="expand-exB-2"></div></div>
      <div class="ex-card" id="exB-3" data-name="Face Pulls" data-session="B"><div class="ex-card-top" onclick="toggleExExpand('exB-3')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Face Pulls</div><div class="ex-detail">Cable or band \u00b7 3\u00d715</div></div><div class="ex-rest">30s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exB-3')">Log Sets</button></div></div><div class="ex-expand" id="expand-exB-3"></div></div>
      <div class="ex-card" id="exB-4" data-name="Hammer Curls" data-session="B"><div class="ex-card-top" onclick="toggleExExpand('exB-4')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Hammer Curls</div><div class="ex-detail">Dumbbell \u00b7 3\u00d712</div></div><div class="ex-rest">30s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exB-4')">Log Sets</button></div></div><div class="ex-expand" id="expand-exB-4"></div></div>
      <div class="phase-label">Cool-Down</div>
      <div class="stretch-section"><div class="stretch-title">Stretch Down</div>
        <div class="stretch-item" onclick="toggleStr(this,'B')"><div class="str-chk">\u2713</div><div><div class="str-name">Lats & Back</div><div class="str-desc">Child's pose \u00b7 30\u201345s</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'B')"><div class="str-chk">\u2713</div><div><div class="str-name">Chest & Shoulders</div><div class="str-desc">Doorframe \u00b7 30s each</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'B')"><div class="str-chk">\u2713</div><div><div class="str-name">Hip Flexors</div><div class="str-desc">Kneeling \u00b7 45\u201360s each</div></div></div>
      </div>
      <div class="complete-banner" id="completeB"><div class="cb-emoji">💪</div><div class="cb-title">Pull Session Done</div><div class="cb-text">Strong work. Fuel up and recover.</div></div>
      <button class="reset-btn" onclick="resetSesh('B')">Reset Session</button>
    </div>
    <!-- Session C -->
    <div id="gymSesh-C" style="display:none;">
      <div class="sesh-header full-view"><div class="sesh-title">FULL BODY</div><div class="sesh-sub">Compounds + Power + Core</div><div class="sesh-meta"><span class="pill">50 min</span><span class="pill">Full Body</span><span class="pill">Compound</span></div><div class="progress-bar"><div class="progress-fill" id="progC" style="width:0%"></div></div></div>
      <div class="timer-section"><div class="timer-label">Session Timer</div><div class="timer-display" id="timerC">50:00</div><div class="timer-controls"><button class="btn btn-primary" onclick="startTimer('C')">Start</button><button class="btn" onclick="pauseTimer('C')">Pause</button><button class="btn" onclick="resetTimer('C')">Reset</button></div></div>
      <div class="phase-label">Warm-Up</div>
      <div class="ex-card" onclick="toggleEx(this,'C')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Hip Flexor Stretch + Glute Bridges</div><div class="ex-detail">Leg swings \u00b7 5 min</div></div></div>
      <div class="phase-label">Main Work</div>
      <div class="ex-card" id="exC-1" data-name="Deadlift" data-session="C"><div class="ex-card-top" onclick="toggleExExpand('exC-1')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Deadlift</div><div class="ex-detail">4\u00d76\u20138</div></div><div class="ex-rest">90s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exC-1')">Log Sets</button></div></div><div class="ex-expand" id="expand-exC-1"></div></div>
      <div class="ex-card" id="exC-2" data-name="Goblet Squat" data-session="C"><div class="ex-card-top" onclick="toggleExExpand('exC-2')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Goblet Squat</div><div class="ex-detail">3\u00d710</div></div><div class="ex-rest">60s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exC-2')">Log Sets</button></div></div><div class="ex-expand" id="expand-exC-2"></div></div>
      <div class="ex-card" id="exC-3" data-name="Dumbbell Romanian Deadlift" data-session="C"><div class="ex-card-top" onclick="toggleExExpand('exC-3')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Dumbbell Romanian Deadlift</div><div class="ex-detail">3\u00d710</div></div><div class="ex-rest">45s</div><div class="ex-actions"><button class="ex-action-btn log-btn" onclick="event.stopPropagation();openExpand('exC-3')">Log Sets</button></div></div><div class="ex-expand" id="expand-exC-3"></div></div>
      <div class="ex-card" id="exC-4" data-name="Farmer's Carry" data-session="C"><div class="ex-card-top" onclick="toggleExExpand('exC-4')"><div class="ex-chk">\u2713</div><div class="ex-info"><div class="ex-name">Farmer's Carry</div><div class="ex-detail">3\u00d730m</div></div><div class="ex-rest">45s</div></div><div class="ex-expand" id="expand-exC-4"></div></div>
      <div class="phase-label">Cool-Down</div>
      <div class="stretch-section"><div class="stretch-title">Stretch Down</div>
        <div class="stretch-item" onclick="toggleStr(this,'C')"><div class="str-chk">\u2713</div><div><div class="str-name">Hip Flexors \u2014 priority</div><div class="str-desc">Kneeling \u00b7 60s each</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'C')"><div class="str-chk">\u2713</div><div><div class="str-name">Hamstrings</div><div class="str-desc">Seated or standing \u00b7 30\u201345s</div></div></div>
        <div class="stretch-item" onclick="toggleStr(this,'C')"><div class="str-chk">\u2713</div><div><div class="str-name">Lats & Back</div><div class="str-desc">Child's pose \u00b7 30\u201345s</div></div></div>
      </div>
      <div class="complete-banner" id="completeC"><div class="cb-emoji">💪</div><div class="cb-title">Full Body Done</div><div class="cb-text">Strong work. Fuel up and recover.</div></div>
      <button class="reset-btn" onclick="resetSesh('C')">Reset Session</button>
    </div>
  </div>

  <!-- RIDE PANEL -->
  <div class="sport-panel" id="panel-ride">
    <div class="endurance-panel">
      <div class="ep-header" style="border-top-color:var(--exlog);">
        <div class="ep-sport">🚴 Ride</div>
        <div class="ep-zones">
          <div class="zone-row"><div class="zone-dot" style="background:#60a5fa;"></div><div class="zone-name">Z1 Recovery</div><div class="zone-val">&lt;55% FTP</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#34d399;"></div><div class="zone-name">Z2 Endurance</div><div class="zone-val">56\u201375% FTP</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#f59e0b;"></div><div class="zone-name">Z3 Tempo</div><div class="zone-val">76\u201390% FTP</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#f97316;"></div><div class="zone-name">Z4 Threshold</div><div class="zone-val">91\u2013105% FTP</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#ef4444;"></div><div class="zone-name">Z5 VO2 Max</div><div class="zone-val">&gt;106% FTP</div></div>
        </div>
      </div>
      <div class="ep-workout-suggestions" id="rideWorkouts"></div>
      <div class="section-label">Log This Ride</div>
      <div id="rideLogForm"></div>
    </div>
  </div>

  <!-- RUN PANEL -->
  <div class="sport-panel" id="panel-run">
    <div class="endurance-panel">
      <div class="ep-header" style="border-top-color:var(--pull);">
        <div class="ep-sport">🏃 Run</div>
        <div class="ep-zones">
          <div class="zone-row"><div class="zone-dot" style="background:#60a5fa;"></div><div class="zone-name">Easy / Recovery</div><div class="zone-val">60\u201370% HR max</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#34d399;"></div><div class="zone-name">Aerobic Base</div><div class="zone-val">70\u201380% HR max</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#f59e0b;"></div><div class="zone-name">Tempo</div><div class="zone-val">80\u201387% HR max</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#f97316;"></div><div class="zone-name">Threshold</div><div class="zone-val">88\u201393% HR max</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#ef4444;"></div><div class="zone-name">VO2 Max</div><div class="zone-val">&gt;93% HR max</div></div>
        </div>
      </div>
      <div class="ep-workout-suggestions" id="runWorkouts"></div>
      <div class="section-label">Log This Run</div>
      <div id="runLogForm"></div>
    </div>
  </div>

  <!-- SWIM PANEL -->
  <div class="sport-panel" id="panel-swim">
    <div class="endurance-panel">
      <div class="ep-header" style="border-top-color:var(--blue);">
        <div class="ep-sport">🏊 Swim</div>
        <div class="ep-zones">
          <div class="zone-row"><div class="zone-dot" style="background:#60a5fa;"></div><div class="zone-name">Easy</div><div class="zone-val">Conversational pace</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#34d399;"></div><div class="zone-name">Aerobic</div><div class="zone-val">Steady \u00b7 CSS +15s</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#f59e0b;"></div><div class="zone-name">Threshold</div><div class="zone-val">CSS pace</div></div>
          <div class="zone-row"><div class="zone-dot" style="background:#ef4444;"></div><div class="zone-name">Speed</div><div class="zone-val">CSS \u22125s (short reps)</div></div>
        </div>
      </div>
      <div class="section-label">Log This Swim</div>
      <div id="swimLogForm"></div>
    </div>
  </div>

  <!-- LOG PANEL (quick log / Strava) -->
  <div class="sport-panel" id="panel-log">
    <div class="ex-log-input">
      <div class="eli-title">Quick Log</div>
      <div class="eli-sub">Log any session manually \u2014 AI estimates calorie burn from type, duration, distance, and effort.</div>
      <div class="ex-type-grid">
        <div class="ex-type-btn active" onclick="setExType('🚴 Cycling',this)">🚴 Cycling</div>
        <div class="ex-type-btn" onclick="setExType('🏃 Running',this)">🏃 Running</div>
        <div class="ex-type-btn" onclick="setExType('🏊 Swimming',this)">🏊 Swimming</div>
        <div class="ex-type-btn" onclick="setExType('🏋\ufe0f Weights',this)">🏋\ufe0f Weights</div>
        <div class="ex-type-btn" onclick="setExType('\u26a1 Other',this)">\u26a1 Other</div>
      </div>
      <div class="ex-fields">
        <div class="ex-field"><label>Duration (mins)</label><input type="number" id="exDuration" placeholder="90"></div>
        <div class="ex-field"><label>Distance (km)</label><input type="number" id="exDistance" placeholder="40" step="0.1"></div>
      </div>
      <div class="section-label" style="margin-top:2px;">Effort Level</div>
      <div class="effort-row">
        <div class="effort-btn active" onclick="setEffort('Easy',this)">Easy</div>
        <div class="effort-btn" onclick="setEffort('Moderate',this)">Moderate</div>
        <div class="effort-btn" onclick="setEffort('Hard',this)">Hard</div>
        <div class="effort-btn" onclick="setEffort('Max',this)">Max</div>
      </div>
      <div class="ex-field" style="margin-bottom:8px;"><label>Avg Heart Rate (bpm)</label><input type="number" id="exHR" placeholder="145"></div>
      <div class="ex-field" style="margin-bottom:8px;"><label>Notes</label><textarea id="exNotes" rows="2" placeholder="e.g. Hilly loop through Richmond Park"></textarea></div>
      <div class="ex-field" style="margin-bottom:8px;">
        <label>Calories Burned <span style="color:var(--muted);font-weight:300;">(leave blank for AI estimate)</span></label>
        <input type="number" id="exManualCals" placeholder="e.g. 650" min="1">
      </div>
      <div class="thinking" id="exThinking"><div class="spinner spinner-ex"></div>AI estimating calorie burn...</div>
      <button class="btn btn-ex btn-block" onclick="logExercise()">Log Session</button>
    </div>

    <div class="section-label">Today's Sessions</div>
    <div id="exerciseLogList"></div>
    <div id="exerciseLogEmpty" style="text-align:center;padding:24px;color:var(--muted);font-size:12px;font-style:italic;">No sessions logged yet.</div>
    <div class="card" style="text-align:center;margin-top:4px;">
      <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;">Total Burned Today</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:40px;color:var(--exlog);" id="totalBurnedDisplay">0</div>
      <div style="font-size:10px;color:var(--muted);">kcal</div>
    </div>

    <!-- Strava import (moved here, under Log) -->
    <div class="card" style="margin-top:4px;">
      <div class="card-title" style="color:var(--exlog);">🟠 Strava Import</div>
      <div id="stravaNotConnected">
        <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;line-height:1.6;">Connect Strava to import your activities automatically.</div>
        <button class="btn btn-ex btn-block" onclick="connectStrava()">Connect Strava</button>
      </div>
      <div id="stravaConnected" style="display:none;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="font-size:18px;">🟠</span>
          <div><div style="font-size:13px;font-weight:500;color:var(--text);">Strava Connected</div><div style="font-size:11px;color:var(--muted);" id="stravaAthleteInfo">\u2014</div></div>
          <button class="del-btn" onclick="disconnectStrava()" style="margin-left:auto;" title="Disconnect">\u00d7</button>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <select id="stravaImportDays" style="flex:1;font-size:13px;">
            <option value="1">Today</option>
            <option value="7" selected>Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30">Last 30 days</option>
          </select>
          <button class="btn btn-ex" onclick="importFromStrava()">Import</button>
        </div>
        <div class="thinking" id="stravaThinking"><div class="spinner spinner-ex"></div>Fetching from Strava...</div>
        <div id="stravaImportResults" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- FUEL -->
<div class="view" id="view-fuel">
  <div class="date-nav" id="fuelDateNav">
    <button class="dn-arrow" id="fuelNavPrev" onclick="shiftDateNav('fuel',-1)">&#8249;</button>
    <span class="dn-label" id="fuelNavLabel">Today</span>
    <button class="dn-arrow" id="fuelNavNext" onclick="shiftDateNav('fuel',1)">&#8250;</button>
    <div class="dn-windows">
      <button class="dnw-btn active" onclick="setDateWindow('fuel','day',this)">Day</button>
      <button class="dnw-btn" onclick="setDateWindow('fuel','week',this)">Wk</button>
      <button class="dnw-btn" onclick="setDateWindow('fuel','month',this)">Mo</button>
    </div>
  </div>
  <!-- Sport-day carb target banner -->
  <div id="fuelDayBanner" class="fuel-day-banner">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:2px;">Today's Fuel Strategy</div>
        <div id="fuelDayType" style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:1px;color:var(--accent);">Rest Day</div>
        <div id="fuelDayAdvice" style="font-size:11px;color:var(--muted2);margin-top:1px;">Lower carbs \u00b7 Prioritise protein & veg</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Carb Target</div>
        <div id="fuelCarbTarget" style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--diet);">\u2014g</div>
      </div>
    </div>
  </div>
  <div class="grid3" style="margin-bottom:10px;">
    <div class="ds-box cal-box"><div class="dsv" id="dietTotalCals">0</div><div class="dsl">kcal eaten</div></div>
    <div class="ds-box pro-box"><div class="dsv" id="dietTotalPro">0g</div><div class="dsl">protein</div></div>
    <div class="ds-box wat-box"><div class="dsv" id="dietWaterCount">0/8</div><div class="dsl">water</div></div>
  </div>
  <div class="calorie-goal-bar">
    <div class="cg-header"><span class="cg-title">Daily Calorie Goal</span><div class="cg-edit"><input class="cg-input" type="number" id="calGoalInput" value="2000" onchange="syncCalGoal()"><span class="cg-label">kcal</span></div></div>
    <div class="goalbar"><div class="goalbar-fill" id="goalbarFill" style="width:0%"></div></div>
    <div class="goalbar-labels"><span id="glLeft">2000 remaining</span><span id="glPct">0%</span></div>
  </div>
  <div class="water-card">
    <div class="water-header">
      <span class="water-title">💧 Water Intake</span>
      <span class="water-count" id="waterCountDisplay">0 / 8</span>
    </div>
    <div class="water-glasses" id="waterGlasses"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn" style="flex:1;padding:10px;font-size:13px;" onclick="adjustWater(-1)">\u2212 Remove</button>
      <button class="btn btn-diet" style="flex:1;padding:10px;font-size:13px;" onclick="adjustWater(1)">+ Add Glass</button>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchDietTab('log',this)">Log Food</div>
    <div class="tab" onclick="switchDietTab('camera',this)">📷 Camera</div>
    <div class="tab" onclick="switchDietTab('recipe',this)">Recipe</div>
    <div class="tab" onclick="switchDietTab('history',this)">History</div>
  </div>
  <div class="tab-panel active" id="dietTab-log">
    <div class="fav-section" id="favSection">
      <div class="fav-section-title">&#9733; Quick Add &mdash; Favourites</div>
      <div class="fav-grid" id="favGrid"><span class="fav-empty">Save meals as favourites for quick logging.</span></div>
    </div>
    <div class="food-input-card">
      <div class="fi-title">Log a Meal</div>
      <div class="fi-sub">Describe what you ate and AI will find options to choose from.</div>
      <div class="meal-type-row"><select id="mealTypeLog"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select></div>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <textarea id="mealDescInput" rows="2" placeholder="e.g. flat white, M&S chicken sandwich..." style="flex:1;margin:0;"></textarea>
        <button class="btn btn-diet" style="align-self:flex-end;white-space:nowrap;padding:10px 16px;" onclick="findFoodOptions()">Find</button>
      </div>
      <div class="thinking" id="logThinking"><div class="spinner"></div>Finding options...</div>
      <!-- Results list -->
      <div id="foodOptionsList" style="display:none;margin-bottom:8px;"></div>
      <!-- Confirm panel -->
      <div id="foodConfirmPanel" style="display:none;background:var(--card2,#1e1e1e);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;">
        <div id="foodConfirmName" style="font-weight:600;font-size:14px;margin-bottom:4px;"></div>
        <div id="foodConfirmMacros" style="font-size:12px;color:var(--muted);margin-bottom:12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <label style="font-size:12px;color:var(--muted);white-space:nowrap;">Quantity</label>
          <input type="number" id="foodQtyInput" value="1" min="0.25" step="0.25" style="width:70px;text-align:center;">
          <span id="foodQtyUnit" style="font-size:12px;color:var(--muted);">serving</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div id="foodConfirmTotal" style="font-size:13px;font-weight:600;color:var(--accent);"></div>
          <div style="display:flex;gap:8px;">
            <button class="fav-btn" id="saveFavBtn" onclick="saveFoodAsFavourite()">&#9733; Fav</button>
            <button class="btn" style="padding:8px 14px;font-size:12px;" onclick="resetFoodLog()">Back</button>
            <button class="btn btn-diet" style="padding:8px 14px;font-size:12px;" onclick="confirmFoodLog()">Log It</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-panel" id="dietTab-camera">
    <div class="food-input-card">
      <div class="fi-title">Food Camera</div>
      <div class="fi-sub">Scan barcodes, photograph food for AI identification, or capture a nutrition label.</div>
      <div class="camera-mode-tabs">
        <div class="cam-tab active" onclick="switchCamMode('barcode',this)">📦 Barcode</div>
        <div class="cam-tab" onclick="switchCamMode('identify',this)">🍔 Identify</div>
        <div class="cam-tab" onclick="switchCamMode('label',this)">📋 Label</div>
      </div>
      <!-- BARCODE -->
      <div class="cam-panel active" id="camPanel-barcode">
        <input type="file" id="barcodeFileInput" accept="image/*" capture="environment" style="display:none;" onchange="handleBarcodePhoto(this)">
        <div class="camera-area" id="barcodeArea" onclick="document.getElementById('barcodeFileInput').click()"><div class="ca-icon">📷</div><div class="ca-text">Tap to scan barcode</div><div class="ca-sub">Takes a photo \u2014 AI reads the barcode</div></div>
        <div style="display:flex;gap:7px;margin-bottom:8px;margin-top:8px;"><input type="number" id="manualBarcode" placeholder="e.g. 5000157024380" style="flex:1;"><button class="btn btn-diet" onclick="lookupBarcode()">Look Up</button></div>
        <div class="thinking" id="barcodeThinking"><div class="spinner"></div>Looking up product...</div>
        <div class="barcode-result" id="barcodeResult">
          <div class="br-name" id="brProductName">\u2014</div>
          <div class="br-macros"><div class="br-macro">Cal: <span id="brCals">\u2014</span></div><div class="br-macro">Protein: <span id="brProt">\u2014</span></div><div class="br-macro">Carbs: <span id="brCarbs">\u2014</span></div><div class="br-macro">Fat: <span id="brFat">\u2014</span></div></div>
          <div class="br-macro" id="brServingInfo" style="margin-top:4px;font-size:10px;"></div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px;"><label style="font-size:11px;color:var(--muted);">Qty:</label><input type="number" id="brServings" value="1" min="0.5" step="0.5" style="width:55px;font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--diet);" onchange="updateBarcodeCalcs()"><span style="font-size:11px;color:var(--muted);" id="brUnit">serving(s)</span></div>
          <div style="margin-top:4px;font-size:12px;color:var(--muted);">Total: <span id="brTotalCals" style="color:var(--diet);font-family:'Bebas Neue',sans-serif;font-size:17px;">\u2014</span> kcal</div>
          <select id="mealTypeBarcode" style="margin-top:8px;"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select>
          <button class="btn btn-diet btn-block" style="margin-top:8px;" onclick="logBarcodeItem()">Add to Log</button>
        </div>
      </div>
      <!-- IDENTIFY -->
      <div class="cam-panel" id="camPanel-identify">
        <input type="file" id="identifyFileInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoFile('identify',this)">
        <div class="camera-area" id="identifyArea" onclick="document.getElementById('identifyFileInput').click()"><div class="ca-icon">🍔</div><div class="ca-text">Photograph your food</div><div class="ca-sub">AI identifies and estimates calories</div></div>
        <img id="identifyPreview" style="display:none;width:100%;border-radius:10px;margin-bottom:8px;max-height:220px;object-fit:cover;" alt="Food photo">
        <div class="cam-controls" id="identifyControls" style="display:none;"><button class="btn" onclick="retakePhoto('identify')">Retake</button><button class="btn btn-diet" onclick="analysePhoto('identify')">Identify Food \u2192</button></div>
        <div class="thinking" id="identifyThinking"><div class="spinner"></div>AI identifying your food...</div>
        <div class="photo-result" id="identifyResult">
          <div class="photo-result-name" id="identifyName"></div>
          <div class="photo-result-macros" id="identifyMacros"></div>
          <select id="mealTypeIdentify" style="margin-bottom:8px;"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select>
          <button class="btn btn-diet btn-block" onclick="logPhotoFood('identify')">Add to Log</button>
        </div>
      </div>
      <!-- LABEL -->
      <div class="cam-panel" id="camPanel-label">
        <input type="file" id="labelFileInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoFile('label',this)">
        <div class="camera-area" id="labelArea" onclick="document.getElementById('labelFileInput').click()"><div class="ca-icon">📋</div><div class="ca-text">Photograph a nutrition label</div><div class="ca-sub">AI reads and extracts the data</div></div>
        <img id="labelPreview" style="display:none;width:100%;border-radius:10px;margin-bottom:8px;max-height:220px;object-fit:cover;" alt="Label photo">
        <div class="cam-controls" id="labelControls" style="display:none;"><button class="btn" onclick="retakePhoto('label')">Retake</button><button class="btn btn-diet" onclick="analysePhoto('label')">Extract Data \u2192</button></div>
        <div class="thinking" id="labelThinking"><div class="spinner"></div>AI reading nutrition label...</div>
        <div class="photo-result" id="labelResult">
          <div class="photo-result-name" id="labelName"></div>
          <div class="photo-result-macros" id="labelMacros"></div>
          <select id="mealTypeLabel" style="margin-bottom:8px;"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select>
          <button class="btn btn-diet btn-block" onclick="logPhotoFood('label')">Add to Log</button>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-panel" id="dietTab-recipe">
    <div class="food-input-card">
      <div class="fi-title">Build a Recipe</div>
      <div class="fi-sub">Add ingredients \u2014 AI calculates per-serving nutrition.</div>
      <input type="text" id="recipeName" placeholder="Recipe name" style="margin-bottom:8px;">
      <div class="section-label" style="margin-top:4px;">Ingredients</div>
      <div class="ingredient-list" id="ingredientList"></div>
      <button class="add-ingredient-btn" onclick="addIngredient()">+ Add Ingredient</button>
      <div class="servings-row"><label>Makes</label><input type="number" id="recipeServings" value="2" min="1" style="width:52px;"><label>serving(s)</label></div>
      <div class="meal-type-row"><select id="mealTypeRecipe"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select></div>
      <div class="thinking" id="recipeThinking"><div class="spinner"></div>AI calculating nutrition...</div>
      <button class="btn btn-diet btn-block" onclick="calcRecipe()">Calculate & Log One Serving</button>
    </div>
  </div>
  <div class="tab-panel" id="dietTab-history">
    <div id="mealLogList"></div>
    <div id="mealLogEmpty" style="text-align:center;padding:24px;color:var(--muted);font-size:12px;font-style:italic;">No meals logged today.</div>
    <button class="btn btn-block" style="margin-top:8px;" onclick="if(confirm('Clear today\\'s food log?')){clearFoodLog();}">Clear Today's Log</button>
  </div>
</div>

<!-- PROGRESS -->
<div class="view" id="view-progress">

  <div class="date-nav" id="progressDateNav">
    <button class="dn-arrow" id="progressNavPrev" onclick="shiftDateNav('progress',-1)">&#8249;</button>
    <span class="dn-label" id="progressNavLabel">This Month</span>
    <button class="dn-arrow" id="progressNavNext" onclick="shiftDateNav('progress',1)">&#8250;</button>
    <div class="dn-windows">
      <button class="dnw-btn" onclick="setDateWindow('progress','week',this)">Wk</button>
      <button class="dnw-btn active" onclick="setDateWindow('progress','month',this)">Mo</button>
      <button class="dnw-btn" onclick="setDateWindow('progress','3m',this)">3M</button>
      <button class="dnw-btn" onclick="setDateWindow('progress','6m',this)">6M</button>
      <button class="dnw-btn" onclick="setDateWindow('progress','1y',this)">1Y</button>
    </div>
  </div>
  <!-- Weekly volume summary -->
  <div class="section-label">Volume \u2014 This Week</div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:4px;" id="progressVolume"></div>

  <!-- TSS / load chart -->
  <div class="section-label">Training Load History</div>
  <div class="card" style="padding:12px;">
    <div style="display:flex;gap:16px;margin-bottom:10px;">
      <div><div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">CTL Fitness</div><div id="progCTL" style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--pull);">\u2014</div></div>
      <div><div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">ATL Fatigue</div><div id="progATL" style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--danger);">\u2014</div></div>
      <div><div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">TSB Form</div><div id="progTSB" style="font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--accent);">\u2014</div></div>
    </div>
    <svg id="progressLoadChart" style="width:100%;height:90px;display:block;"></svg>
  </div>

  <!-- Personal bests -->
  <div class="section-label">Personal Bests</div>
  <div id="pbGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:4px;"></div>

  <!-- Achievements -->
  <div class="section-label">Achievements</div>
  <div class="achievements-grid" id="achievementsGrid"></div>

  <!-- Full exercise history -->
  <div class="section-label">Activity Log</div>
  <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;" id="logFilterBtns">
    <button class="btn active" style="font-size:11px;padding:5px 12px;" onclick="filterLog('all',this)">All</button>
    <button class="btn" style="font-size:11px;padding:5px 12px;" onclick="filterLog('🚴 Cycling',this)">🚴 Ride</button>
    <button class="btn" style="font-size:11px;padding:5px 12px;" onclick="filterLog('🏃 Running',this)">🏃 Run</button>
    <button class="btn" style="font-size:11px;padding:5px 12px;" onclick="filterLog('🏊 Swimming',this)">🏊 Swim</button>
    <button class="btn" style="font-size:11px;padding:5px 12px;" onclick="filterLog('🏋\ufe0f Weights',this)">🏋\ufe0f Gym</button>
  </div>
  <div id="fullActivityLog"></div>
  <div id="fullActivityLogEmpty" style="text-align:center;padding:24px;color:var(--muted);font-size:12px;font-style:italic;display:none;">No activities yet.</div>
</div>

<!-- BODY -->
<div class="view" id="view-body">
  <div class="apple-health-banner"><div class="ah-icon">🍎</div><div class="ah-text"><div class="ht">Apple Health \u2014 iOS App Coming</div><div class="hs">Body comp, HRV, and resting HR will auto-sync when we launch the native app.</div></div></div>

  <!-- Weight targets -->
  <div class="card">
    <div class="card-title" style="color:var(--weight);">Weight Targets</div>
    <div class="wt-targets">
      <div class="wt-field"><label>Current</label><input class="wt-big-input" type="number" id="currentWeightInput" placeholder="82.0" step="0.1" oninput="updateToGo();savePrefs()"><div class="wt-unit">kg</div></div>
      <div class="wt-field"><label>Target</label><input class="wt-big-input" type="number" id="targetWeightInput" placeholder="78.0" step="0.1" oninput="updateToGo();savePrefs()"><div class="wt-unit">kg</div></div>
    </div>
    <div class="to-go" id="toGoSection" style="display:none;"><div class="tg-num" id="toGoNum">\u2014</div><div class="tg-label" id="toGoLabel">kg to goal</div></div>
  </div>

  <!-- Weekly weigh-in -->
  <div class="log-weight-card">
    <div class="card-title" style="color:var(--weight);">Weekly Check-In</div>
    <div class="lw-row">
      <div class="lw-field"><label>Weight</label><input class="wt-big-input" type="number" id="logWeightInput" placeholder="82.0" step="0.1"></div>
      <div style="padding-bottom:4px;color:var(--muted);font-size:13px;flex-shrink:0;">kg</div>
      <button class="btn btn-weight" style="align-self:flex-end;flex-shrink:0;" onclick="logWeight()">Log</button>
    </div>
  </div>

  <!-- Body measurements -->
  <div class="card">
    <div class="card-title" style="color:var(--weight);">Measurements <span style="font-size:10px;font-weight:300;font-family:'DM Sans';color:var(--muted);">optional \u00b7 monthly</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
      <div><label style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px;">Chest (cm)</label><input type="number" id="measChest" placeholder="95" step="0.5"></div>
      <div><label style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px;">Waist (cm)</label><input type="number" id="measWaist" placeholder="82" step="0.5"></div>
      <div><label style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px;">Hips (cm)</label><input type="number" id="measHips" placeholder="96" step="0.5"></div>
      <div><label style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px;">Thigh (cm)</label><input type="number" id="measThigh" placeholder="58" step="0.5"></div>
    </div>
    <button class="btn btn-block" style="color:var(--weight);border-color:var(--weight);" onclick="logMeasurements()">Save Measurements</button>
    <div id="lastMeasurements" style="margin-top:10px;font-size:11px;color:var(--muted);"></div>
  </div>

  <!-- Weight chart -->
  <div class="chart-card">
    <div class="chart-header"><span class="chart-title">Weight Trend</span></div>
    <div class="chart-empty" id="chartEmpty">Log at least 2 weigh-ins to see your chart.</div>
    <svg class="wt-chart" id="weightChart" style="display:none;"></svg>
  </div>

  <!-- Goal projection -->
  <div class="goal-projection" id="goalProjection" style="display:none;">
    <div class="gp-title">📈 On Track?</div>
    <div id="gpRows"></div>
  </div>

  <!-- Weigh-in history -->
  <div class="card">
    <div class="card-title" style="color:var(--weight);">Weigh-In History</div>
    <div id="weightLogList"><div style="text-align:center;padding:14px;color:var(--muted);font-size:12px;font-style:italic;">No weigh-ins logged yet.</div></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="view" id="view-settings">
  <div class="section-label">Appearance</div>
  <div class="settings-section">
    <div class="settings-section-title">AI</div>
    <div class="settings-row">
      <div><div class="sr-label">Anthropic API Key</div><div class="sr-sub">Required for food estimation &amp; camera features</div></div>
    </div>
    <div style="padding:0 16px 16px;">
      <input type="password" id="anthropicKeyInput" placeholder="sk-ant-..." style="width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:13px;box-sizing:border-box;" oninput="saveApiKey()">
      <div id="apiKeyStatus" style="font-size:11px;color:var(--muted);margin-top:6px;">Not set \u2014 AI features disabled</div>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title">Theme</div>
    <div class="settings-row">
      <div><div class="sr-label">Colour Mode</div><div class="sr-sub">Dark or light interface</div></div>
      <div class="theme-btns">
        <div class="theme-btn active" id="themeDark" onclick="setTheme('dark')">Dark</div>
        <div class="theme-btn" id="themeLight" onclick="setTheme('light')">Light</div>
        <div class="theme-btn" id="themeAuto" onclick="setTheme('auto')">Auto</div>
      </div>
    </div>
  </div>
  <div class="section-label">Nutrition</div>
  <div class="settings-section">
    <div class="settings-section-title">Daily Targets</div>
    <div class="settings-row">
      <div><div class="sr-label">Calorie Goal</div><div class="sr-sub">Your daily intake target</div></div>
      <input class="settings-num" type="number" id="settingsCalGoal" value="2000" onchange="syncCalGoalFromSettings()">
    </div>
    <div class="settings-row">
      <div><div class="sr-label">Protein Goal</div><div class="sr-sub">Target grams per day</div></div>
      <input class="settings-num" type="number" id="settingsProteinGoal" value="150" style="color:var(--full);" onchange="savePrefs()">
    </div>
  </div>
  <div class="section-label">Account</div>
  <div class="settings-section">
    <div class="settings-section-title">Profile</div>
    <div class="settings-row">
      <div><div class="sr-label">Signed in as</div><div class="sr-sub" id="settingsEmail">\u2014</div></div>
    </div>
    <div class="settings-row">
      <div><div class="sr-label">Export Data</div><div class="sr-sub">Download all data as CSV</div></div>
      <button class="btn" onclick="exportData()" style="flex-shrink:0;">Export</button>
    </div>
    <div class="settings-row">
      <div><div class="sr-label" style="color:var(--danger);">Redo Onboarding</div><div class="sr-sub">Recalculate your AI plan</div></div>
      <button class="btn" style="flex-shrink:0;color:var(--danger);border-color:var(--danger);" onclick="redoOnboarding()">Redo</button>
    </div>
    <div class="settings-row">
      <div><div class="sr-label" style="color:var(--danger);">Sign Out</div></div>
      <button class="btn" style="flex-shrink:0;color:var(--danger);border-color:var(--danger);" onclick="doSignOut()">Sign Out</button>
    </div>
  </div>
  <div style="text-align:center;padding:20px;font-size:10px;color:var(--muted);">LIFT v3.2 \u00b7 Built with \u2764\ufe0f</div>
</div>

</main>

<script>
const SUPA_URL='https://xswragxhltdsrlqigkwx.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzd3JhZ3hobHRkc3JscWlna3d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzMxOTEsImV4cCI6MjA4NzAwOTE5MX0.aHlixcwUSAwoFPV9ro19hFB5L89lfhiXkvNu9b-jXhI';
let sb=null;
try { sb=supabase.createClient(SUPA_URL,SUPA_KEY); }
catch(e) { console.error('Supabase init failed \u2014 check internet connection',e); }
let currentUser=null;
let state={foodLog:[],weightLog:[],exerciseLog:[],prefs:{cal_goal:2000,water:0,current_weight:'',target_weight:''},foodHistory:[],exerciseHistory:[]};

function togglePw(id,btn){const input=document.getElementById(id);const show=input.type==='password';input.type=show?'text':'password';btn.style.opacity=show?'1':'0.4';}

// AUTH
function showLogin(){document.getElementById('loginCard').style.display='block';document.getElementById('registerCard').style.display='none';}
function showRegister(){document.getElementById('loginCard').style.display='none';document.getElementById('registerCard').style.display='block';}
async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim(),pass=document.getElementById('loginPassword').value;
  const errEl=document.getElementById('loginError');errEl.classList.remove('show');
  if(!email||!pass){errEl.textContent='Enter email and password';errEl.classList.add('show');return;}
  const btn=document.getElementById('loginBtn'),spin=document.getElementById('loginSpinner');
  btn.disabled=true;spin.classList.add('show');
  errEl.textContent='Connecting to Supabase...';errEl.classList.add('show');
  const unlock=()=>{btn.disabled=false;spin.classList.remove('show');};
  try{
    // Test basic connectivity first
    errEl.textContent='Step 1: Checking Supabase reachable...';
    const pingTest=await fetch('https://xswragxhltdsrlqigkwx.supabase.co/auth/v1/settings',{method:'GET'}).catch(e=>({ok:false,_err:e.message}));
    errEl.textContent='Step 1 done: '+(pingTest.ok?'reachable ('+pingTest.status+')':'FAILED - '+pingTest._err);
    await new Promise(r=>setTimeout(r,1500));

    errEl.textContent='Step 2: Attempting sign in...';
    const authPromise=sb.auth.signInWithPassword({email,password:pass});
    const timeout=new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timed out after 10s - Supabase not responding')),10000));
    const result=await Promise.race([authPromise,timeout]);
    unlock();
    errEl.textContent='Step 2 result: '+JSON.stringify({error:result.error?.message,hasUser:!!result.data?.user,status:result.error?.status});
    errEl.classList.add('show');
    await new Promise(r=>setTimeout(r,2000));
    if(result.error){errEl.textContent='Error: '+result.error.message+' ('+result.error.status+')';return;}
    errEl.classList.remove('show');
    onSignedIn(result.data.user);
  }catch(e){
    unlock();
    errEl.textContent='CAUGHT: '+e.message;
    errEl.classList.add('show');
  }
}
async function doRegister(){
  const email=document.getElementById('regEmail').value.trim(),pass=document.getElementById('regPassword').value,pass2=document.getElementById('regPassword2').value;
  const errEl=document.getElementById('registerError');errEl.classList.remove('show');
  if(!email||!pass){errEl.textContent='Fill in all fields';errEl.classList.add('show');return;}
  if(pass!==pass2){errEl.textContent='Passwords do not match';errEl.classList.add('show');return;}
  if(pass.length<6){errEl.textContent='Password must be 6+ characters';errEl.classList.add('show');return;}
  const btn=document.getElementById('registerBtn'),spin=document.getElementById('registerSpinner');
  btn.disabled=true;spin.classList.add('show');
  const unlock=()=>{btn.disabled=false;spin.classList.remove('show');};
  try{
    const authPromise=sb.auth.signUp({email,password:pass});
    const timeout=new Promise((_,rej)=>setTimeout(()=>rej(new Error('Connection timed out. Check your internet and try again.')),10000));
    const{data,error}=await Promise.race([authPromise,timeout]);
    unlock();
    if(error){errEl.textContent=error.message;errEl.classList.add('show');return;}
    if(data.user)onSignedIn(data.user);
    else{errEl.textContent='Check your email to confirm your account, then sign in.';errEl.classList.add('show');}
  }catch(e){
    unlock();
    errEl.textContent=e.message||'Registration failed. Check your connection.';
    errEl.classList.add('show');
  }
}
async function doSignOut(){await sb.auth.signOut();currentUser=null;document.body.classList.remove('authed');document.getElementById('splashCover').style.display='none';document.getElementById('authScreen').classList.remove('hidden');document.getElementById('userDropdown').classList.remove('show');}
function toggleUserMenu(){document.getElementById('userDropdown').classList.toggle('show');}
document.addEventListener('click',e=>{if(!e.target.closest('.user-menu'))document.getElementById('userDropdown').classList.remove('show');});
async function onSignedIn(user){
  currentUser=user;
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('userAvatar').textContent=user.email.slice(0,2).toUpperCase();
  document.getElementById('udEmail').textContent=user.email;

  // Safety net \u2014 splash ALWAYS hides within 5 seconds no matter what
  const splashTimeout=setTimeout(()=>{
    document.getElementById('splashCover').style.display='none';
    document.body.classList.add('authed');
  },5000);

  try{
    // Race profile check against 4s timeout
    const profilePromise=sb.from('user_profile').select('onboarded').eq('user_id',user.id).single();
    const timeoutPromise=new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),4000));
    let profile=null;
    try{const res=await Promise.race([profilePromise,timeoutPromise]);profile=res.data;}catch(e){profile=null;}

    clearTimeout(splashTimeout);
    document.getElementById('splashCover').style.display='none';

    if(!profile||!profile.onboarded){
      startOnboarding();
    } else {
      document.body.classList.add('authed');
      loadAllData();
      showInstallPrompt();
    }
  }catch(e){
    clearTimeout(splashTimeout);
    console.error('onSignedIn error:',e);
    document.getElementById('splashCover').style.display='none';
    document.body.classList.add('authed');
    loadAllData();
  }
}

// ONBOARDING
const OB_STEPS=6;
let obData={goals:[],experience:'',activity:'',age:'',sex:'',dietaryPrefs:[],currentWeight:'',targetWeight:''};
let obStep=1;
const GOALS=[
  {id:'weight_loss',icon:'\u2696\ufe0f',label:'Weight Loss',sub:'Lose fat, improve body composition'},
  {id:'strength',icon:'💪',label:'Build Strength',sub:'Get stronger, add muscle mass'},
  {id:'fitness',icon:'🏃',label:'Fitness & Endurance',sub:'Cardio, stamina, performance'},
  {id:'health',icon:'\u2764\ufe0f',label:'General Health',sub:'Feel better, live healthier'},
  {id:'sport',icon:'🚴',label:'Sport Performance',sub:'Train for cycling, running, etc.'},
  {id:'tone',icon:'\u2728',label:'Tone & Shape',sub:'Lean, defined physique'},
  {id:'flexibility',icon:'🧘',label:'Flexibility',sub:'Mobility, movement quality'},
];
const DIET_PREFS=['No restrictions','Vegetarian','Vegan','Gluten-free','Dairy-free','Low carb','High protein','Halal','Kosher'];
const ACTIVITY_OPTS=[
  {id:'sedentary',label:'Mostly sedentary',sub:'Desk job, little movement outside gym'},
  {id:'light',label:'Lightly active',sub:'Some walking, occasional sport'},
  {id:'moderate',label:'Moderately active',sub:'Regular cycling, running or sport'},
  {id:'very',label:'Very active',sub:'Training daily, physical job'},
];
const EXP_OPTS=[
  {id:'beginner',label:'Beginner',sub:'New to structured training'},
  {id:'intermediate',label:'Intermediate',sub:'1\u20133 years consistent training'},
  {id:'advanced',label:'Advanced',sub:'3+ years, solid technique'},
];
function startOnboarding(){obStep=1;obData={goals:[],experience:'',activity:'',age:'',sex:'',dietaryPrefs:[],currentWeight:'',targetWeight:''};document.getElementById('onboardScreen').classList.add('show');renderObStep();}
function renderObStep(){
  const dots=document.getElementById('obStepDots');
  dots.innerHTML=Array.from({length:OB_STEPS},(_,i)=>`<div class="ob-step-dot ${i+1<obStep?'done':i+1===obStep?'active':''}"></div>`).join('');
  document.getElementById('obStepLabel').textContent=`Step ${obStep} of ${OB_STEPS}`;
  const body=document.getElementById('obBody');
  if(obStep===1){
    body.innerHTML=`<div class="ob-question">What are your goals?</div><div class="ob-sub">Select everything that applies \u2014 we'll build your plan around these.</div><div class="ob-chips">${GOALS.map(g=>`<div class="ob-chip ${obData.goals.includes(g.id)?'selected':''}" onclick="toggleGoal('${g.id}',this)">${g.icon} ${g.label}</div>`).join('')}</div><div class="ob-nav"><button class="ob-next" onclick="obNext()">Continue \u2192</button></div>`;
  } else if(obStep===2){
    body.innerHTML=`<div class="ob-question">Your experience level?</div><div class="ob-sub">This shapes the intensity and structure of your sessions.</div><div class="ob-options">${EXP_OPTS.map(e=>`<div class="ob-option ${obData.experience===e.id?'selected':''}" onclick="selectSingle('experience','${e.id}',this)"><div><div class="ob-opt-label">${e.label}</div><div class="ob-opt-sub">${e.sub}</div></div><div class="ob-opt-check">\u2713</div></div>`).join('')}</div><div class="ob-nav"><button class="ob-back" onclick="obBack()">\u2190</button><button class="ob-next" onclick="obNext()">Continue \u2192</button></div>`;
  } else if(obStep===3){
    body.innerHTML=`<div class="ob-question">Activity outside the gym?</div><div class="ob-sub">Your daily movement affects your calorie needs significantly.</div><div class="ob-options">${ACTIVITY_OPTS.map(a=>`<div class="ob-option ${obData.activity===a.id?'selected':''}" onclick="selectSingle('activity','${a.id}',this)"><div><div class="ob-opt-label">${a.label}</div><div class="ob-opt-sub">${a.sub}</div></div><div class="ob-opt-check">\u2713</div></div>`).join('')}</div><div class="ob-nav"><button class="ob-back" onclick="obBack()">\u2190</button><button class="ob-next" onclick="obNext()">Continue \u2192</button></div>`;
  } else if(obStep===4){
    body.innerHTML=`<div class="ob-question">About you</div><div class="ob-sub">Helps us calculate accurate calorie targets and personalise your plan.</div><div class="ob-fields"><div class="ob-two-col"><div class="ob-field"><label>Age</label><input type="number" id="obAge" placeholder="32" value="${obData.age}" min="16" max="99"></div><div class="ob-field"><label>Biological Sex</label><select id="obSex"><option value="" ${!obData.sex?'selected':''}>Select</option><option value="male" ${obData.sex==='male'?'selected':''}>Male</option><option value="female" ${obData.sex==='female'?'selected':''}>Female</option></select></div></div><div class="ob-two-col"><div class="ob-field"><label>Current Weight (kg)</label><input type="number" id="obCW" placeholder="82" step="0.1" value="${obData.currentWeight}"></div><div class="ob-field"><label>Target Weight (kg)</label><input type="number" id="obTW" placeholder="78" step="0.1" value="${obData.targetWeight}"></div></div></div><div class="ob-nav"><button class="ob-back" onclick="obBack()">\u2190</button><button class="ob-next" onclick="obNext()">Continue \u2192</button></div>`;
  } else if(obStep===5){
    body.innerHTML=`<div class="ob-question">Dietary preferences?</div><div class="ob-sub">We'll factor these into your nutrition guidance.</div><div class="ob-chips">${DIET_PREFS.map(d=>`<div class="ob-chip ${obData.dietaryPrefs.includes(d)?'selected':''}" onclick="toggleDiet('${d}',this)">${d}</div>`).join('')}</div><div class="ob-nav"><button class="ob-back" onclick="obBack()">\u2190</button><button class="ob-next" onclick="obNext()">Generate My Plan \u2192</button></div>`;
  } else if(obStep===6){
    body.innerHTML=`<div class="ob-generating"><div class="ob-gen-icon">🤖</div><div class="ob-gen-title">Building Your Plan</div><div class="ob-gen-sub">Claude is analysing your goals and creating a personalised programme just for you.</div><div class="ob-gen-steps"><div class="ob-gen-step active" id="gs1"><span class="gs-icon">\u2699\ufe0f</span>Calculating your calorie targets...</div><div class="ob-gen-step" id="gs2"><span class="gs-icon">🏋\ufe0f</span>Tailoring your workout sessions...</div><div class="ob-gen-step" id="gs3"><span class="gs-icon">🥗</span>Setting up your nutrition plan...</div><div class="ob-gen-step" id="gs4"><span class="gs-icon">\u2705</span>Finalising your personalised plan...</div></div></div>`;
    generatePlan();
  }
}
function toggleGoal(id,el){if(obData.goals.includes(id)){obData.goals=obData.goals.filter(g=>g!==id);el.classList.remove('selected');}else{obData.goals.push(id);el.classList.add('selected');}}
function selectSingle(field,id,el){obData[field]=id;document.querySelectorAll('#obBody .ob-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected');}
function toggleDiet(d,el){if(obData.dietaryPrefs.includes(d)){obData.dietaryPrefs=obData.dietaryPrefs.filter(x=>x!==d);el.classList.remove('selected');}else{obData.dietaryPrefs.push(d);el.classList.add('selected');}}
function obNext(){
  if(obStep===1&&obData.goals.length===0){alert('Please select at least one goal');return;}
  if(obStep===2&&!obData.experience){alert('Please select your experience level');return;}
  if(obStep===3&&!obData.activity){alert('Please select your activity level');return;}
  if(obStep===4){obData.age=document.getElementById('obAge').value;obData.sex=document.getElementById('obSex').value;obData.currentWeight=document.getElementById('obCW').value;obData.targetWeight=document.getElementById('obTW').value;if(!obData.age||!obData.sex){alert('Please enter your age and select biological sex');return;}}
  obStep++;renderObStep();
}
function obBack(){obStep=Math.max(1,obStep-1);renderObStep();}
async function generatePlan(){
  const goalLabels=obData.goals.map(id=>GOALS.find(g=>g.id===id)?.label).join(', ');
  const prompt=`You are a world-class personal trainer and nutritionist. Create a personalised fitness and nutrition plan:
Goals: ${goalLabels||'General fitness'}
Experience: ${obData.experience}, Activity outside gym: ${obData.activity}
Age: ${obData.age||'unknown'}, Sex: ${obData.sex||'unknown'}
Current weight: ${obData.currentWeight||'unknown'}kg, Target: ${obData.targetWeight||'unknown'}kg
Diet: ${obData.dietaryPrefs.join(', ')||'No restrictions'}
They follow a 3x weekly weights programme (Push/Pull/Full Body) plus cycling and running.
Respond ONLY valid JSON no markdown:
{"calorie_goal":number,"protein_goal_g":number,"welcome_message":"2-3 sentence warm motivating welcome addressing their specific goals","key_tips":["tip 1 specific to goals","tip 2","tip 3","tip 4"],"calorie_rationale":"1 sentence explaining calorie target"}`;
  try{
    const delay=ms=>new Promise(r=>setTimeout(r,ms));
    delay(900).then(()=>{const s=document.getElementById('gs1');if(s){s.classList.remove('active');s.classList.add('done');s.querySelector('.gs-icon').textContent='\u2705';}const s2=document.getElementById('gs2');if(s2)s2.classList.add('active');});
    delay(1800).then(()=>{const s=document.getElementById('gs2');if(s){s.classList.remove('active');s.classList.add('done');s.querySelector('.gs-icon').textContent='\u2705';}const s3=document.getElementById('gs3');if(s3)s3.classList.add('active');});
    delay(2700).then(()=>{const s=document.getElementById('gs3');if(s){s.classList.remove('active');s.classList.add('done');s.querySelector('.gs-icon').textContent='\u2705';}const s4=document.getElementById('gs4');if(s4)s4.classList.add('active');});
    const raw=await callClaude(prompt);
    const plan=JSON.parse(raw.replace(/```json|```/g,'').trim());
    await sb.from('user_profile').upsert({user_id:currentUser.id,goals:obData.goals,experience:obData.experience,activity_level:obData.activity,age:parseInt(obData.age)||null,sex:obData.sex,dietary_prefs:obData.dietaryPrefs,current_weight:parseFloat(obData.currentWeight)||null,target_weight:parseFloat(obData.targetWeight)||null,ai_plan:JSON.stringify(plan),ai_calorie_goal:plan.calorie_goal,onboarded:true},{onConflict:'user_id'});
    await sb.from('user_prefs').upsert({user_id:currentUser.id,cal_goal:plan.calorie_goal,water:0,current_weight:obData.currentWeight||null,target_weight:obData.targetWeight||null,updated_at:new Date().toISOString()},{onConflict:'user_id'});
    state.prefs={...state.prefs,cal_goal:plan.calorie_goal,current_weight:obData.currentWeight,target_weight:obData.targetWeight};
    ['gs1','gs2','gs3','gs4'].forEach(id=>{const s=document.getElementById(id);if(s){s.classList.remove('active');s.classList.add('done');s.querySelector('.gs-icon').textContent='\u2705';}});
    setTimeout(()=>showPlanResult(plan),600);
  }catch(e){
    await sb.from('user_profile').upsert({user_id:currentUser.id,goals:obData.goals,experience:obData.experience,activity_level:obData.activity,age:parseInt(obData.age)||null,sex:obData.sex,dietary_prefs:obData.dietaryPrefs,current_weight:parseFloat(obData.currentWeight)||null,target_weight:parseFloat(obData.targetWeight)||null,onboarded:true},{onConflict:'user_id'});
    finishOnboarding();
  }
}
function showPlanResult(plan){
  document.getElementById('obStepLabel').textContent='Your personalised plan';
  document.getElementById('obStepDots').innerHTML=Array.from({length:OB_STEPS},()=>`<div class="ob-step-dot done"></div>`).join('');
  document.getElementById('obBody').innerHTML=`
    <div class="ob-plan-card"><div class="ob-plan-title">Your Plan Is Ready 🎯</div><div class="ob-plan-text">${plan.welcome_message}</div></div>
    <div class="ob-plan-card">
      <div class="ob-plan-title">Daily Targets</div>
      <div class="ob-plan-stat"><span class="ob-plan-stat-icon">🔥</span><div><div class="ob-plan-stat-label">Calorie Goal</div><div class="ob-plan-stat-val">${plan.calorie_goal} kcal</div></div></div>
      <div class="ob-plan-stat"><span class="ob-plan-stat-icon">🥩</span><div><div class="ob-plan-stat-label">Protein Target</div><div class="ob-plan-stat-val">${plan.protein_goal_g}g / day</div></div></div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px;font-style:italic;">${plan.calorie_rationale}</div>
    </div>
    <div class="ob-plan-card">
      <div class="ob-plan-title">Key Focus Areas</div>
      ${(plan.key_tips||[]).map(t=>`<div style="display:flex;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted2);line-height:1.4;"><span style="color:var(--accent);flex-shrink:0;margin-top:1px;">\u2192</span>${t}</div>`).join('')}
    </div>
    <div class="ob-nav" style="margin-top:4px;"><button class="ob-next" onclick="finishOnboarding()">Start Training 🚀</button></div>`;
}
function finishOnboarding(){document.getElementById('onboardScreen').classList.remove('show');document.body.classList.add('authed');applyPrefs();loadAllData();showInstallPrompt();}


function setSyncStatus(s){
  const dot=document.getElementById('syncDot'),txt=document.getElementById('syncStatus');
  dot.className='sync-dot'+(s==='syncing'?' syncing':s==='error'?' error':'');
  txt.textContent=s==='syncing'?'Syncing...':s==='error'?'Sync error':'Synced \u2713';
}

// DATA
const todayKey=()=>new Date().toISOString().slice(0,10);
async function loadAllData(){
  setSyncStatus('syncing');
  try{
    const today=todayKey();
    // Load each table independently so one failure doesn't block everything
    const safe=p=>p.catch(()=>({data:null}));
    const[food,weight,exercise,prefs,foodHistory,exerciseHistory]=await Promise.all([
      safe(sb.from('food_log').select('*').eq('user_id',currentUser.id).eq('date',today).order('created_at')),
      safe(sb.from('weight_log').select('*').eq('user_id',currentUser.id).order('date')),
      safe(sb.from('exercise_log').select('*').eq('user_id',currentUser.id).eq('date',today).order('created_at')),
      safe(sb.from('user_prefs').select('*').eq('user_id',currentUser.id).single()),
      safe(sb.from('food_log').select('date').eq('user_id',currentUser.id).order('date',{ascending:false}).limit(200)),
      safe(sb.from('exercise_log').select('date').eq('user_id',currentUser.id).order('date',{ascending:false}).limit(200)),
    ]);
    state.foodLog=food.data||[];
    state.weightLog=weight.data||[];
    state.exerciseLog=exercise.data||[];
    state.foodHistory=[...new Set((foodHistory.data||[]).map(r=>r.date))];
    state.exerciseHistory=[...new Set((exerciseHistory.data||[]).map(r=>r.date))];
    if(prefs.data){state.prefs={...state.prefs,...prefs.data};
    // Load API key from Supabase into memory (never stored in source)
    if(prefs.data.anthropic_key){ANTHROPIC_KEY=prefs.data.anthropic_key;localStorage.setItem('lift_anthropic_key',prefs.data.anthropic_key);}
  }
    setSyncStatus('ok');
    applyPrefs();updateDashboard();renderFoodLog();renderExerciseLog();renderWeightLog();initWater();updateStreaksAndAchievements();initStrava();loadApiKeyUI();
    renderFavourites();
    loadAllExerciseHistory().then(()=>updateTrainingLoad());
    refreshDateNav('fuel');refreshDateNav('progress');
  }catch(e){
    console.error('loadAllData error:',e);
    setSyncStatus('error');
    // Still render the UI even if data failed
    try{applyPrefs();updateDashboard();renderFoodLog();}catch(e2){}
  }
}
function applyPrefs(){
  document.getElementById('calGoalInput').value=state.prefs.cal_goal||2000;
  if(state.prefs.current_weight)document.getElementById('currentWeightInput').value=state.prefs.current_weight;
  if(state.prefs.target_weight)document.getElementById('targetWeightInput').value=state.prefs.target_weight;
  updateGoalBar();updateToGo();
}
async function savePrefs(){
  if(!currentUser)return;
  const p={user_id:currentUser.id,cal_goal:parseInt(document.getElementById('calGoalInput').value)||2000,water:state.prefs.water||0,current_weight:document.getElementById('currentWeightInput').value||null,target_weight:document.getElementById('targetWeightInput').value||null,updated_at:new Date().toISOString()};
  state.prefs={...state.prefs,...p};
  await sb.from('user_prefs').upsert(p,{onConflict:'user_id'});
  updateGoalBar();updateOverview();
}

// NAV init
(function(){
  const now=new Date();
  const day=now.toLocaleDateString('en-GB',{weekday:'short'}).toUpperCase();
  const date=now.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
  const el=document.getElementById('todayDate');
  const dl=document.getElementById('todayDay');
  if(el)el.textContent=date;
  if(dl)dl.textContent=day;
})();
// Training rotation based on user's join date (loaded after sign in)
function renderWeekSched(){}
function showView(v){
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById('view-'+v);
  if(el)el.classList.add('active');
  const navItems=['dashboard','train','fuel','body','progress','settings'];
  const idx=navItems.indexOf(v);
  if(idx>=0&&document.querySelectorAll('.nb')[idx])document.querySelectorAll('.nb')[idx].classList.add('active');
  if(v==='fuel'){renderFoodLog();updateDietSummary();updateGoalBar();updateFuelDay();}
  if(v==='body'){renderWeightLog();}
  if(v==='train')renderExerciseLog();
  if(v==='progress'){renderProgressView();}
  if(v==='dashboard')updateDashboard();
  if(v==='settings'){
    const e=currentUser?.email||'\u2014';
    document.getElementById('settingsEmail').textContent=e;
    const cal=state.prefs.cal_goal||2000;
    document.getElementById('settingsCalGoal').value=cal;
    const t=localStorage.getItem('lift_theme')||'dark';
    document.getElementById('themeDark').classList.toggle('active',t==='dark');
    document.getElementById('themeLight').classList.toggle('active',t==='light');
  }
  updateDashboard();
}

// \u2550\u2550 DASHBOARD \u2550\u2550
function updateDashboard(){
  const cals=state.foodLog.reduce((a,f)=>a+(f.cals||0),0);
  const burned=state.exerciseLog.reduce((a,e)=>a+(e.cals||0),0);
  const net=cals-burned;

  // Net cals
  const netEl=document.getElementById('dashNetCals');
  if(netEl)netEl.textContent=cals>0||burned>0?net:'\u2014';

  // Determine today's sport from exercise log
  const todayTypes=state.exerciseLog.map(e=>e.type||'');
  let todaySport='Rest Day',todayReadiness='Recovery & fuelling day';
  if(todayTypes.some(t=>t.includes('Cycling'))){todaySport='🚴 Ride Day';todayReadiness='High carbs \u00b7 Electrolytes \u00b7 Pre-load';}
  else if(todayTypes.some(t=>t.includes('Running'))){todaySport='🏃 Run Day';todayReadiness='Moderate carbs \u00b7 Post-run protein';}
  else if(todayTypes.some(t=>t.includes('Swimming'))){todaySport='🏊 Swim Day';todayReadiness='Moderate carbs \u00b7 Protein \u00b7 Hydration';}
  else if(todayTypes.some(t=>t.includes('Weights'))){todaySport='🏋\ufe0f Gym Day';todayReadiness='Protein focus \u00b7 Moderate carbs';}
  const sportEl=document.getElementById('dashSportTag');
  const readEl=document.getElementById('dashReadiness');
  if(sportEl)sportEl.textContent=todaySport;
  if(readEl)readEl.textContent=todayReadiness;

  // Quick stats row
  const qs=document.getElementById('dashQuickStats');
  if(qs){
    const wt=state.weightLog.length?state.weightLog[state.weightLog.length-1].weight+'kg':'\u2014';
    const water=state.prefs.water||0;
    qs.innerHTML=`
      <div class="dash-quick-stat" onclick="showView('fuel')"><div class="dqs-val" style="color:var(--diet)">${cals}</div><div class="dqs-lbl">kcal eaten</div></div>
      <div class="dash-quick-stat" onclick="showView('train')"><div class="dqs-val" style="color:var(--exlog)">${burned}</div><div class="dqs-lbl">kcal burned</div></div>
      <div class="dash-quick-stat" onclick="showView('body')"><div class="dqs-val" style="color:var(--weight)">${wt}</div><div class="dqs-lbl">weight</div></div>
      <div class="dash-quick-stat" onclick="showView('fuel')"><div class="dqs-val" style="color:var(--blue)">${water}/8</div><div class="dqs-lbl">water</div></div>`;
  }

  // Weekly volume by sport
  renderWeekVolume('weekVolume');

  // Training load (TSS-style)
  updateTrainingLoad();

  // Race countdown
  updateRaceCountdown();
}

function renderWeekVolume(containerId){
  const el=document.getElementById(containerId);
  if(!el)return;
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay()+1);weekStart.setHours(0,0,0,0);
  const weekLogs=state.exerciseLog.filter(e=>e.date>=weekStart.toISOString().slice(0,10));
  const sports=[
    {key:'🚴 Cycling',label:'Ride',icon:'🚴',unit:'km',color:'var(--exlog)',metric:e=>e.distance||0},
    {key:'🏃 Running',label:'Run',icon:'🏃',unit:'km',color:'var(--pull)',metric:e=>e.distance||0},
    {key:'🏊 Swimming',label:'Swim',icon:'🏊',unit:'km',color:'var(--blue)',metric:e=>e.distance||0},
    {key:'🏋\ufe0f Weights',label:'Gym',icon:'🏋\ufe0f',unit:'min',color:'var(--push)',metric:e=>e.duration||0},
  ];
  el.innerHTML=sports.map(s=>{
    const entries=weekLogs.filter(e=>e.type&&e.type.includes(s.label.includes('Ride')?'Cycl':s.label.includes('Run')?'Runn':s.label.includes('Swim')?'Swim':'Weight'));
    const total=entries.reduce((a,e)=>a+s.metric(e),0);
    return`<div class="vol-box" onclick="showView('train')">
      <div class="vb-icon">${s.icon}</div>
      <div class="vb-val" style="color:${s.color}">${total>0?total.toFixed(total<10?1:0):0}</div>
      <div class="vb-lbl">${s.unit} ${s.label}</div>
    </div>`;
  }).join('');
}

function calcTSS(entry){
  // Simplified TSS: duration \u00d7 effort multiplier
  const dur=parseInt(entry.duration)||0;
  const effortMap={'Easy':0.3,'Moderate':0.55,'Hard':0.8,'Max':1.0};
  const ef=effortMap[entry.effort]||0.5;
  // Distance bonus for endurance sports
  const distBonus=entry.distance?(entry.distance*0.5):0;
  return Math.round((dur*ef)+distBonus);
}

function updateTrainingLoad(){
  // Merge all exercise history
  const allLogs=[...state.exerciseLog,...(state.allExerciseLog||[])];
  const tssMap={};
  allLogs.forEach(e=>{if(e.date)tssMap[e.date]=(tssMap[e.date]||0)+calcTSS(e);});

  // CTL = 42-day EWA, ATL = 7-day EWA — with 42-day preload for accuracy
  const today=new Date();
  const totalDays=84; // 42 preload + 42 display
  const days=[];
  for(let i=totalDays-1;i>=0;i--){
    const dd=new Date(today);dd.setDate(dd.getDate()-i);
    days.push(dd.toISOString().slice(0,10));
  }

  let ctl=0,atl=0;
  const ctlPoints=[],atlPoints=[];
  days.forEach((day,idx)=>{
    const tss=tssMap[day]||0;
    ctl=ctl+(tss-ctl)*(1/42);
    atl=atl+(tss-atl)*(1/7);
    if(idx>=42){ctlPoints.push(Math.round(ctl));atlPoints.push(Math.round(atl));}
  });
  const tsb=Math.round(ctl-atl);

  // Update metric displays
  ['CTL','ATL','TSB'].forEach((id,i)=>{
    const val=[Math.round(ctl),Math.round(atl),tsb][i];
    ['dash','prog'].forEach(pfx=>{
      const el=document.getElementById(pfx+id);
      if(el)el.textContent=val;
    });
  });

  // ── INSIGHTS ENGINE ──
  renderTrainingInsight(Math.round(ctl),Math.round(atl),tsb,ctlPoints);

  // Draw sparkline
  drawLoadChart('loadChart',ctlPoints,atlPoints);
  drawLoadChart('progressLoadChart',ctlPoints,atlPoints);
}

function renderTrainingInsight(ctl,atl,tsb,ctlPoints){
  const card=document.getElementById('trainingInsightCard');
  const emoji=document.getElementById('insightEmoji');
  const status=document.getElementById('insightStatus');
  const headline=document.getElementById('insightHeadline');
  const detail=document.getElementById('insightDetail');
  const trendEl=document.getElementById('insightTrend');
  const recBox=document.getElementById('insightRec');
  const recText=document.getElementById('insightRecText');
  if(!card)return;

  // No data state
  if(ctl<1){
    card.className='insight-card insight-nodata';
    if(emoji)emoji.textContent='📊';
    if(status)status.textContent='NO DATA YET';
    if(headline)headline.textContent='Start logging sessions';
    if(detail)detail.textContent='Log your first training session to see personalised load guidance here.';
    if(trendEl)trendEl.style.display='none';
    if(recBox)recBox.style.display='none';
    return;
  }

  // Trend: compare last 7-day avg CTL vs prior 7-day
  let trendText='',trendDir='';
  if(ctlPoints.length>=14){
    const recent=ctlPoints.slice(-7).reduce((a,b)=>a+b,0)/7;
    const prior=ctlPoints.slice(-14,-7).reduce((a,b)=>a+b,0)/7;
    const delta=recent-prior;
    if(delta>1.5){trendDir='\u2197';trendText='Fitness rising +'+Math.round(delta);}
    else if(delta<-1.5){trendDir='\u2198';trendText='Fitness declining '+Math.round(delta);}
    else{trendDir='\u2192';trendText='Fitness stable';}
  }

  // Determine state
  let state_name,rec;
  if(tsb>15){
    state_name='fresh';
    card.className='insight-card insight-fresh';
    if(emoji)emoji.textContent='🟢';
    if(status)status.textContent='RACE READY';
    if(headline)headline.textContent='You are peaking right now';
    if(detail)detail.textContent='Your form (TSB '+tsb+') is excellent. Fitness base of CTL '+ctl+' with low fatigue. This is the ideal window to race or test yourself.';
    rec='A hard effort or race. Time trial, threshold intervals, or a key long session. Avoid heavy volume — protect your freshness.';
  } else if(tsb>5){
    state_name='fresh';
    card.className='insight-card insight-fresh';
    if(emoji)emoji.textContent='\u26a1';
    if(status)status.textContent='WELL RESTED';
    if(headline)headline.textContent='Good form — ready to train hard';
    if(detail)detail.textContent='Form (TSB '+tsb+') is positive and fitness (CTL '+ctl+') is solid. You have enough freshness for quality training without digging a big hole.';
    rec='Threshold or VO2max work. 4-6 x 4-min at hard effort, or a long tempo run/ride. Build on this fitness.';
  } else if(tsb>=-5){
    state_name='neutral';
    card.className='insight-card insight-neutral';
    if(emoji)emoji.textContent='🟡';
    if(status)status.textContent='TRAINING LOAD: BALANCED';
    if(headline)headline.textContent='Steady state — keep building';
    if(detail)detail.textContent='Your fatigue and fitness are balanced (TSB '+tsb+'). CTL is '+ctl+'. This is a sustainable training zone — keep the consistency going.';
    rec='Moderate aerobic session. Zone 2 endurance work, a comfortable long run, or a skills/technique session.';
  } else if(tsb>=-15){
    state_name='fatigued';
    card.className='insight-card insight-fatigued';
    if(emoji)emoji.textContent='🔴';
    if(status)status.textContent='CARRYING FATIGUE';
    if(headline)headline.textContent='Your body is under load — manage carefully';
    if(detail)detail.textContent='Fatigue (ATL '+atl+') is exceeding fitness (CTL '+ctl+'). TSB '+tsb+' indicates accumulated stress. This is normal in a build phase but needs monitoring.';
    rec='Easy recovery session only. Short Z1/Z2 spin, easy jog, yoga, or swim. Sleep and nutrition are critical today.';
  } else {
    state_name='fatigued';
    card.className='insight-card insight-fatigued';
    if(emoji)emoji.textContent='🛡\ufe0f';
    if(status)status.textContent='HIGH FATIGUE — REST NEEDED';
    if(headline)headline.textContent='Significant overload — prioritise recovery';
    if(detail)detail.textContent='You are significantly fatigued (TSB '+tsb+'). Continuing hard training risks injury and burnout. Your body needs to absorb the work done.';
    rec='Full rest day or very gentle movement only — walk, stretch, foam roll. Two or more easy days recommended before any intensity.';
  }

  // Show trend pill
  if(trendEl && trendText){
    trendEl.style.display='inline-flex';
    trendEl.textContent=trendDir+' '+trendText;
    trendEl.style.color=trendDir==='\u2197'?'var(--pull)':trendDir==='\u2198'?'var(--danger)':'var(--muted)';
  }

  // Show recommendation
  if(recBox && recText && rec){
    recBox.style.display='block';
    recText.textContent=rec;
  }
}

function drawLoadChart(svgId,ctl,atl){
  const svg=document.getElementById(svgId);if(!svg)return;
  const W=svg.clientWidth||300,H=parseInt(svg.style.height)||80;
  if(W<10)return;
  const max=Math.max(...ctl,...atl,1);
  const pts=data=>data.map((v,i)=>`${(i/(data.length-1)*W).toFixed(1)},${(H-v/max*H*.9-4).toFixed(1)}`).join(' ');
  svg.innerHTML=`
    <polyline points="${pts(ctl)}" fill="none" stroke="var(--pull)" stroke-width="1.5" stroke-linejoin="round"/>
    <polyline points="${pts(atl)}" fill="none" stroke="var(--danger)" stroke-width="1.5" stroke-linejoin="round" stroke-dasharray="4,2"/>`;
}

function updateRaceCountdown(){
  try{
    const ev=JSON.parse(localStorage.getItem('lift_event')||'null');
    if(!ev||!ev.date){document.getElementById('raceCountdownSection').style.display='none';document.getElementById('addEventSection').style.display='block';return;}
    const days=Math.ceil((new Date(ev.date)-new Date())/(86400000));
    if(days<0){localStorage.removeItem('lift_event');document.getElementById('raceCountdownSection').style.display='none';document.getElementById('addEventSection').style.display='block';return;}
    document.getElementById('raceCountdownSection').style.display='block';
    document.getElementById('addEventSection').style.display='none';
    document.getElementById('raceName').textContent=ev.name;
    document.getElementById('raceDate').textContent=new Date(ev.date).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    document.getElementById('raceDays').textContent=days;
    document.getElementById('raceIcon').textContent=ev.icon||'🏁';
  }catch(e){}
}

function saveEvent(){
  const name=document.getElementById('eventName').value.trim();
  const date=document.getElementById('eventDate').value;
  const icon=document.getElementById('eventType').value;
  if(!name||!date){alert('Enter event name and date');return;}
  localStorage.setItem('lift_event',JSON.stringify({name,date,icon}));
  updateRaceCountdown();
}

// \u2550\u2550 SPORT TABS (TRAIN) \u2550\u2550
function switchSport(sport,el){
  document.querySelectorAll('.sport-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.sport-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+sport).classList.add('active');
  if(sport==='ride')renderEnduranceWorkouts('ride');
  if(sport==='run')renderEnduranceWorkouts('run');
  if(sport==='log'){renderExerciseLog();initStrava();}
}

function showGymSesh(id,el){
  document.querySelectorAll('.sesh-nav-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['A','B','C'].forEach(s=>document.getElementById('gymSesh-'+s).style.display=s===id?'block':'none');
}

function renderEnduranceWorkouts(sport){
  const today=new Date().getDay(); // 0=Sun
  const isSport=sport==='ride';
  const workouts=isSport?[
    {type:'Z2 Endurance',name:'Steady Base Ride',desc:'90 min @ 65% FTP. Conversational pace, high fat oxidation. Perfect for aerobic base building.'},
    {type:'Threshold',name:'2\u00d720 Threshold',desc:'2 \u00d7 20 min @ 95\u2013100% FTP with 5 min rest. The cornerstone of cycling fitness.'},
    {type:'VO2 Max',name:'5\u00d75 Smash',desc:'5 \u00d7 5 min @ 110\u2013120% FTP with 5 min easy. Raises your ceiling.'},
    {type:'Recovery',name:'Easy Spin',desc:'45\u201360 min @ <55% FTP. Actively flush legs \u2014 don\'t go too easy or skip.'},
  ]:[
    {type:'Easy Run',name:'Zone 2 Aerobic',desc:'45\u201360 min at comfortable effort. Should hold a conversation. The majority of your run volume should be here.'},
    {type:'Tempo',name:'20 Min Tempo',desc:'10 min easy, 20 min at comfortably hard, 10 min easy. Improves lactate threshold.'},
    {type:'Intervals',name:'6\u00d71km Reps',desc:'6 \u00d7 1km @ 5K race pace with 2 min jog recovery. Builds speed and economy.'},
    {type:'Long Run',name:'Easy Long Run',desc:'75\u2013120 min at easy pace. The weekly long run \u2014 king of endurance adaptations.'},
  ];
  const container=document.getElementById(sport+'Workouts');
  if(!container)return;
  container.innerHTML=`<div class="section-label">Suggested Sessions</div>`+workouts.map(w=>`
    <div class="ep-workout">
      <div class="ep-workout-type">${w.type}</div>
      <div class="ep-workout-name">${w.name}</div>
      <div class="ep-workout-desc">${w.desc}</div>
    </div>`).join('');

  // Also render the log form in the endurance panel
  const logForm=document.getElementById(sport+'LogForm');
  if(logForm)logForm.innerHTML=`
    <div class="card" style="padding:14px;">
      <div class="ex-fields">
        <div class="ex-field"><label>Duration (mins)</label><input type="number" id="${sport}Dur" placeholder="${isSport?90:45}"></div>
        <div class="ex-field"><label>Distance (km)</label><input type="number" id="${sport}Dist" placeholder="${isSport?40:10}" step="0.1"></div>
      </div>
      <div class="ex-field" style="margin-bottom:8px;"><label>Avg Heart Rate (bpm)</label><input type="number" id="${sport}HR" placeholder="145"></div>
      <div class="section-label" style="margin-top:2px;">Effort</div>
      <div class="effort-row">
        <div class="effort-btn active" onclick="setEffortFor('${sport}','Easy',this)">Easy</div>
        <div class="effort-btn" onclick="setEffortFor('${sport}','Moderate',this)">Moderate</div>
        <div class="effort-btn" onclick="setEffortFor('${sport}','Hard',this)">Hard</div>
        <div class="effort-btn" onclick="setEffortFor('${sport}','Max',this)">Max</div>
      </div>
      <div class="ex-field" style="margin:8px 0;"><label>Notes</label><textarea id="${sport}Notes" rows="2" placeholder="Route, conditions, how you felt..."></textarea></div>
      <button class="btn btn-ex btn-block" onclick="logEndurance('${sport}')">Log ${isSport?'Ride':'Run'}</button>
    </div>`;
}

var enduranceEffort={ride:'Easy',run:'Easy',swim:'Easy'};
function setEffortFor(sport,val,el){
  enduranceEffort[sport]=val;
  el.closest('.effort-row').querySelectorAll('.effort-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

async function logEndurance(sport){
  const dur=document.getElementById(sport+'Dur')?.value;
  const dist=document.getElementById(sport+'Dist')?.value;
  const hr=document.getElementById(sport+'HR')?.value;
  const notes=document.getElementById(sport+'Notes')?.value||'';
  if(!dur){alert('Enter duration');return;}
  const typeMap={ride:'🚴 Cycling',run:'🏃 Running',swim:'🏊 Swimming'};
  const effort=enduranceEffort[sport]||'Moderate';
  const entry={user_id:currentUser.id,date:todayKey(),type:typeMap[sport],duration:parseInt(dur),distance:dist?parseFloat(dist):null,hr:hr?parseInt(hr):null,effort,notes,cals:0,description:typeMap[sport]};
  try{
    setSyncStatus('syncing');
    const{data,error}=await sb.from('exercise_log').insert(entry).select().single();
    if(error)throw error;
    if(data)state.exerciseLog.push(data);
    setSyncStatus('ok');
    renderExerciseLog();updateDashboard();updateStreaksAndAchievements();
    document.getElementById(sport+'Dur').value='';
    if(document.getElementById(sport+'Dist'))document.getElementById(sport+'Dist').value='';
    if(document.getElementById(sport+'HR'))document.getElementById(sport+'HR').value='';
    if(document.getElementById(sport+'Notes'))document.getElementById(sport+'Notes').value='';
    alert(`${typeMap[sport]} logged!`);
  }catch(e){setSyncStatus('error');alert('Could not save. '+e.message);}
}

// \u2550\u2550 FUEL DAY (carb periodisation) \u2550\u2550
function updateFuelDay(){
  const burned=state.exerciseLog.reduce((a,e)=>a+(e.cals||0),0);
  const types=state.exerciseLog.map(e=>e.type||'');
  const isRide=types.some(t=>t.includes('Cycl'));
  const isRun=types.some(t=>t.includes('Runn'));
  const isSwim=types.some(t=>t.includes('Swim'));
  const isGym=types.some(t=>t.includes('Weight'));
  const baseCarbs=parseInt(state.prefs.cal_goal||2000)*0.4/4;

  let dayType,advice,carbMult;
  if(burned>700||isRide){dayType='High Carb Day';advice='Prioritise carbs before and after \u00b7 Electrolytes \u00b7 Rice, oats, fruit';carbMult=1.5;}
  else if(burned>350||isRun||isSwim){dayType='Moderate Carb Day';advice='Balanced carbs \u00b7 Post-workout protein \u00b7 Hydrate well';carbMult=1.15;}
  else if(isGym){dayType='Gym Day';advice='Protein focus \u00b7 Moderate carbs \u00b7 Leucine-rich post-workout meal';carbMult=0.9;}
  else{dayType='Rest Day';advice='Lower carbs \u00b7 Prioritise protein & colourful veg \u00b7 Sleep well';carbMult=0.7;}

  const carbTarget=Math.round(baseCarbs*carbMult);
  const fdt=document.getElementById('fuelDayType');
  const fda=document.getElementById('fuelDayAdvice');
  const fct=document.getElementById('fuelCarbTarget');
  if(fdt)fdt.textContent=dayType;
  if(fda)fda.textContent=advice;
  if(fct)fct.textContent=carbTarget+'g';
}

// \u2550\u2550 MEASUREMENTS \u2550\u2550
async function logMeasurements(){
  if(!currentUser)return;
  const chest=parseFloat(document.getElementById('measChest').value)||null;
  const waist=parseFloat(document.getElementById('measWaist').value)||null;
  const hips=parseFloat(document.getElementById('measHips').value)||null;
  const thigh=parseFloat(document.getElementById('measThigh').value)||null;
  if(!chest&&!waist&&!hips&&!thigh){alert('Enter at least one measurement');return;}
  const entry={chest,waist,hips,thigh};
  try{
    localStorage.setItem('lift_measurements',JSON.stringify({...entry,date:todayKey()}));
    document.getElementById('lastMeasurements').textContent=
      `Last saved: ${todayKey()} \u2014 Chest: ${chest||'\u2014'}cm \u00b7 Waist: ${waist||'\u2014'}cm \u00b7 Hips: ${hips||'\u2014'}cm \u00b7 Thigh: ${thigh||'\u2014'}cm`;
    alert('Measurements saved!');
  }catch(e){alert('Could not save measurements');}
}

// \u2550\u2550 PROGRESS VIEW \u2550\u2550
function renderProgressView(){
  renderWeekVolume('progressVolume');
  updateTrainingLoad();
  renderPersonalBests();
  renderActivityLog('all');
  updateStreaksAndAchievements();
  const r=getNavRange('progress');
  const lbl=document.getElementById('progressNavLabel');if(lbl)lbl.textContent=r.label;
}

function renderPersonalBests(){
  const el=document.getElementById('pbGrid');if(!el)return;
  const allLogs=state.exerciseLog;
  const bests=[
    {sport:'🚴',label:'Longest Ride',filter:e=>e.type&&e.type.includes('Cycl')&&e.distance,val:e=>e.distance,unit:'km',format:v=>v.toFixed(1)+'km'},
    {sport:'🏃',label:'Longest Run',filter:e=>e.type&&e.type.includes('Runn')&&e.distance,val:e=>e.distance,unit:'km',format:v=>v.toFixed(1)+'km'},
    {sport:'🚴',label:'Most Cals \u2014 Ride',filter:e=>e.type&&e.type.includes('Cycl')&&e.cals,val:e=>e.cals,unit:'kcal',format:v=>v+'kcal'},
    {sport:'🏋\ufe0f',label:'Longest Gym',filter:e=>e.type&&e.type.includes('Weight')&&e.duration,val:e=>e.duration,unit:'min',format:v=>v+'min'},
  ];
  el.innerHTML=bests.map(b=>{
    const matching=allLogs.filter(b.filter);
    if(!matching.length)return`<div class="pb-card"><div class="pb-sport">${b.sport}</div><div class="pb-label">${b.label}</div><div class="pb-val" style="color:var(--muted);">\u2014</div><div class="pb-date">No data yet</div></div>`;
    const best=matching.reduce((a,e)=>b.val(e)>b.val(a)?e:a);
    return`<div class="pb-card"><div class="pb-sport">${b.sport}</div><div class="pb-label">${b.label}</div><div class="pb-val">${b.format(b.val(best))}</div><div class="pb-date">${best.date||''}</div></div>`;
  }).join('');
}

let _currentLogFilter='all';
function filterLog(type,el){
  _currentLogFilter=type;
  document.querySelectorAll('#logFilterBtns .btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderActivityLog(type);
}

function renderActivityLog(filter){
  const el=document.getElementById('fullActivityLog');
  const empty=document.getElementById('fullActivityLogEmpty');
  if(!el)return;
  // Use both today's and all historical data; for now use state.exerciseLog + exerciseHistory
  let logs=[...state.exerciseLog];
  if(filter!=='all')logs=logs.filter(e=>e.type&&e.type.includes(filter.replace('🚴 Cycling','Cycl').replace('🏃 Running','Runn').replace('🏊 Swimming','Swim').replace('🏋\ufe0f Weights','Weight')));
  logs=[...logs].reverse();
  if(!logs.length){el.innerHTML='';if(empty)empty.style.display='block';return;}
  if(empty)empty.style.display='none';
  el.innerHTML=logs.map(e=>`
    <div class="activity-item">
      <div class="ai-sport">${(e.type||'\u26a1').split(' ')[0]}</div>
      <div class="ai-body">
        <div class="ai-name">${e.description||e.type||'Session'}</div>
        <div class="ai-meta">${e.date||''} \u00b7 ${e.duration||'\u2014'}min${e.distance?' \u00b7 '+e.distance+'km':''} \u00b7 ${e.effort||'\u2014'}${e.hr?' \u00b7 '+e.hr+'bpm':''}</div>
      </div>
      <div class="ai-right"><div class="ai-cals">${e.cals||0}</div><div class="ai-kcal">kcal</div></div>
    </div>`).join('');
}

// Legacy alias so old references still work
function updateOverview(){updateDashboard();}

// \u2550\u2550 STREAKS & ACHIEVEMENTS \u2550\u2550
function calcStreak(dateSet){
  // dateSet is an array/set of 'YYYY-MM-DD' strings the user was active
  const dates=new Set(dateSet);
  let streak=0;
  const d=new Date();
  // Allow today or yesterday to start streak (so logging today doesn't break it)
  while(true){
    const k=d.toISOString().slice(0,10);
    if(dates.has(k)){streak++;d.setDate(d.getDate()-1);}
    else break;
  }
  return streak;
}

function updateStreaksAndAchievements(){
  const today=todayKey();

  // --- STREAKS ---
  const loggingStreak=calcStreak([...state.foodHistory, today]);
  const exerciseStreak=calcStreak(state.exerciseHistory);
  const weighDates=state.weightLog.map(w=>w.date);
  const weighStreak=calcStreak(weighDates);

  const setStreak=(id,valId,subId,val,unit)=>{
    const active=val>0;
    const box=document.getElementById(id);if(box)box.classList.toggle('active',active);
    const el=document.getElementById(valId);
    if(el){el.textContent=val;el.className='streak-val'+(active?'':' zero');}
    const sub=document.getElementById(subId);
    if(sub)sub.textContent=val===1?unit.replace('row','time'):unit;
  };
  setStreak('streakLogging','streakLoggingVal','streakLoggingSub',loggingStreak,'days in a row');
  setStreak('streakExercise','streakExerciseVal','streakExerciseSub',exerciseStreak,'days in a row');
  setStreak('streakWeigh','streakWeighVal','streakWeighSub',weighStreak,'days in a row');

  // --- GOAL PROJECTION ---
  const cw=parseFloat(state.prefs.current_weight);
  const tw=parseFloat(state.prefs.target_weight);
  const gpRows=[];
  if(cw&&tw&&state.weightLog.length>=2){
    const sorted=[...state.weightLog].sort((a,b)=>a.date>b.date?1:-1);
    const first=sorted[0],last=sorted[sorted.length-1];
    const days=(new Date(last.date)-new Date(first.date))/(1000*60*60*24)||1;
    const rate=(last.weight-first.weight)/days; // kg/day (negative = losing)
    const remaining=last.weight-tw;
    if(Math.abs(rate)>0.001){
      const daysLeft=Math.abs(remaining/rate);
      const goalDate=new Date();goalDate.setDate(goalDate.getDate()+Math.round(daysLeft));
      const weeklyRate=(rate*7).toFixed(2);
      const isLosing=tw<cw;
      const onTrack=isLosing?rate<0:rate>0;
      gpRows.push(`<div class="gp-row"><span class="gp-icon">${onTrack?'\u2705':'\u26a0\ufe0f'}</span><div><div class="gp-label">Weekly trend</div><div class="gp-val ${onTrack?'good':'bad'}">${rate>0?'+':''}${weeklyRate}kg/week</div></div></div>`);
      gpRows.push(`<div class="gp-row"><span class="gp-icon">📅</span><div><div class="gp-label">Estimated goal date</div><div class="gp-val ${onTrack?'good':'warn'}">${onTrack?goalDate.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}):'Adjust your plan'}</div></div></div>`);
      gpRows.push(`<div class="gp-row"><span class="gp-icon">🎯</span><div><div class="gp-label">To go</div><div class="gp-val">${Math.abs(remaining).toFixed(1)}kg ${isLosing?'to lose':'to gain'}</div></div></div>`);
    }
    if(loggingStreak>=3){
      const avgCals=state.foodLog.reduce((a,f)=>a+(f.cals||0),0);
      const goal=state.prefs.cal_goal||2000;
      const diff=avgCals-goal;
      const txt=Math.abs(diff)<100?'Right on target 🎯':diff<0?`${Math.abs(diff)} under goal`:`${diff} over goal`;
      const cls=Math.abs(diff)<100?'good':diff<0?'warn':'bad';
      gpRows.push(`<div class="gp-row"><span class="gp-icon">🍽\ufe0f</span><div><div class="gp-label">Today's calories vs goal</div><div class="gp-val ${cls}">${txt}</div></div></div>`);
    }
  } else if(cw&&tw){
    gpRows.push(`<div class="gp-row"><span class="gp-icon">💡</span><div><div class="gp-label">Tip</div><div class="gp-val">Log 2+ weigh-ins to see your projection</div></div></div>`);
  }
  const gpEl=document.getElementById('goalProjection');
  if(gpRows.length){gpEl.style.display='block';document.getElementById('gpRows').innerHTML=gpRows.join('');}
  else gpEl.style.display='none';

  // --- ACHIEVEMENTS ---
  const ACHIEVEMENTS=[
    {id:'first_log',icon:'🍽\ufe0f',name:'First Fuel',desc:'Log your first meal',check:()=>state.foodHistory.length>0},
    {id:'log_streak_3',icon:'🔥',name:'3-Day Logger',desc:'Log meals 3 days in a row',check:()=>loggingStreak>=3},
    {id:'log_streak_7',icon:'🔥🔥',name:'Week Warrior',desc:'Log meals 7 days in a row',check:()=>loggingStreak>=7},
    {id:'log_streak_30',icon:'👑',name:'Monthly Master',desc:'Log meals 30 days in a row',check:()=>loggingStreak>=30},
    {id:'first_exercise',icon:'\u26a1',name:'First Session',desc:'Log your first training session',check:()=>state.exerciseHistory.length>0},
    {id:'exercise_streak_3',icon:'🏅',name:'3-Day Athlete',desc:'Train 3 days in a row',check:()=>exerciseStreak>=3},
    {id:'exercise_streak_7',icon:'🏆',name:'7-Day Athlete',desc:'Train 7 days in a row',check:()=>exerciseStreak>=7},
    {id:'first_ride',icon:'🚴',name:'First Ride',desc:'Log your first cycling session',check:()=>state.exerciseLog.some(e=>e.type&&e.type.includes('Cycl'))},
    {id:'century_ride',icon:'💛',name:'Long Ride',desc:'Log a ride of 80km+',check:()=>state.exerciseLog.some(e=>e.type&&e.type.includes('Cycl')&&(e.distance||0)>=80)},
    {id:'first_run',icon:'🏃',name:'First Run',desc:'Log your first run',check:()=>state.exerciseLog.some(e=>e.type&&e.type.includes('Runn'))},
    {id:'10k_run',icon:'🎽',name:'10K Club',desc:'Log a run of 10km+',check:()=>state.exerciseLog.some(e=>e.type&&e.type.includes('Runn')&&(e.distance||0)>=10)},
    {id:'first_swim',icon:'🏊',name:'First Swim',desc:'Log your first swim',check:()=>state.exerciseLog.some(e=>e.type&&e.type.includes('Swim'))},
    {id:'first_weigh',icon:'\u2696\ufe0f',name:'First Check-In',desc:'Log your first weigh-in',check:()=>state.weightLog.length>0},
    {id:'hit_goal',icon:'🎯',name:'Goal Reached',desc:'Reach your target weight',check:()=>{const cw=state.weightLog.length?state.weightLog[state.weightLog.length-1].weight:null;const tw=parseFloat(state.prefs.target_weight);if(!cw||!tw)return false;const start=parseFloat(state.prefs.current_weight)||cw;return start>tw?cw<=tw:cw>=tw;}},
    {id:'water_day',icon:'💧',name:'Hydrated',desc:'Hit 8 glasses in a day',check:()=>(state.prefs.water||0)>=8},
    {id:'calorie_goal',icon:'\u2705',name:'On Target',desc:'Stay within 100kcal of your calorie goal',check:()=>{const cal=state.foodLog.reduce((a,f)=>a+(f.cals||0),0);const g=state.prefs.cal_goal||2000;return Math.abs(cal-g)<=100&&cal>0;}},
  ];

  const saved=JSON.parse(localStorage.getItem('lift_achievements')||'{}');
  const newlyEarned=[];
  ACHIEVEMENTS.forEach(a=>{
    const earned=a.check();
    if(earned&&!saved[a.id]){saved[a.id]=todayKey();newlyEarned.push(a.name);}
  });
  if(newlyEarned.length){localStorage.setItem('lift_achievements',JSON.stringify(saved));showAchievementToast(newlyEarned[0]);}

  const grid=document.getElementById('achievementsGrid');
  const earned=ACHIEVEMENTS.filter(a=>saved[a.id]);
  const locked=ACHIEVEMENTS.filter(a=>!saved[a.id]);
  grid.innerHTML=[...earned,...locked].map(a=>{
    const isEarned=!!saved[a.id];
    return`<div class="achievement-card ${isEarned?'earned':'locked'}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-body">
        <div class="ach-name">${a.name}</div>
        <div class="ach-desc">${a.desc}</div>
      </div>
      <div class="ach-badge"><div class="ach-status ${isEarned?'':'locked'}">${isEarned?'\u2713 Earned':'Locked'}</div>${isEarned?`<div style="font-size:9px;color:var(--muted);margin-top:2px;">${saved[a.id]}</div>`:''}</div>
    </div>`;
  }).join('');
}

function showAchievementToast(name){
  const toast=document.getElementById('achievementToast');
  toast.textContent='🏆 Achievement Unlocked: '+name;
  toast.classList.remove('show');
  void toast.offsetWidth; // reflow to restart animation
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),3200);
}

// THEME
var THEMES={
  dark:{
    '--bg':'#090909','--bg2':'#0f0f0f',
    '--surface':'rgba(255,255,255,0.04)','--surface2':'rgba(255,255,255,0.07)',
    '--card':'rgba(255,255,255,0.06)','--card2':'rgba(255,255,255,0.09)',
    '--glass':'rgba(15,15,15,0.72)','--glass-border':'rgba(255,255,255,0.10)',
    '--border':'rgba(255,255,255,0.09)','--border2':'rgba(255,255,255,0.16)',
    '--text':'#f2f2f2','--text2':'#c8c8c8',
    '--muted':'rgba(255,255,255,0.35)','--muted2':'rgba(255,255,255,0.55)',
    '--input-bg':'rgba(255,255,255,0.05)',
    '--accent':'#c8ff00','--accent-dim':'rgba(200,255,0,0.12)','--accent-glow':'rgba(200,255,0,0.25)',
    '--accent2':'#ff6b35','--push':'#4f8cff','--pull':'#22d88f','--full':'#ffbe00',
    '--diet':'#bf7fff','--weight':'#ff6b8a','--exlog':'#3de8a0','--blue':'#5ab4ff','--danger':'#ff4d4d',
    '--tab-bg':'rgba(12,12,12,0.88)'
  },
  light:{
    '--bg':'#f5f5f7','--bg2':'#ebebed',
    '--surface':'rgba(255,255,255,0.70)','--surface2':'rgba(255,255,255,0.88)',
    '--card':'rgba(255,255,255,0.80)','--card2':'rgba(255,255,255,0.95)',
    '--glass':'rgba(245,245,247,0.80)','--glass-border':'rgba(0,0,0,0.08)',
    '--border':'rgba(0,0,0,0.08)','--border2':'rgba(0,0,0,0.15)',
    '--text':'#0d0d0d','--text2':'#2a2a2a',
    '--muted':'rgba(0,0,0,0.38)','--muted2':'rgba(0,0,0,0.58)',
    '--input-bg':'rgba(0,0,0,0.04)',
    '--accent':'#6ab000','--accent-dim':'rgba(106,176,0,0.10)','--accent-glow':'rgba(106,176,0,0.20)',
    '--accent2':'#e0501a','--push':'#2563eb','--pull':'#059669','--full':'#d97706',
    '--diet':'#9333ea','--weight':'#e11d48','--exlog':'#059669','--blue':'#2563eb','--danger':'#dc2626',
    '--tab-bg':'rgba(245,245,247,0.90)'
  }
};
function setTheme(t){
  // 'auto' resolves to system preference
  var resolved = t;
  if(t === 'auto'){
    resolved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  var vars = THEMES[resolved] || THEMES.dark;
  [document.documentElement, document.body].forEach(function(el){
    Object.keys(vars).forEach(function(k){ el.style.setProperty(k, vars[k]); });
  });
  document.body.style.backgroundColor = vars['--bg'];
  document.body.style.color = vars['--text'];
  // Update theme-color meta for browser chrome
  var tm = document.querySelector('meta[name="theme-color"]');
  if(tm) tm.content = vars['--bg'];
  try { localStorage.setItem('lift_theme', t); } catch(e) {}
  // Update buttons
  var d=document.getElementById('themeDark'), l=document.getElementById('themeLight'), a=document.getElementById('themeAuto');
  if(d) d.classList.toggle('active', t==='dark');
  if(l) l.classList.toggle('active', t==='light');
  if(a) a.classList.toggle('active', t==='auto');
}
// SETTINGS SYNC
function syncCalGoalFromSettings(){
  const v=parseInt(document.getElementById('settingsCalGoal').value)||2000;
  state.prefs.cal_goal=v;
  if(document.getElementById('calGoalInput'))document.getElementById('calGoalInput').value=v;
  savePrefs();
}
function syncCalGoal(){
  const v=parseInt(document.getElementById('calGoalInput').value)||2000;
  state.prefs.cal_goal=v;
  if(document.getElementById('settingsCalGoal'))document.getElementById('settingsCalGoal').value=v;
  savePrefs();
}
function redoOnboarding(){
  if(!confirm('This will restart the onboarding and regenerate your AI plan. Continue?'))return;
  document.getElementById('userDropdown').classList.remove('show');
  startOnboarding();
}

// RECIPE
const setsState={};
const diagramCache={};
function toggleExExpand(cardId){
  const panel=document.getElementById('expand-'+cardId);
  if(!panel)return;
  const isOpen=panel.classList.contains('open');
  // Close all others
  document.querySelectorAll('.ex-expand.open').forEach(p=>p.classList.remove('open'));
  if(!isOpen){panel.classList.add('open');renderExpandPanel(cardId);}
}
function openExpand(cardId){
  const panel=document.getElementById('expand-'+cardId);
  if(!panel)return;
  panel.classList.add('open');
  renderExpandPanel(cardId);
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function renderExpandPanel(cardId){
  const card=document.getElementById(cardId);
  if(!card)return;
  const exName=card.dataset.name||'Exercise';
  const session=card.dataset.session||'A';
  if(!setsState[cardId])setsState[cardId]=[{reps:'',weight:'',done:false},{reps:'',weight:'',done:false},{reps:'',weight:'',done:false}];
  const panel=document.getElementById('expand-'+cardId);
  const ytQuery=encodeURIComponent(exName+' exercise technique');
  const sets=setsState[cardId];
  panel.innerHTML=`
    <div class="ex-diagram" id="diag-${cardId}"><div style="color:var(--muted);font-size:11px;padding:8px;">Loading diagram...</div></div>
    <a class="ex-yt-link" href="https://www.youtube.com/results?search_query=${ytQuery}" target="_blank"><span class="ex-yt-icon">\u25b6\ufe0f</span>Watch ${exName} technique on YouTube</a>
    <div class="sets-logger">
      <div class="sets-header"><span class="sets-title">Sets</span><button class="sets-history-btn" onclick="showStrengthHistory('${exName}')">History \u2197</button></div>
      <div class="set-col-labels"><div class="set-col-label">#</div><div class="set-col-label">Reps</div><div class="set-col-label">kg</div><div class="set-col-label">\u2713</div></div>
      <div id="setRows-${cardId}"></div>
      <button class="add-set-btn" onclick="addSet('${cardId}')">+ Add Set</button>
      <button class="save-sets-btn" onclick="saveSets('${cardId}','${exName}','${session}')">Save Sets</button>
    </div>`;
  renderSetRows(cardId);
  generateDiagram(cardId,exName);
}
function renderSetRows(cardId){
  const container=document.getElementById('setRows-'+cardId);if(!container)return;
  const sets=setsState[cardId]||[];
  container.innerHTML=sets.map((s,i)=>`
    <div class="set-row">
      <div class="set-num">${i+1}</div>
      <input class="set-input" type="number" placeholder="10" value="${s.reps}" onchange="updateSet('${cardId}',${i},'reps',this.value)" min="1">
      <input class="set-input" type="number" placeholder="60" value="${s.weight}" onchange="updateSet('${cardId}',${i},'weight',this.value)" step="0.5">
      <button class="set-done-btn${s.done?' completed':''}" onclick="toggleSetDone('${cardId}',${i})">${s.done?'\u2713':''}</button>
    </div>`).join('');
}
function updateSet(cardId,i,field,val){if(setsState[cardId]&&setsState[cardId][i])setsState[cardId][i][field]=val;}
function toggleSetDone(cardId,i){
  if(!setsState[cardId])return;
  setsState[cardId][i].done=!setsState[cardId][i].done;
  renderSetRows(cardId);
  // Auto-complete exercise card if all sets done
  if(setsState[cardId].every(s=>s.done)){const card=document.getElementById(cardId);if(card){card.classList.add('done');const session=card.dataset.session;if(session)updateSeshProgress(session);}}
}
function addSet(cardId){if(!setsState[cardId])setsState[cardId]=[];setsState[cardId].push({reps:'',weight:'',done:false});renderSetRows(cardId);}
async function saveSets(cardId,exerciseName,session){
  if(!currentUser)return;
  const sets=setsState[cardId];
  if(!sets||sets.every(s=>!s.reps&&!s.weight)){alert('Enter at least one set');return;}
  try{
    await sb.from('strength_log').insert({user_id:currentUser.id,date:todayKey(),session,exercise:exerciseName,sets:JSON.stringify(sets)});
    const btn=document.querySelector(`#expand-${cardId} .save-sets-btn`);
    if(btn){btn.textContent='Saved \u2713';btn.style.background='var(--pull)';setTimeout(()=>{btn.textContent='Save Sets';btn.style.background='';},2000);}
  }catch(e){alert('Could not save. Check your internet connection.');}
}
async function showStrengthHistory(exerciseName){
  if(!currentUser)return;
  const{data}=await sb.from('strength_log').select('*').eq('user_id',currentUser.id).eq('exercise',exerciseName).order('date',{ascending:false}).limit(10);
  const modal=document.getElementById('strengthModal');
  document.getElementById('strengthModalTitle').textContent=exerciseName+' \u2014 History';
  document.getElementById('strengthModalBody').innerHTML=(!data||!data.length)
    ?'<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">No history yet. Log some sets!</p>'
    :data.map(entry=>{
      const sets=typeof entry.sets==='string'?JSON.parse(entry.sets):entry.sets;
      const maxW=Math.max(...sets.filter(s=>s.weight).map(s=>parseFloat(s.weight)||0));
      const vol=sets.reduce((a,s)=>(parseFloat(s.reps)||0)*(parseFloat(s.weight)||0)+a,0);
      return`<div class="history-entry"><div class="he-date">${entry.date} \u00b7 Max: ${maxW}kg \u00b7 Vol: ${vol}kg</div><div class="he-sets">${sets.map(s=>`<div class="he-set">${s.reps||'?'} <span>\u00d7 ${s.weight||'?'}kg</span></div>`).join('')}</div></div>`;
    }).join('');
  modal.classList.add('show');
}
function closeStrengthModal(){document.getElementById('strengthModal').classList.remove('show');}

async function generateDiagram(cardId,exName){
  const el=document.getElementById('diag-'+cardId);if(!el)return;
  if(diagramCache[exName]){el.innerHTML=diagramCache[exName];return;}
  try{
    const svg=await callClaude(`Create a minimal SVG stick figure diagram showing correct form for "${exName}". Output ONLY the SVG element, no explanation. Use viewBox="0 0 200 140", stroke="#e8ff47", stroke-width="2", fill="none", background rect fill="#1a1a1a". Keep it simple \u2014 just lines and circles for joints.`);
    const match=svg.match(/<svg[\s\S]*?<\/svg>/i);
    if(match){diagramCache[exName]=match[0];el.innerHTML=match[0];}
    else el.innerHTML='<div style="color:var(--muted);font-size:11px;padding:8px;">Form diagram unavailable</div>';
  }catch(e){el.innerHTML='<div style="color:var(--muted);font-size:11px;padding:8px;">Form diagram unavailable</div>';}
}


const timers={A:null,B:null,C:null},timerSecs={A:2700,B:2700,C:2700};
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
function startTimer(id){if(timers[id])return;timers[id]=setInterval(()=>{if(timerSecs[id]>0){timerSecs[id]--;document.getElementById('timer'+id).textContent=fmt(timerSecs[id]);}else{clearInterval(timers[id]);timers[id]=null;}},1000);}
function pauseTimer(id){clearInterval(timers[id]);timers[id]=null;}
function resetTimer(id){pauseTimer(id);timerSecs[id]=2700;document.getElementById('timer'+id).textContent='45:00';}

// SESSION CHECKLIST
function toggleEx(card,id){card.classList.toggle('done');updateSeshProgress(id);}
function toggleStr(item,id){item.classList.toggle('done');updateSeshProgress(id);}
function updateSeshProgress(id){
  const view=document.getElementById('gymSesh-'+id);
  if(!view)return;
  const total=view.querySelectorAll('.ex-card,.stretch-item').length,done=view.querySelectorAll('.ex-card.done,.stretch-item.done').length;
  const progEl=document.getElementById('prog'+id);if(progEl)progEl.style.width=Math.round(done/total*100)+'%';
  const cmpEl=document.getElementById('complete'+id);if(cmpEl)cmpEl.classList.toggle('show',done===total&&total>0);
}
function resetSesh(id){
  const view=document.getElementById('gymSesh-'+id);
  if(!view)return;
  view.querySelectorAll('.ex-card.done,.stretch-item.done').forEach(el=>el.classList.remove('done'));
  const progEl=document.getElementById('prog'+id);if(progEl)progEl.style.width='0%';
  const cmpEl=document.getElementById('complete'+id);if(cmpEl)cmpEl.classList.remove('show');
  resetTimer(id);
}

// WATER
function initWater(){
  const w=state.prefs.water||0,el=document.getElementById('waterGlasses');if(!el)return;
  el.innerHTML='';
  for(let i=0;i<8;i++)el.innerHTML+=`<div class="glass-btn ${i<w?'filled':''}" onclick="toggleGlass(${i})">💧</div>`;
  const wcd=document.getElementById('waterCountDisplay');if(wcd)wcd.textContent=w+' / 8';
  const dwc=document.getElementById('dietWaterCount');if(dwc)dwc.textContent=w+'/8';
}
async function toggleGlass(i){state.prefs.water=(i<(state.prefs.water||0))?i:i+1;initWater();await sb.from('user_prefs').upsert({user_id:currentUser.id,water:state.prefs.water,cal_goal:state.prefs.cal_goal||2000,updated_at:new Date().toISOString()},{onConflict:'user_id'});updateStreaksAndAchievements();}
async function adjustWater(delta){
  const current=state.prefs.water||0;
  const newVal=Math.max(0,Math.min(8,current+delta));
  if(newVal===current)return;
  state.prefs.water=newVal;
  initWater();
  showWaterToast(delta>0?'💧 Glass added! ('+newVal+'/8)':'Glass removed ('+newVal+'/8)');
  await sb.from('user_prefs').upsert({user_id:currentUser.id,water:newVal,cal_goal:state.prefs.cal_goal||2000,updated_at:new Date().toISOString()},{onConflict:'user_id'});
  updateStreaksAndAchievements();
}

// GOAL BAR
function updateGoalBar(){
  const goal=parseInt(document.getElementById('calGoalInput').value)||2000;
  const cals=state.foodLog.reduce((a,f)=>a+(f.cals||0),0);
  const pct=Math.min(100,Math.round(cals/goal*100));
  const fill=document.getElementById('goalbarFill');fill.style.width=pct+'%';fill.classList.toggle('over',cals>goal);
  document.getElementById('glLeft').textContent=cals>goal?`${cals-goal} over goal`:`${goal-cals} remaining`;
  document.getElementById('glPct').textContent=pct+'%';
}

// DIET TABS
function switchDietTab(t,el){document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.tab-panel').forEach(e=>e.classList.remove('active'));el.classList.add('active');document.getElementById('dietTab-'+t).classList.add('active');if(t==='history')renderFoodLog();if(t==='log')renderFavourites();}

// AI
let ANTHROPIC_KEY=localStorage.getItem('lift_anthropic_key')||'';
async function saveApiKey(){
  const val=document.getElementById('anthropicKeyInput').value.trim();
  ANTHROPIC_KEY=val;
  if(val){
    localStorage.setItem('lift_anthropic_key',val);
    document.getElementById('apiKeyStatus').textContent='Saving...';
    // Save to Supabase so it works on all devices
    if(currentUser){await sb.from('user_prefs').upsert({user_id:currentUser.id,anthropic_key:val,cal_goal:state.prefs.cal_goal||2000,updated_at:new Date().toISOString()},{onConflict:'user_id'});}
    document.getElementById('apiKeyStatus').textContent='\u2713 Key saved \u2014 AI features enabled';
    document.getElementById('apiKeyStatus').style.color='#4caf50';
  } else {
    localStorage.removeItem('lift_anthropic_key');
    if(currentUser){await sb.from('user_prefs').upsert({user_id:currentUser.id,anthropic_key:null,cal_goal:state.prefs.cal_goal||2000,updated_at:new Date().toISOString()},{onConflict:'user_id'});}
    document.getElementById('apiKeyStatus').textContent='Not set \u2014 AI features disabled';
    document.getElementById('apiKeyStatus').style.color='';
  }
}
function loadApiKeyUI(){
  const k=localStorage.getItem('lift_anthropic_key')||'';
  const inp=document.getElementById('anthropicKeyInput');
  if(inp){inp.value=k;if(k){document.getElementById('apiKeyStatus').textContent='\u2713 Key saved \u2014 AI features enabled';document.getElementById('apiKeyStatus').style.color='#4caf50';}}
}
async function callClaude(prompt,maxTokens=500){
  if(!ANTHROPIC_KEY){throw new Error('No API key configured');}
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:maxTokens,messages:[{role:'user',content:prompt}]})
  });
  const data=await res.json();
  if(data.error)throw new Error(data.error.message);
  return data.content?.map(b=>b.text||'').join('')||'';
}

// MEAL LOGGING
let selectedFoodOption=null;

async function findFoodOptions(){
  const desc=document.getElementById('mealDescInput').value.trim();
  if(!desc)return;
  const thinking=document.getElementById('logThinking');
  const optsList=document.getElementById('foodOptionsList');
  const confirmPanel=document.getElementById('foodConfirmPanel');
  optsList.style.display='none';
  confirmPanel.style.display='none';
  selectedFoodOption=null;
  thinking.classList.add('show');
  try{
    const raw=await callClaude('Nutrition expert. The user described: "'+desc+'". Return 3 realistic options they might mean. For each, include a short name, serving unit, typical serving size, calories and protein. Respond ONLY valid JSON array: [{"name":"short name","unit":"serving unit e.g. cup/piece/g/ml","serving_size":"e.g. 250ml or 1 slice","cals":number,"protein_g":number},...].',600);
    const opts=JSON.parse(raw.replace(/```json|```/g,'').trim());
    thinking.classList.remove('show');
    optsList.innerHTML=opts.map(function(o,i){return '<div onclick="selectFoodOption('+i+')" style="background:var(--card2,#1e1e1e);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;"><div><div style="font-size:13px;font-weight:600;">'+o.name+'</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">'+o.serving_size+' &middot; '+o.protein_g+'g protein</div></div><div style="text-align:right;"><div style="font-size:16px;font-weight:700;color:var(--accent);">'+o.cals+'</div><div style="font-size:10px;color:var(--muted);">kcal</div></div></div>';}).join('');
    optsList._data=opts;
    optsList.style.display='block';
  }catch(e){
    thinking.classList.remove('show');
    alert('Error: '+e.message);
  }
}

function selectFoodOption(idx){
  const optsList=document.getElementById('foodOptionsList');
  const opts=optsList._data;
  selectedFoodOption=opts[idx];
  Array.from(optsList.children).forEach(function(el,i){
    el.style.borderColor=i===idx?'var(--accent)':'var(--border)';
  });
  const panel=document.getElementById('foodConfirmPanel');
  document.getElementById('foodConfirmName').textContent=selectedFoodOption.name;
  document.getElementById('foodConfirmMacros').textContent=selectedFoodOption.serving_size+' \u00b7 '+selectedFoodOption.cals+' kcal \u00b7 '+selectedFoodOption.protein_g+'g protein';
  document.getElementById('foodQtyInput').value=1;
  document.getElementById('foodQtyUnit').textContent=selectedFoodOption.unit||'serving';
  updateConfirmTotal();
  panel.style.display='block';
  document.getElementById('foodQtyInput').oninput=updateConfirmTotal;
}

function updateConfirmTotal(){
  if(!selectedFoodOption)return;
  const qty=parseFloat(document.getElementById('foodQtyInput').value)||1;
  const totalCals=Math.round(selectedFoodOption.cals*qty);
  const totalProt=Math.round(selectedFoodOption.protein_g*qty);
  document.getElementById('foodConfirmTotal').textContent=totalCals+' kcal \u00b7 '+totalProt+'g protein';
}

async function confirmFoodLog(){
  if(!selectedFoodOption)return;
  const qty=parseFloat(document.getElementById('foodQtyInput').value)||1;
  const mealType=document.getElementById('mealTypeLog').value;
  try{
    await addFoodEntry({
      name:mealType+': '+selectedFoodOption.name+(qty!==1?' (x'+qty+')':''),
      cals:Math.round(selectedFoodOption.cals*qty),
      protein:Math.round(selectedFoodOption.protein_g*qty),
      meal_type:mealType,
      source:'ai'
    });
    resetFoodLog();
  }catch(e){
    alert('Could not save: '+e.message);
  }
}

function resetFoodLog(){
  document.getElementById('mealDescInput').value='';
  document.getElementById('foodOptionsList').style.display='none';
  document.getElementById('foodConfirmPanel').style.display='none';
  selectedFoodOption=null;
}
async function addFoodEntry(item){
  setSyncStatus('syncing');
  const entry={user_id:currentUser.id,date:todayKey(),...item};
  const{data,error}=await sb.from('food_log').insert(entry).select().single();
  if(error){setSyncStatus('error');throw new Error(error.message);}
  if(data)state.foodLog.push(data);
  setSyncStatus('ok');renderFoodLog();updateGoalBar();updateDietSummary();updateDashboard();updateStreaksAndAchievements();
}
function renderFoodLog(){
  const list=document.getElementById('mealLogList'),empty=document.getElementById('mealLogEmpty');
  if(!state.foodLog.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=[...state.foodLog].reverse().map(f=>`<div class="meal-log-item"><div class="mli-left"><div class="mli-name">${f.name}</div><div class="mli-meta">${f.source==='barcode'?'📦 Scanned':f.source==='recipe'?'🍳 Recipe':'🤖 AI'}${f.protein?` \u00b7 ${f.protein}g protein`:''}</div></div><div class="mli-right"><div class="mli-cals">${f.cals}</div><div class="mli-unit">kcal</div></div><button class="del-btn" onclick="deleteFoodEntry('${f.id}')">\u00d7</button></div>`).join('');
}
async function deleteFoodEntry(id){await sb.from('food_log').delete().eq('id',id);state.foodLog=state.foodLog.filter(f=>f.id!==id);renderFoodLog();updateGoalBar();updateDietSummary();updateOverview();}
async function clearFoodLog(){await sb.from('food_log').delete().eq('user_id',currentUser.id).eq('date',todayKey());state.foodLog=[];renderFoodLog();updateGoalBar();updateDietSummary();updateOverview();}
function updateDietSummary(){const cals=state.foodLog.reduce((a,f)=>a+(f.cals||0),0),prot=state.foodLog.reduce((a,f)=>a+(f.protein||0),0);document.getElementById('dietTotalCals').textContent=cals;document.getElementById('dietTotalPro').textContent=Math.round(prot)+'g';}

// BARCODE \u2014 photo approach (works on all iOS/Android)
let barcodeData=null;
let photoData={identify:null,label:null}; // base64 strings

async function handleBarcodePhoto(input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  input.value=''; // reset so same photo can be re-selected
  const base64=await fileToBase64(file);
  document.getElementById('barcodeThinking').classList.add('show');
  document.getElementById('barcodeResult').style.display='none';
  try{
    // Ask Claude to extract barcode number from the image
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:100,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:file.type||'image/jpeg',data:base64}},{type:'text',text:'Read the barcode or QR code in this image. Reply ONLY with the numeric barcode digits, nothing else. If you cannot read a barcode, reply "none".'}]}]})});
    const data=await res.json();
    const code=(data.content?.map(b=>b.text||'').join('')||'').trim().replace(/\\D/g,'');
    if(!code||code===''){alert('Could not read barcode from photo. Try entering the number manually below.');document.getElementById('barcodeThinking').classList.remove('show');return;}
    document.getElementById('manualBarcode').value=code;
    await lookupBarcode(code);
  }catch(e){alert('Error reading barcode. Try entering the number manually.');}
  document.getElementById('barcodeThinking').classList.remove('show');
}

function fileToBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

async function lookupBarcode(code){
  const barcode=code||document.getElementById('manualBarcode').value.trim();
  if(!barcode){alert('Enter a barcode number');return;}
  document.getElementById('barcodeThinking').classList.add('show');
  document.getElementById('barcodeResult').style.display='none';
  try{
    const res=await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
    const data=await res.json();
    if(data.status!==1||!data.product)throw new Error('not found');
    const p=data.product,n=p.nutriments||{};
    barcodeData={
      name:p.product_name||p.brands||'Unknown product',
      cals_per_100g:n['energy-kcal_100g']||n['energy-kcal']||0,
      protein_per_100g:n.proteins_100g||0,
      carbs_per_100g:n.carbohydrates_100g||0,
      fat_per_100g:n.fat_100g||0,
      serving_size:p.serving_size||'100g',
      serving_quantity:parseFloat(p.serving_quantity)||100
    };
    document.getElementById('brProductName').textContent=barcodeData.name;
    document.getElementById('brCals').textContent=Math.round(barcodeData.cals_per_100g)+'kcal/100g';
    document.getElementById('brProt').textContent=barcodeData.protein_per_100g.toFixed(1)+'g/100g';
    document.getElementById('brCarbs').textContent=barcodeData.carbs_per_100g.toFixed(1)+'g/100g';
    document.getElementById('brFat').textContent=barcodeData.fat_per_100g.toFixed(1)+'g/100g';
    document.getElementById('brServingInfo').textContent='Serving: '+barcodeData.serving_size;
    document.getElementById('brUnit').textContent='serving ('+barcodeData.serving_size+')';
    document.getElementById('brServings').value=1;
    updateBarcodeCalcs();
    document.getElementById('barcodeResult').style.display='block';
  }catch(e){alert('Product not found in database. Try the AI meal log instead.');}
  document.getElementById('barcodeThinking').classList.remove('show');
}
function updateBarcodeCalcs(){if(!barcodeData)return;const servings=parseFloat(document.getElementById('brServings').value)||1;document.getElementById('brTotalCals').textContent=Math.round(barcodeData.cals_per_100g*servings*barcodeData.serving_quantity/100);}
async function logBarcodeItem(){
  if(!barcodeData)return;
  const servings=parseFloat(document.getElementById('brServings').value)||1;
  const totalG=servings*barcodeData.serving_quantity;
  const cals=Math.round(barcodeData.cals_per_100g*totalG/100);
  const protein=parseFloat((barcodeData.protein_per_100g*totalG/100).toFixed(1));
  const mealType=document.getElementById('mealTypeBarcode').value;
  await addFoodEntry({name:`${mealType}: ${barcodeData.name} (${servings} serving)`,cals,protein,meal_type:mealType,source:'barcode'});
  document.getElementById('barcodeResult').style.display='none';
  document.getElementById('manualBarcode').value='';
  barcodeData=null;
}

// PHOTO MODES \u2014 file input approach
async function handlePhotoFile(mode,input){
  if(!input.files||!input.files[0])return;
  const file=input.files[0];
  input.value='';
  const base64=await fileToBase64(file);
  photoData[mode]={base64,mediaType:file.type||'image/jpeg'};
  // Show preview
  const preview=document.getElementById(mode+'Preview');
  preview.src='data:'+photoData[mode].mediaType+';base64,'+base64;
  preview.style.display='block';
  document.getElementById(mode+'Area').style.display='none';
  document.getElementById(mode+'Controls').style.display='flex';
  document.getElementById(mode+'Result').style.display='none';
}
function retakePhoto(mode){
  document.getElementById(mode+'Preview').style.display='none';
  document.getElementById(mode+'Area').style.display='block';
  document.getElementById(mode+'Controls').style.display='none';
  document.getElementById(mode+'Result').style.display='none';
  photoData[mode]=null;
}
let photoFoodData={identify:null,label:null};
async function analysePhoto(mode){
  if(!photoData[mode]){alert('Take a photo first');return;}
  document.getElementById(mode+'Thinking').classList.add('show');
  document.getElementById(mode+'Result').style.display='none';
  try{
    const prompt=mode==='identify'
      ?'You are a nutrition expert. Identify the food in this image and estimate calories and protein for the serving shown. Respond ONLY with valid JSON, no other text: {"name":"food name","cals":number,"protein_g":number,"description":"brief description e.g. grilled chicken breast, approx 200g"}'
      :'You are a nutrition expert. Read this nutrition label image carefully and extract the data per serving. Respond ONLY with valid JSON, no other text: {"name":"product name","cals_per_serving":number,"protein_g_per_serving":number,"serving_size":"e.g. 30g"}';
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:300,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:photoData[mode].mediaType,data:photoData[mode].base64}},{type:'text',text:prompt}]}]})});
    const raw=await res.json();
    const text=raw.content?.map(b=>b.text||'').join('')||'';
    const parsed=JSON.parse(text.replace(/```json|```/g,'').trim());
    if(mode==='identify'){
      photoFoodData.identify={name:parsed.name,cals:parsed.cals,protein:parsed.protein_g};
      document.getElementById('identifyName').textContent=parsed.name;
      document.getElementById('identifyMacros').textContent=`~${parsed.cals} kcal \u00b7 ${parsed.protein_g}g protein \u00b7 ${parsed.description||''}`;
    } else {
      photoFoodData.label={name:parsed.name,cals:parsed.cals_per_serving,protein:parsed.protein_g_per_serving};
      document.getElementById('labelName').textContent=parsed.name+' (per serving: '+parsed.serving_size+')';
      document.getElementById('labelMacros').textContent=`${parsed.cals_per_serving} kcal \u00b7 ${parsed.protein_g_per_serving}g protein per serving`;
    }
    document.getElementById(mode+'Result').style.display='block';
  }catch(e){alert('Could not analyse image. Make sure the photo is clear and try again.');}
  document.getElementById(mode+'Thinking').classList.remove('show');
}
async function logPhotoFood(mode){
  const d=photoFoodData[mode];if(!d)return;
  const key='mealType'+mode.charAt(0).toUpperCase()+mode.slice(1);
  const mealType=document.getElementById(key).value;
  await addFoodEntry({name:`${mealType}: ${d.name}`,cals:d.cals,protein:d.protein,meal_type:mealType,source:'camera'});
  document.getElementById(mode+'Result').style.display='none';
  retakePhoto(mode);
}

// Camera mode switcher (no stopCamera needed any more)
function switchCamMode(mode,el){
  document.querySelectorAll('.cam-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.cam-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('camPanel-'+mode).classList.add('active');
}
// Keep stopCamera as no-op for backward compat
function stopCamera(){}
function startBarcodeCamera(){document.getElementById('barcodeFileInput').click();}
function startPhotoMode(mode){document.getElementById(mode+'FileInput').click();}

// RECIPE
function addIngredient(){const list=document.getElementById('ingredientList'),div=document.createElement('div');div.className='ingredient-item';div.innerHTML=`<input class="ingr-name" type="text" placeholder="e.g. Chicken breast"><input class="ingr-qty" type="number" placeholder="200" min="1"><select class="ingr-unit"><option>g</option><option>ml</option><option>tsp</option><option>tbsp</option><option>cup</option><option>piece</option></select><button class="del-btn" onclick="this.parentNode.remove()">\u00d7</button>`;list.appendChild(div);}
async function calcRecipe(){
  const name=document.getElementById('recipeName').value.trim()||'My Recipe',servings=parseInt(document.getElementById('recipeServings').value)||1,mealType=document.getElementById('mealTypeRecipe').value;
  const items=[...document.querySelectorAll('#ingredientList .ingredient-item')];if(!items.length){alert('Add ingredients');return;}
  const ings=items.map(item=>`${item.querySelector('.ingr-qty').value}${item.querySelector('.ingr-unit').value} ${item.querySelector('.ingr-name').value}`).filter(s=>s.length>3);if(!ings.length){alert('Fill in ingredients');return;}
  document.getElementById('recipeThinking').classList.add('show');
  try{const raw=await callClaude(`Nutrition expert. Recipe: "${name}". Ingredients: ${ings.join(', ')}. Makes ${servings} serving(s). Respond ONLY valid JSON: {"per_serving_cals":number,"per_serving_protein_g":number}`);const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());await addFoodEntry({name:`${mealType}: ${name} (1/${servings})`,cals:parsed.per_serving_cals,protein:parsed.per_serving_protein_g,meal_type:mealType,source:'recipe'});}catch(e){alert('Could not calculate. Try again.');}
  document.getElementById('recipeThinking').classList.remove('show');
}

// EXERCISE
let exType='🚴 Cycling',effort='Easy';
function setExType(t,btn){exType=t;document.querySelectorAll('.ex-type-btn').forEach(el=>el.classList.remove('active'));btn.classList.add('active');}
function setEffort(e,btn){effort=e;document.querySelectorAll('.effort-btn').forEach(el=>el.classList.remove('active'));btn.classList.add('active');}
async function logExercise(){
  const duration=document.getElementById('exDuration').value,distance=document.getElementById('exDistance').value,hr=document.getElementById('exHR').value,notes=document.getElementById('exNotes').value,manualCals=document.getElementById('exManualCals').value;
  if(!duration){alert('Enter duration');return;}
  const desc=`${exType}, ${duration} mins${distance?' '+distance+'km':''}${hr?', avg HR '+hr+'bpm':''}, effort: ${effort}. Notes: ${notes||'none'}`;
  let cals=0,description=`${exType} \u00b7 ${duration} min${distance?' \u00b7 '+distance+'km':''}${hr?' \u00b7 '+hr+'bpm':''} \u00b7 ${effort}`;
  if(manualCals&&parseInt(manualCals)>0){
    cals=parseInt(manualCals);
  } else {
    document.getElementById('exThinking').classList.add('show');
    try{
      const raw=await callClaude(`Sports scientist. Estimate calorie burn for fit male endurance athlete: ${desc}. Respond ONLY valid JSON: {"cals_burned":number,"description":"short session summary"}`);
      const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
      if(parsed.cals_burned){cals=parsed.cals_burned;description=parsed.description;}
    }catch(e){/* AI failed - save anyway with 0 cals, user can edit */}
    document.getElementById('exThinking').classList.remove('show');
  }
  try{
    const entry={user_id:currentUser.id,date:todayKey(),type:exType,duration:parseInt(duration),distance:distance?parseFloat(distance):null,hr:hr?parseInt(hr):null,effort,notes,cals,description};
    setSyncStatus('syncing');
    const{data,error}=await sb.from('exercise_log').insert(entry).select().single();
    if(error)throw error;
    if(data)state.exerciseLog.push(data);
    setSyncStatus('ok');
    renderExerciseLog();updateOverview();updateStreaksAndAchievements();
    document.getElementById('exDuration').value='';document.getElementById('exDistance').value='';document.getElementById('exHR').value='';document.getElementById('exNotes').value='';document.getElementById('exManualCals').value='';
    if(cals===0)alert('Session saved! AI estimate unavailable \u2014 enter calories manually if needed.');
  }catch(e){setSyncStatus('error');alert('Could not save session.\
\
Error: '+(e.message||e.toString())+'\
\
Check your connection and try again.');console.error('Exercise log error:',e);}
}
function renderExerciseLog(){
  const list=document.getElementById('exerciseLogList'),empty=document.getElementById('exerciseLogEmpty'),burned=state.exerciseLog.reduce((a,e)=>a+(e.cals||0),0);
  const tbd=document.getElementById('totalBurnedDisplay');if(tbd)tbd.textContent=burned;
  if(!state.exerciseLog.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=[...state.exerciseLog].reverse().map(e=>`<div class="ex-log-list-item"><div class="elli-left"><div class="elli-type">${e.type}</div><div class="elli-name">${e.description}</div><div class="elli-meta">${e.duration}min${e.distance?' \u00b7 '+e.distance+'km':''}${e.hr?' \u00b7 '+e.hr+'bpm':''} \u00b7 ${e.effort}</div></div><div class="elli-right"><div class="elli-cals">${e.cals}</div><div class="elli-unit">kcal</div></div><button class="del-btn" onclick="deleteExercise('${e.id}')">\u00d7</button></div>`).join('');
}
async function deleteExercise(id){await sb.from('exercise_log').delete().eq('id',id);state.exerciseLog=state.exerciseLog.filter(e=>e.id!==id);renderExerciseLog();updateOverview();}

// WEIGHT
function updateToGo(){const cw=parseFloat(document.getElementById('currentWeightInput').value),tw=parseFloat(document.getElementById('targetWeightInput').value),section=document.getElementById('toGoSection');if(cw&&tw){section.style.display='block';document.getElementById('toGoNum').textContent=Math.abs(cw-tw).toFixed(1)+'kg';document.getElementById('toGoLabel').textContent=cw>tw?'to lose to reach target':'gained toward target';}else section.style.display='none';}
async function logWeight(){
  const w=parseFloat(document.getElementById('logWeightInput').value);
  if(!w||w<30||w>300){alert('Enter a valid weight (30\u2013300 kg)');return;}
  // Check for recent weigh-in (within 5 days \u2014 allow some flexibility around weekly)
  if(state.weightLog.length){
    const sorted=[...state.weightLog].sort((a,b)=>a.date<b.date?1:-1);
    const last=sorted[0];
    const daysSince=Math.floor((new Date(todayKey())-new Date(last.date))/(1000*60*60*24));
    if(daysSince<5){
      const ok=confirm(`You last weighed in ${daysSince===0?'today':daysSince+' day'+(daysSince>1?'s':'')+' ago'} (${last.weight}kg). Log again anyway?`);
      if(!ok)return;
    }
  }
  setSyncStatus('syncing');
  const entry={user_id:currentUser.id,date:todayKey(),weight:w};
  const{data,error}=await sb.from('weight_log').insert(entry).select().single();
  if(error){setSyncStatus('error');alert('Could not save. Try again.');return;}
  if(data)state.weightLog.push(data);
  setSyncStatus('ok');
  state.prefs.current_weight=w;
  document.getElementById('currentWeightInput').value=w;
  await savePrefs();
  renderWeightLog();updateOverview();updateStreaksAndAchievements();
  document.getElementById('logWeightInput').value='';
}
function renderWeightLog(){
  const list=document.getElementById('weightLogList');
  if(!state.weightLog.length){list.innerHTML='<div style="text-align:center;padding:14px;color:var(--muted);font-size:12px;font-style:italic;">No weigh-ins logged yet.</div>';document.getElementById('chartEmpty').style.display='block';document.getElementById('weightChart').style.display='none';return;}
  const sorted=[...state.weightLog].sort((a,b)=>a.date>b.date?1:-1);
  list.innerHTML=sorted.slice().reverse().map((e,i,arr)=>{
    const prev=arr[i+1];
    const delta=prev?(e.weight-prev.weight).toFixed(1):null;
    const days=prev?Math.floor((new Date(e.date)-new Date(prev.date))/(1000*60*60*24)):null;
    const dh=delta?`<span class="wl-delta ${delta>0?'up':'down'}">${delta>0?'+':''}${delta}kg</span>`:'';
    const dayLabel=days?`<span style="font-size:9px;color:var(--muted);margin-right:4px;">${days}d</span>`:'';
    return`<div class="wl-item"><span class="wl-date">${e.date}</span><div style="display:flex;align-items:center;gap:6px;">${dayLabel}${dh}<span class="wl-val">${e.weight}kg</span><button class="del-btn" onclick="deleteWeight('${e.id}')">\u00d7</button></div></div>`;
  }).join('');
  if(sorted.length>=2){drawWeightChart(sorted);document.getElementById('chartEmpty').style.display='none';document.getElementById('weightChart').style.display='block';}
}
async function deleteWeight(id){await sb.from('weight_log').delete().eq('id',id);state.weightLog=state.weightLog.filter(w=>w.id!==id);renderWeightLog();updateOverview();}
function drawWeightChart(data){
  const svg=document.getElementById('weightChart'),W=svg.clientWidth||320,H=150,pad={l:36,r:12,t:16,b:24};
  const ys=data.map(d=>d.weight),minY=Math.min(...ys)-.5,maxY=Math.max(...ys)+.5;
  const target=parseFloat(state.prefs.target_weight);
  const xS=i=>pad.l+(W-pad.l-pad.r)*i/(data.length-1),yS=y=>H-pad.b-(y-minY)/(maxY-minY)*(H-pad.t-pad.b);
  const pts=data.map((d,i)=>`${xS(i)},${yS(d.weight)}`).join(' ');
  const area=`M${xS(0)},${yS(data[0].weight)} ${data.map((d,i)=>`L${xS(i)},${yS(d.weight)}`).join(' ')} L${xS(data.length-1)},${H-pad.b} L${xS(0)},${H-pad.b} Z`;
  let tl='';if(target&&target>=minY&&target<=maxY){const ty=yS(target);tl=`<line x1="${pad.l}" y1="${ty}" x2="${W-pad.r}" y2="${ty}" stroke="var(--accent)" stroke-width="1.5" stroke-dasharray="4,3"/><text x="${pad.l+2}" y="${ty-4}" font-size="9" fill="var(--accent)" font-family="DM Sans">target</text>`;}
  svg.innerHTML=`<defs><linearGradient id="wg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--weight)" stop-opacity=".25"/><stop offset="100%" stop-color="var(--weight)" stop-opacity="0"/></linearGradient></defs><path d="${area}" fill="url(#wg)"/><polyline points="${pts}" fill="none" stroke="var(--weight)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>${data.map((d,i)=>`<circle cx="${xS(i)}" cy="${yS(d.weight)}" r="3" fill="var(--weight)"/>`).join('')}${data.map((d,i)=>i===0||i===data.length-1?`<text x="${xS(i)}" y="${H-4}" text-anchor="${i===0?'start':'end'}" font-size="9" fill="var(--muted)" font-family="DM Sans">${d.date.slice(5)}</text>`:'').join('')}${data.length>0?`<text x="${xS(data.length-1)-4}" y="${yS(data[data.length-1].weight)-8}" text-anchor="end" font-size="9" fill="var(--weight)" font-family="DM Sans">${data[data.length-1].weight}kg</text>`:''}${[minY+.3,Math.round((minY+maxY)/2),maxY-.3].map(y=>`<text x="${pad.l-4}" y="${yS(y)+4}" text-anchor="end" font-size="9" fill="var(--muted)" font-family="DM Sans">${y.toFixed(0)}</text>`).join('')}${tl}`;
}

// EXPORT
async function exportData(){
  document.getElementById('userDropdown').classList.remove('show');
  const{data:food}=await sb.from('food_log').select('*').eq('user_id',currentUser.id).order('date');
  const{data:weight}=await sb.from('weight_log').select('*').eq('user_id',currentUser.id).order('date');
  const{data:exercise}=await sb.from('exercise_log').select('*').eq('user_id',currentUser.id).order('date');
  let csv='LIFT App Data Export\
\
FOOD LOG\
Date,Name,Calories,Protein,Meal Type,Source\
';
  (food||[]).forEach(f=>{csv+=`${f.date},"${f.name}",${f.cals},${f.protein||0},${f.meal_type},${f.source}\
`;});
  csv+='\
WEIGHT LOG\
Date,Weight(kg)\
';(weight||[]).forEach(w=>{csv+=`${w.date},${w.weight}\
`;});
  csv+='\
EXERCISE LOG\
Date,Type,Duration(min),Distance(km),HR,Effort,Calories,Description\
';(exercise||[]).forEach(e=>{csv+=`${e.date},${e.type},${e.duration},${e.distance||''},${e.hr||''},${e.effort},${e.cals},"${e.description}"\
`;});
  const blob=new Blob([csv],{type:'text/csv'}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='lift-data.csv';a.click();
}

// STRAVA IMPORT \u2014 via Supabase Edge Functions (SECURE)
// Requires these Edge Functions to exist in Supabase:
// - strava-start       (JWT required) -> returns { url }
// - strava-status      (JWT required) -> returns { connected, athlete_name, athlete_id }
// - strava-activities  (JWT required) -> returns { activities: [...] }
// - strava-disconnect  (JWT required) -> disconnects + deletes token row

async function invokeFn(fnName, body = null) {
  if (!sb) throw new Error('Supabase not initialised');
  if (!currentUser) throw new Error('You must be signed in');

  const { data, error } = await sb.functions.invoke(fnName, body ? { body } : undefined);
  if (error) {
    // Supabase function errors can be terse; improve message
    throw new Error(error.message || `Function ${fnName} failed`);
  }
  return data;
}

async function connectStrava() {
  const btn = document.querySelector('#stravaNotConnected .btn-ex');
  if (btn) { btn.disabled = true; btn.textContent = 'Redirecting...'; }

  try {
    const data = await invokeFn('strava-start');
    if (!data?.url) throw new Error('No authorisation URL returned');

    // Redirect user to Strava OAuth consent screen
    window.location.href = data.url;
  } catch (e) {
    if (btn) { btn.disabled = false; btn.textContent = 'Connect Strava'; }
    alert('Could not start Strava connection.\
\
' + (e.message || e.toString()));
  }
}

function showStravaConnected(name) {
  document.getElementById('stravaNotConnected').style.display = 'none';
  document.getElementById('stravaConnected').style.display = 'block';
  document.getElementById('stravaAthleteInfo').textContent = name || 'Connected';
}

async function initStrava() {
  // Called after loadAllData() in your app
  try {
    if (!currentUser) return;

    const status = await invokeFn('strava-status');
    if (status?.connected) {
      const athleteName = status.athlete_name || 'Connected';
      localStorage.setItem('strava_athlete', athleteName);
      showStravaConnected(athleteName);
    } else {
      document.getElementById('stravaNotConnected').style.display = 'block';
      document.getElementById('stravaConnected').style.display = 'none';
      document.getElementById('stravaImportResults').innerHTML = '';
    }
  } catch (e) {
    // Don\u2019t block the UI if status fails
    document.getElementById('stravaNotConnected').style.display = 'block';
    document.getElementById('stravaConnected').style.display = 'none';
  }
}

async function disconnectStrava() {
  try {
    await invokeFn('strava-disconnect');
  } catch (e) {
    alert('Could not disconnect Strava.\
\
' + (e.message || e.toString()));
    return;
  }

  try {
    localStorage.removeItem('strava_athlete');
  } catch (e) {}

  document.getElementById('stravaNotConnected').style.display = 'block';
  document.getElementById('stravaConnected').style.display = 'none';
  document.getElementById('stravaImportResults').innerHTML = '';
}

async function importFromStrava() {
  const days = parseInt(document.getElementById('stravaImportDays').value) || 7;

  document.getElementById('stravaThinking').classList.add('show');
  document.getElementById('stravaImportResults').innerHTML = '';

  try {
    const payload = await invokeFn('strava-activities', { days });
    const activities = payload?.activities || [];

    if (!activities.length) {
      document.getElementById('stravaImportResults').innerHTML =
        '<div style="font-size:12px;color:var(--muted);text-align:center;padding:8px;">No activities found in this period.</div>';
      return;
    }

    // Cache activities for the "Add" buttons
    window._stravaCache = {};
    activities.forEach(a => window._stravaCache[a.id] = a);

    // Prevent duplicates: check which Strava IDs are already imported for this user
    const ids = activities.map(a => String(a.id));
    const { data: existing, error: exErr } = await sb
      .from('exercise_log')
      .select('strava_id')
      .eq('user_id', currentUser.id)
      .in('strava_id', ids);

    if (exErr) throw new Error('Could not check existing imports');

    const importedSet = new Set((existing || []).map(r => String(r.strava_id)));

    const html = activities.map(a => {
      const date = a.start_date_local ? a.start_date_local.slice(0, 10) : todayKey();
      const mins = Math.round((a.moving_time || 0) / 60);
      const km = a.distance ? (a.distance / 1000).toFixed(1) + 'km' : '';
      const alreadyLogged = importedSet.has(String(a.id));

      return `
        <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-top:1px solid var(--border);font-size:12px;">
          <div style="flex:1;min-width:0;">
            <div style="font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              🟠 ${a.type || 'Activity'} \u00b7 ${a.name || 'Untitled'}
            </div>
            <div style="color:var(--muted);font-size:11px;">
              ${date} \u00b7 ${mins}min${km ? ' \u00b7 ' + km : ''}
            </div>
          </div>
          ${alreadyLogged
            ? '<span style="font-size:11px;color:var(--muted);flex-shrink:0;">\u2713 logged</span>'
            : `<button class="btn btn-ex" style="font-size:11px;padding:5px 10px;flex-shrink:0;" onclick="logStravaActivity(window._stravaCache[${a.id}])">Add</button>`
          }
        </div>`;
    }).join('');

    document.getElementById('stravaImportResults').innerHTML = html;

  } catch (e) {
    alert('Could not fetch from Strava.\
\
' + (e.message || e.toString()));
  } finally {
    document.getElementById('stravaThinking').classList.remove('show');
  }
}

async function logStravaActivity(a) {
  if (!a) return;

  // Map Strava types to your existing internal types
  const typeMap = {
    Run: '🏃 Running',
    Ride: '🚴 Cycling',
    VirtualRide: '🚴 Cycling',
    Walk: '\u26a1 Other',
    Swim: '🏊 Swimming',
    WeightTraining: '🏋\ufe0f Weights',
    Workout: '🏋\ufe0f Weights',
    Yoga: '\u26a1 Other',
    Hike: '\u26a1 Other'
  };

  const liftType = typeMap[a.type] || '\u26a1 Other';
  const km = a.distance ? (a.distance / 1000) : null;
  const mins = Math.round((a.moving_time || 0) / 60);
  const cals = a.calories ? Math.round(a.calories) : 0;
  const date = a.start_date_local ? a.start_date_local.slice(0, 10) : todayKey();
  const hr = a.average_heartrate ? Math.round(a.average_heartrate) : null;

  const entry = {
    user_id: currentUser.id,
    date,
    type: liftType,
    duration: mins,
    distance: km,
    hr,
    effort: 'Moderate',
    cals,
    description: a.name || liftType,
    notes: 'Imported from Strava',
    strava_id: String(a.id)   // IMPORTANT: enables duplicate protection + unique index
  };

  try {
    setSyncStatus('syncing');

    // With your unique index (user_id, strava_id), duplicates will be prevented.
    const { data, error } = await sb.from('exercise_log').insert(entry).select().single();

    if (error) {
      // Friendly handling for duplicate imports (unique index violation)
      const msg = (error.message || '').toLowerCase();
      if (msg.includes('duplicate') || msg.includes('unique')) {
        alert('That activity is already logged.');
      } else {
        throw error;
      }
      setSyncStatus('ok');
      return;
    }

    // Update local state only if it\u2019s for today (your app only loads today into state.exerciseLog)
    if (data) {
      if (date === todayKey()) state.exerciseLog.push(data);
    }

    setSyncStatus('ok');
    renderExerciseLog();
    updateOverview();
    updateStreaksAndAchievements();

    // Refresh import list (will now show \u2713 logged)
    importFromStrava();

  } catch (e) {
    setSyncStatus('error');
    alert('Could not save Strava activity.\
\
' + (e.message || e.toString()));
  }
}
// PWA INSTALL
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;});
function showInstallPrompt(){
  const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
  if(!isStandalone&&!localStorage.getItem('lift_install_dismissed'))document.getElementById('installBanner').classList.add('show');
  document.getElementById('installBtn').onclick=async()=>{
    if(deferredPrompt){deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;deferredPrompt=null;}
    else alert('To add to your iPhone home screen:\
\
1. Open this page in Safari (not Chrome)\
2. Tap the Share button (\u2b06\ufe0f at bottom)\
3. Scroll down and tap "Add to Home Screen"\
4. Tap "Add"\
\
LIFT will appear on your home screen like a native app.');
    dismissInstall();
  };
}
function dismissInstall(){document.getElementById('installBanner').classList.remove('show');localStorage.setItem('lift_install_dismissed','1');}


// ====== DATE NAVIGATION ======
const dateNav={fuel:{window:'day',offset:0},progress:{window:'month',offset:0}};
function getNavRange(view){
  const{window:w,offset:o}=dateNav[view];const now=new Date();let start,end,label;
  if(w==='day'){const d=new Date(now);d.setDate(d.getDate()+o);const ds=d.toISOString().slice(0,10);start=ds;end=ds;label=o===0?'Today':o===-1?'Yesterday':d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});}
  else if(w==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay()+1+o*7);const mon=new Date(d);const sun=new Date(d);sun.setDate(sun.getDate()+6);start=mon.toISOString().slice(0,10);end=sun.toISOString().slice(0,10);label=o===0?'This Week':mon.toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' \u2013 '+sun.toLocaleDateString('en-GB',{day:'numeric',month:'short'});}
  else if(w==='month'){const d=new Date(now.getFullYear(),now.getMonth()+o,1);start=d.toISOString().slice(0,10);const last=new Date(d.getFullYear(),d.getMonth()+1,0);end=last.toISOString().slice(0,10);label=d.toLocaleDateString('en-GB',{month:'long',year:'numeric'});}
  else if(w==='3m'){const e=new Date(now);e.setMonth(e.getMonth()+o*3);const s=new Date(e);s.setMonth(s.getMonth()-3);start=s.toISOString().slice(0,10);end=e.toISOString().slice(0,10);label=s.toLocaleDateString('en-GB',{month:'short'})+' \u2013 '+e.toLocaleDateString('en-GB',{month:'short',year:'numeric'});}
  else if(w==='6m'){const e=new Date(now);e.setMonth(e.getMonth()+o*6);const s=new Date(e);s.setMonth(s.getMonth()-6);start=s.toISOString().slice(0,10);end=e.toISOString().slice(0,10);label=s.toLocaleDateString('en-GB',{month:'short',year:'2-digit'})+' \u2013 '+e.toLocaleDateString('en-GB',{month:'short',year:'numeric'});}
  else if(w==='1y'){const e=new Date(now);e.setFullYear(e.getFullYear()+o);const s=new Date(e);s.setFullYear(s.getFullYear()-1);start=s.toISOString().slice(0,10);end=e.toISOString().slice(0,10);label=s.toLocaleDateString('en-GB',{month:'short',year:'2-digit'})+' \u2013 '+e.toLocaleDateString('en-GB',{month:'short',year:'numeric'});}
  return{start,end,label};
}
function setDateWindow(view,w,el){dateNav[view].window=w;dateNav[view].offset=0;el.closest('.dn-windows').querySelectorAll('.dnw-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');refreshDateNav(view);}
function shiftDateNav(view,dir){dateNav[view].offset+=dir;refreshDateNav(view);}
function refreshDateNav(view){
  const{start,end,label}=getNavRange(view);const today=todayKey();
  const lbl=document.getElementById(view+'NavLabel');if(lbl)lbl.textContent=label;
  const nb=document.getElementById(view+'NavNext');if(nb)nb.disabled=(end>=today&&dateNav[view].offset>=0);
  if(view==='fuel')loadFoodLogForRange(start,end);
  else if(view==='progress')renderProgressForRange(start,end);
}
async function loadFoodLogForRange(start,end){
  if(!currentUser)return;
  if(start===end&&start===todayKey()){renderFoodLogForView(state.foodLog,start,end);updateDietSummaryForLogs(state.foodLog);return;}
  try{const{data}=await sb.from('food_log').select('*').eq('user_id',currentUser.id).gte('date',start).lte('date',end).order('date').order('created_at');renderFoodLogForView(data||[],start,end);updateDietSummaryForLogs(data||[]);}catch(e){}
}
function renderFoodLogForView(logs,start,end){
  const list=document.getElementById('mealLogList'),empty=document.getElementById('mealLogEmpty');if(!list)return;
  if(!logs.length){list.innerHTML='';if(empty)empty.style.display='block';return;}
  if(empty)empty.style.display='none';
  const today=todayKey();
  if(start===end){
    list.innerHTML=[...logs].reverse().map(f=>'<div class="meal-log-item"><div class="mli-left"><div class="mli-name">'+f.name+'</div><div class="mli-meta">'+(f.source==='barcode'?'\uD83D\uDCE6':f.source==='recipe'?'\uD83C\uDF73':'\uD83E\uDD16')+(f.protein?' \xb7 '+f.protein+'g protein':'')+'</div></div><div class="mli-right"><div class="mli-cals">'+f.cals+'</div><div class="mli-unit">kcal</div></div>'+(f.date===today?'<button class="del-btn" onclick="deleteFoodEntry(\''+f.id+'\')">×</button>':'')+'</div>').join('');
  }else{
    const byDate={};logs.forEach(f=>{if(!byDate[f.date])byDate[f.date]=[];byDate[f.date].push(f);});
    const sortedDates=Object.keys(byDate).sort().reverse();
    list.innerHTML=sortedDates.map(date=>{
      const dl=byDate[date],dayCals=dl.reduce((a,f)=>a+(f.cals||0),0);
      return'<div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;align-items:center;padding:6px 2px;border-bottom:1px solid var(--border);margin-bottom:5px;"><span style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">'+new Date(date+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})+'</span><span style="font-family:\'Bebas Neue\',sans-serif;font-size:16px;color:var(--diet);">'+dayCals+' kcal</span></div>'+dl.map(f=>'<div class="meal-log-item"><div class="mli-left"><div class="mli-name">'+f.name+'</div><div class="mli-meta">'+(f.source==='barcode'?'\uD83D\uDCE6':f.source==='recipe'?'\uD83C\uDF73':'\uD83E\uDD16')+(f.protein?' \xb7 '+f.protein+'g protein':'')+'</div></div><div class="mli-right"><div class="mli-cals">'+f.cals+'</div><div class="mli-unit">kcal</div></div></div>').join('')+'</div>';
    }).join('');
  }
}
function updateDietSummaryForLogs(logs){
  const cals=logs.reduce((a,f)=>a+(f.cals||0),0),prot=logs.reduce((a,f)=>a+(f.protein||0),0);
  const dc=document.getElementById('dietTotalCals'),dp=document.getElementById('dietTotalPro');
  if(dc)dc.textContent=cals;if(dp)dp.textContent=Math.round(prot)+'g';
}
async function renderProgressForRange(start,end){
  if(!currentUser)return;
  try{
    const{data:exLogs}=await sb.from('exercise_log').select('*').eq('user_id',currentUser.id).gte('date',start).lte('date',end);
    const logs=exLogs||[];
    renderWeekVolumeFromLogs(logs,'progressVolume');
    renderActivityLogFromLogs(logs,_currentLogFilter);
    const dayCount=Math.ceil((new Date(end)-new Date(start))/86400000)+1;
    buildLoadChartForRange(dayCount,end);
  }catch(e){}
}
function renderWeekVolumeFromLogs(logs,containerId){
  const el=document.getElementById(containerId);if(!el)return;
  const sports=[{label:'Ride',icon:'\uD83D\uDEB4',unit:'km',color:'var(--exlog)',key:'Cycl',metric:e=>e.distance||0},{label:'Run',icon:'\uD83C\uDFC3',unit:'km',color:'var(--pull)',key:'Runn',metric:e=>e.distance||0},{label:'Swim',icon:'\uD83C\uDFCA',unit:'km',color:'var(--blue)',key:'Swim',metric:e=>e.distance||0},{label:'Gym',icon:'\uD83C\uDFCB\uFE0F',unit:'min',color:'var(--push)',key:'Weight',metric:e=>e.duration||0}];
  el.innerHTML=sports.map(s=>{const entries=logs.filter(e=>e.type&&e.type.includes(s.key));const total=entries.reduce((a,e)=>a+s.metric(e),0);return'<div class="vol-box" onclick="showView(\'train\')"><div class="vb-icon">'+s.icon+'</div><div class="vb-val" style="color:'+s.color+'">'+(total>0?total.toFixed(total<10?1:0):0)+'</div><div class="vb-lbl">'+s.unit+' '+s.label+'</div></div>';}).join('');
}
function renderActivityLogFromLogs(logs,filter){
  const el=document.getElementById('fullActivityLog'),empty=document.getElementById('fullActivityLogEmpty');if(!el)return;
  const keyMap={'\uD83D\uDEB4 Cycling':'Cycl','\uD83C\uDFC3 Running':'Runn','\uD83C\uDFCA Swimming':'Swim','\uD83C\uDFCB\uFE0F Weights':'Weight'};
  let filtered=[...logs];
  if(filter&&filter!=='all'){const key=keyMap[filter]||filter;filtered=filtered.filter(e=>e.type&&e.type.includes(key));}
  filtered.reverse();
  if(!filtered.length){el.innerHTML='';if(empty)empty.style.display='block';return;}
  if(empty)empty.style.display='none';
  el.innerHTML=filtered.map(e=>'<div class="activity-item"><div class="ai-sport">'+(e.type||'\u26a1').split(' ')[0]+'</div><div class="ai-body"><div class="ai-name">'+(e.description||e.type||'Session')+'</div><div class="ai-meta">'+(e.date||'')+' \xb7 '+(e.duration||'\u2014')+'min'+(e.distance?' \xb7 '+e.distance+'km':'')+' \xb7 '+(e.effort||'\u2014')+(e.hr?' \xb7 '+e.hr+'bpm':'')+'</div></div><div class="ai-right"><div class="ai-cals">'+(e.cals||0)+'</div><div class="ai-kcal">kcal</div></div></div>').join('');
}

// ====== TRAINING LOAD HISTORY ======
async function loadAllExerciseHistory(){
  if(!currentUser)return;
  try{
    const d=new Date();d.setFullYear(d.getFullYear()-1);
    const{data}=await sb.from('exercise_log').select('*').eq('user_id',currentUser.id).gte('date',d.toISOString().slice(0,10)).order('date');
    state.allExerciseLog=data||[];
  }catch(e){state.allExerciseLog=[];}
}
function buildTSSMap(){
  const all=[...(state.allExerciseLog||[])];
  state.exerciseLog.forEach(e=>{if(!all.find(x=>x.id===e.id))all.push(e);});
  const map={};all.forEach(e=>{if(e.date)map[e.date]=(map[e.date]||0)+calcTSS(e);});return map;
}
function buildLoadChartForRange(dayCount,endDate){
  const tssMap=buildTSSMap();
  const end=endDate?new Date(endDate+'T12:00:00'):new Date();
  const preload=42;const allDays=[];
  for(let i=dayCount+preload-1;i>=0;i--){const d=new Date(end);d.setDate(d.getDate()-i);allDays.push(d.toISOString().slice(0,10));}
  let ctl=0,atl=0;const ctlPts=[],atlPts=[];
  allDays.forEach((day,idx)=>{const tss=tssMap[day]||0;ctl=ctl+(tss-ctl)*(1/42);atl=atl+(tss-atl)*(1/7);if(idx>=preload){ctlPts.push(Math.round(ctl));atlPts.push(Math.round(atl));}});
  const tsb=Math.round(ctl-atl);
  const pc=document.getElementById('progCTL'),pa=document.getElementById('progATL'),pt=document.getElementById('progTSB');
  if(pc)pc.textContent=Math.round(ctl);if(pa)pa.textContent=Math.round(atl);if(pt)pt.textContent=tsb;
  drawLoadChart('progressLoadChart',ctlPts,atlPts);
}

// ====== WATER TOAST ======
function showWaterToast(msg){
  const t=document.getElementById('waterToast');if(!t)return;
  t.textContent=msg;t.classList.remove('show');void t.offsetWidth;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2100);
}

// ====== FAVOURITES ======
function getFavourites(){try{return JSON.parse(localStorage.getItem('lift_food_favs')||'[]');}catch(e){return[];}}
function saveFavourites(f){localStorage.setItem('lift_food_favs',JSON.stringify(f.slice(0,20)));}
function renderFavourites(){
  const grid=document.getElementById('favGrid');if(!grid)return;
  const favs=getFavourites();
  if(!favs.length){grid.innerHTML='<span class="fav-empty">Save meals as favourites for quick logging.</span>';return;}
  grid.innerHTML=favs.map((f,i)=>'<div class="fav-chip" onclick="quickAddFavourite('+i+')"><span>'+(f.name.length>22?f.name.slice(0,22)+'\u2026':f.name)+'</span><span class="fc-cals">'+f.cals+'</span><button class="fc-del" onclick="event.stopPropagation();removeFavourite('+i+')" title="Remove">\xd7</button></div>').join('');
}
async function quickAddFavourite(idx){
  const f=getFavourites()[idx];if(!f)return;
  const mt=document.getElementById('mealTypeLog').value||'Snack';
  try{await addFoodEntry({name:mt+': '+f.name,cals:f.cals,protein:f.protein||0,meal_type:mt,source:'ai'});showWaterToast('\u2605 '+f.name+' added!');}
  catch(e){alert('Could not add: '+e.message);}
}
function removeFavourite(idx){const f=getFavourites();f.splice(idx,1);saveFavourites(f);renderFavourites();}
function saveFoodAsFavourite(){
  if(!selectedFoodOption)return;
  const qty=parseFloat(document.getElementById('foodQtyInput').value)||1;
  const name=selectedFoodOption.name+(qty!==1?' (x'+qty+')':'');
  const cals=Math.round(selectedFoodOption.cals*qty);
  const protein=Math.round(selectedFoodOption.protein_g*qty);
  const favs=getFavourites();
  if(favs.find(f=>f.name===name)){showWaterToast('Already in favourites');return;}
  favs.unshift({name,cals,protein,unit:selectedFoodOption.unit,addedAt:new Date().toISOString()});
  saveFavourites(favs);renderFavourites();
  const btn=document.getElementById('saveFavBtn');
  if(btn){btn.textContent='\u2605 Saved!';btn.classList.add('saved');setTimeout(()=>{btn.textContent='\u2605 Fav';btn.classList.remove('saved');},2000);}
  showWaterToast('\u2605 Added to favourites!');
}


// KEYBOARD
document.getElementById('loginPassword').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('loginEmail').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPassword').focus();});

// INIT
(async()=>{
  addIngredient();
  const dbg=t=>{const el=document.getElementById('splashDebug');if(el)el.innerHTML+=t+'<br>';console.log(t);};
  dbg('App started');
  if(!sb){
    dbg('ERROR: Supabase failed to init');
    document.getElementById('splashCover').style.display='none';
    alert('Could not connect. Check internet and reload.');
    return;
  }
  dbg('Supabase ready \u2014 checking session...');
  try{
    const sessionPromise=sb.auth.getSession();
    const timeoutPromise=new Promise((_,rej)=>setTimeout(()=>rej(new Error('session timeout')),6000));
    const result=await Promise.race([sessionPromise,timeoutPromise]);
    const session=result?.data?.session;
    dbg(session?'Session found: '+session.user.email:'No session \u2014 showing login');
    if(session?.user){
      onSignedIn(session.user);
    } else {
      document.getElementById('splashCover').style.display='none';
    }
  }catch(e){
    dbg('Session error: '+e.message);
    console.error('Session check failed:',e);
    document.getElementById('splashCover').style.display='none';
  }
})();
if(sb)sb.auth.onAuthStateChange((event)=>{if(event==='SIGNED_OUT'){currentUser=null;}});
</script>
</body>
</html>
